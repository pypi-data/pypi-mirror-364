merge into {{ sink_table_identifier_artifact }} t using (
        SELECT
            {{ source_lu_used_columns_artifact }}
        FROM {{ source_table_identifier_artifact }} s
        {% if lu_sink_source_join_artifact -%}
        {{ lu_sink_source_join_artifact }}
        {% endif -%}
    ) s on t.BK = {{ bk_artifact }}
    {% if sink_source_update_artifact|length > 1 and lu_sink_source_update_artifact|length > 1 %}
    when matched then update set
        {{ sink_source_update_artifact }}
        {% if lu_sink_source_update_artifact -%}
        ,{{ lu_sink_source_update_artifact }}
        {% endif -%}
		,_DMR = CURRENT_TIMESTAMP()
    {% endif -%}
    when not matched {% if include_dq2 %} AND s._isConvertError = 0 {% elif include_dq1 %} AND s._VALID_FG = 1 {% endif -%}
    then insert
        (
            BK
            ,{{ sink_insert_artifact }}
            {% if lu_sink_insert_artifact -%}
            ,{{ lu_sink_insert_artifact }}
            {% endif -%}
            ,_DCR
            ,_DMR
        )
        values
        (
            {{ bk_artifact }}
            ,{{ source_insert_artifact }}
            {% if lu_source_insert_artifact -%}
            ,{{ lu_source_insert_artifact }}
            {% endif -%}
            ,CURRENT_TIMESTAMP()
            ,CURRENT_TIMESTAMP()
        );

{% for version_table in versioning_artifacts -%}
INSERT INTO {{ version_table.ver_sink_table_identifier_artifact }}
	(
		{{ version_table.ver_sink_insert_artifact }},
		Parent_BK,
		Parent_ID,
		_ValidFrom,
		_ValidTo,
		_IsActive
	)
SELECT
	{{ version_table.ver_source_insert_artifact }}
	,t.BK
	,t.ID
	,t.MutationDate
	,'9999-12-31'
	,1
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }}
	LEFT JOIN {{ version_table.ver_sink_table_identifier_artifact }} ver ON ver.Parent_ID = t.ID AND ver.IsActive = 1 {{ version_table.ver_lu_sink_source_join_artifact if version_table.ver_lu_sink_source_join_artifact else '' }}
WHERE (({{ version_table.ver_sink_source_field_comparison_artifact }}) OR ver.Parent_ID IS NULL) {% if include_dq2 %} AND s._isConvertError = 0 {% elif include_dq1 %} AND s._VALID_FG = 1 {% endif -%};

UPDATE ver
	SET ver._ValidTo = DATEADD(SECOND,-1, t.MutationDate), ver._IsActive = 0
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }}
	INNER JOIN {{ version_table.ver_sink_table_identifier_artifact }} ver ON ver.Parent_ID = t.ID
WHERE ({{ version_table.ver_sink_source_field_comparison_artifact }}) AND ver._IsActive = 1{% if include_dq2 %} AND s._isConvertError = 0 {% elif include_dq1 %} AND s._VALID_FG = 1 {% endif -%};
{% endfor %}
