UPDATE t
	SET {{ sink_source_update_artifact }}
	{{ ',' ~ lu_sink_source_update_artifact if lu_sink_source_update_artifact else '' }}
	,_Load_Datetime = SYSDATETIMEOFFSET()
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }} {{ lu_sink_source_join_artifact if lu_sink_source_join_artifact else '' }} AND s._Load_Datetime > t._Load_Datetime
{% if include_dq2 %}WHERE s._isConvertError = 0{% elif include_dq1 %}WHERE s._VALID_FG = 1{% else %} {% endif %};
INSERT INTO {{ sink_table_identifier_artifact }}
	(BK, {{ sink_insert_artifact }}{{',' ~ lu_sink_insert_artifact if lu_sink_insert_artifact else '' }},
	_DCR, _Load_Datetime, _IsDeleted, _Deleted_Date)
SELECT
	{{ bk_artifact }},{{ source_insert_artifact }}{{',' ~ lu_source_insert_artifact if lu_source_insert_artifact else '' }},
	SYSDATETIMEOFFSET(), SYSDATETIMEOFFSET(), 0, NULL
FROM {{ source_table_identifier_artifact }} s
	LEFT JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }} {{ lu_sink_source_join_artifact if lu_sink_source_join_artifact else '' }}
{% if include_dq2 %}WHERE t.BK IS NULL AND s._isConvertError = 0{% elif include_dq1 %}WHERE t.BK IS NULL AND s._VALID_FG = 1{% else %} {% endif %};
