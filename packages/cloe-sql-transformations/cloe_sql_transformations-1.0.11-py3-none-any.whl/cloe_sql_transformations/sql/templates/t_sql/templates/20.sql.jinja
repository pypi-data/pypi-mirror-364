UPDATE t
	SET {{ sink_source_update_artifact }}
	{{ ',' ~ lu_sink_source_update_artifact if lu_sink_source_update_artifact else '' }}
	,_Load_Datetime = SYSDATETIMEOFFSET()
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }} {{ lu_sink_source_join_artifact if lu_sink_source_join_artifact else '' }} AND ({{ sink_source_field_comparison_artifact }})
{% if include_dq2 %}WHERE s._isConvertError = 0{% elif include_dq1 %}WHERE s._VALID_FG = 1{% else %} {% endif %};
INSERT INTO {{ sink_table_identifier_artifact }}
	(BK, {{ sink_insert_artifact }}{{',' ~ lu_sink_insert_artifact if lu_sink_insert_artifact else '' }},
	_DCR, _Load_Datetime, _IsDeleted, _Deleted_Date)
SELECT
	{{ bk_artifact }},{{ source_insert_artifact }}{{',' ~ lu_source_insert_artifact if lu_source_insert_artifact else '' }},
	SYSDATETIMEOFFSET(), SYSDATETIMEOFFSET(), 0, NULL
FROM {{ source_table_identifier_artifact }} s
	LEFT JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }} {{ lu_sink_source_join_artifact if lu_sink_source_join_artifact else '' }}
{% if include_dq2 %}WHERE t.BK IS NULL AND s._isConvertError = 0{% elif include_dq1 %}WHERE t.BK IS NULL AND s._VALID_FG = 1{% else %} {% endif %};
{% for version_table in versioning_artifacts -%}
INSERT INTO {{ version_table.ver_sink_table_identifier_artifact }}
	(
		{{ version_table.ver_sink_insert_artifact }},
		Parent_BK,
		Parent_ID,
		_ValidFrom,
		_ValidTo,
		_IsActive
	)
SELECT
	{{ version_table.ver_source_insert_artifact }},
	t.BK,
	t.ID,
	t.[MutationDate],
	'9999-12-31',
	1
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }}
	LEFT JOIN {{ version_table.ver_sink_table_identifier_artifact }} ver ON ver.Parent_ID = t.ID AND ver.IsActive = 1 {{ version_table.ver_lu_sink_source_join_artifact if version_table.ver_lu_sink_source_join_artifact else '' }}
WHERE (({{ version_table.ver_sink_source_field_comparison_artifact }}) OR ver.Parent_ID IS NULL) {% if include_dq2 %}WHERE s._isConvertError = 0{% elif include_dq1 %}WHERE s._VALID_FG = 1{% else %} {% endif %};
UPDATE ver
	SET ver._ValidTo = DATEADD(SECOND,-1,t.[MutationDate]), ver._IsActive = 0
FROM {{ source_table_identifier_artifact }} s
	INNER JOIN {{ sink_table_identifier_artifact }} t ON t.BK = {{ bk_artifact }}
	INNER JOIN {{ version_table.ver_sink_table_identifier_artifact }} ver ON ver.Parent_ID = t.ID
WHERE ({{ version_table.ver_sink_source_field_comparison_artifact }}) AND ver._IsActive = 1{% if include_dq2 %}WHERE s._isConvertError = 0{% elif include_dq1 %}WHERE s._VALID_FG = 1{% else %} {% endif %};
{% endfor %}
