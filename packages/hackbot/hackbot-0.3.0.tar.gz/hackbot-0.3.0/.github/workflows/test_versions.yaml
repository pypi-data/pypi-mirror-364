name: Run PyVersions

on:
  push:
    branches:
      - "**"
    paths-ignore:
      - ".github/workflows/**"
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      log_level:
        description: "Log level"
        required: false
        default: "warning"
      environment:
        description: "Environment to run tests in"
        required: false
        default: "staging"

jobs:
  pyversions:
    if: github.event_name == 'pull_request' || github.event.pull_request == null
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9.12", "3.9.21", "3.10.4", "3.10.16", "3.11.1", "3.11.11", "3.12.0" , "3.12.8"]
      fail-fast: false
    
    steps:
      - name: Log workflow dispatch inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Log Level: ${{ github.event.inputs.log_level }}"
          echo "Environment: ${{ github.event.inputs.environment }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install hackbot
        run: |
          python -m pip install --upgrade pip
          pip install pipx
          pipx install hackbot
          pipx ensurepath

      - name: Check hackbot version
        run: |
          echo "Checking hackbot version"
          echo $(pipx list --short)
          installed_version=$(pipx list --short | grep hackbot | cut -d ' ' -f 2)
          pyproject_toml_version=$(grep -oP 'version = "\K[^"]+' pyproject.toml)
          if [ "$installed_version" != "$pyproject_toml_version" ]; then
            echo "Expected hackbot version $pyproject_toml_version but got $installed_version"
            exit 1
          fi
          
      - name: Install Rye
        uses: eifinger/setup-rye@v4
        with:
          version: 'latest'

      - name: Test hackbot
        run: |
          echo "${{ matrix.python-version }}" > .python-version
          rye sync
          make test

