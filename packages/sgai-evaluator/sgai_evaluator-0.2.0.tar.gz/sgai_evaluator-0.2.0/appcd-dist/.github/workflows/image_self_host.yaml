# create a worfklow that pulls the image and tag that is input from dockerhub to ghcr.io
# the job should be run manually dispatch, asking for image name and tag
# the job should be run on ubuntu-latest
name: pull-image
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Image name'
        required: true
      tag:
        description: 'Image tag'
        required: true
env:
  REGISTRY: ghcr.io
jobs:
  pull-image:
    runs-on: ${{ matrix.runner }}
    permissions:
      packages: write
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            tag-suffix: amd
          - runner: arm-runner
            platform: linux/arm64/v8
            tag-suffix: arm
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: ${{ matrix.platform }}
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Pull image
      run: |
        docker pull --platform ${{matrix.platform}} ${{ inputs.image }}:${{ inputs.tag }}
        docker tag ${{ inputs.image }}:${{ inputs.tag }} ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image }}:${{ inputs.tag }}-${{matrix.tag-suffix}}
        docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image }}:${{ inputs.tag }}-${{matrix.tag-suffix}}
  retag:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    needs: 
      - pull-image
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Create manifest
      run: |
        docker images
        docker buildx imagetools create \
          -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image }}:${{ inputs.tag }} \
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image }}:${{ inputs.tag }}-amd \
          ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ inputs.image }}:${{ inputs.tag }}-arm
