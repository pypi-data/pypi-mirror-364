name: Build Docker Image
description: "Build final appcd-dist/appcd Image"
inputs:
  push_to_registry:
    description: "Should push to registry"
    required: true
  tags:
    description: "Tags for the image"
    required: true
  labels:
    description: "Labels for the image"
    required: true
  appcd_version:
    description: "Appcd version"
    required: true
    default: main
  analyzer_version:
    description: "Analyzer version"
    required: true
    default: main
  registry_secret:
    description: "Registry secret"
    required: true
  platforms:
    description: "Platforms"
    required: true
    default: linux/amd64,linux/arm64
outputs:
  imageid:
    description: "Image ID"
    value: ${{ steps.docker_build.imageid }}
  digest:
    description: "Image Digest"
    value: ${{ steps.docker_build.digest }}
runs:
  using: composite
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ inputs.registry_secret }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: ${{ inputs.platforms }}
    - name: Docker Build and push
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ inputs.push_to_registry }}
        tags: ${{ inputs.tags }}
        labels: ${{ inputs.labels }}
        platforms: ${{ inputs.platforms }}
        build-args: |-
          APPCD_VERSION=${{ inputs.appcd_version }}
          APPCD_ANALYZER=${{ inputs.analyzer_version }}
