{{- if .Values.security.networkPolicies.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "langfuse.fullname" . }}-default
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      {{- include "langfuse.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Values.global.namespace }}
    ports:
    - port: 3000 # Langfuse API
      protocol: TCP
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Values.global.namespace }}
    ports:
    - port: 8123
      protocol: TCP  # ClickHouse HTTP
    - port: 9000
      protocol: TCP  # ClickHouse Native
    - port: 6379
      protocol: TCP  # Redis
    - port: 9000
      protocol: TCP  # MinIO API
    - port: 9001
      protocol: TCP  # MinIO Console
    - port: 2181
      protocol: TCP  # ZooKeeper

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "langfuse.fullname" . }}-clickhouse
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: clickhouse
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          {{- include "langfuse.selectorLabels" . | nindent 10 }}
    ports:
    - port: 8123
      protocol: TCP
    - port: 9000
      protocol: TCP
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: zookeeper
    ports:
    - port: 2181
      protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "langfuse.fullname" . }}-redis
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          {{- include "langfuse.selectorLabels" . | nindent 10 }}
    ports:
    - port: 6379
      protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "langfuse.fullname" . }}-minio
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: minio
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          {{- include "langfuse.selectorLabels" . | nindent 10 }}
    ports:
    - port: 9000
      protocol: TCP
    - port: 9001
      protocol: TCP
{{- end }} 