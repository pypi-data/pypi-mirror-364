server {
    listen 8001;
    port_in_redirect off;
    server_name  localhost;

    access_log /dev/stdout  main;
    # access_log  /dev/null;
    # error_log /dev/null;

    location = /favicon.ico {
        return 301 https://appcd.com/favicon.ico;
    }

    location = /auth {
	  internal;
	  proxy_pass http://appcd:8080/api/v1/auth/me;
	  proxy_method HEAD;
	  proxy_pass_request_body off;
	  proxy_set_header X-Original-URI $request_uri;
	  proxy_set_header X-Original-Method $request_method;
	  proxy_buffer_size 16k;
	  proxy_buffers 8 16k;
	  proxy_busy_buffers_size 32k;
	}

    location = /path.json {
        return 200 '{"appcd": {"path": "/appcd"}, "iac-gen": {"path": "/iac-gen"}, "exporter": {"path": "/exporter"} }';
    }

    # TODO(sabith) get the version from the appcd github action later
    location = /version.json {
        return 200 '{"appcd": "compose", "iac-gen": "compose", "ui": "compose" }';
    }

    location = /features.json {
        return 200 '{"llm": false, "exporter": true }';
    }

    location = /mode.json {
        return 200 '{"mode":"ci", "main": "/"}';
    }

    # proxy any requests coming to /appcd to appcd
    location /appcd/ {
        auth_request /auth;
        auth_request_set $login $upstream_http_x_appcd_login;
        proxy_set_header X-Appcd-Login $login;

        auth_request_set $appcd_session $upstream_http_x_appcd_session;
        proxy_set_header X-Appcd-Session $appcd_session;

        auth_request_set $session_type $upstream_http_x_appcd_session_type;
        proxy_set_header X-Appcd-Session-Type $session_type;

        auth_request_set $appcd_org $upstream_http_x_appcd_org;
        proxy_set_header X-Appcd-Org $appcd_org;

        auth_request_set $appcd_scopes $upstream_http_x_appcd_scopes;
        proxy_set_header X-Appcd-Scopes $appcd_scopes;

        auth_request_set $stackgen_tenant $upstream_http_x_stackgen_tenant;
        proxy_set_header X-Stackgen-Tenant $stackgen_tenant;

        rewrite /appcd/(.*) /$1  break;
        proxy_pass http://appcd:8080;
    }

    location /exporter/ {
        auth_request /auth;
        auth_request_set $login $upstream_http_x_appcd_login;
        proxy_set_header X-Appcd-Login $login;

        auth_request_set $appcd_org $upstream_http_x_appcd_org;
        proxy_set_header X-Appcd-Org $appcd_org;

        auth_request_set $appcd_scopes $upstream_http_x_appcd_scopes;
        proxy_set_header X-Appcd-Scopes $appcd_scopes;

        auth_request_set $stackgen_tenant $upstream_http_x_stackgen_tenant;
        proxy_set_header X-Stackgen-Tenant $stackgen_tenant;

		rewrite /exporter/(.*) /$1  break;
        proxy_pass http://exporter:8080;
    }

    location /iac-gen/ {
        auth_request /auth;
        auth_request_set $login $upstream_http_x_appcd_login;
        proxy_set_header X-Appcd-Login $login;

        auth_request_set $principal_name $upstream_http_x_stackgen_principal;
        proxy_set_header X-Stackgen-Principal $principal_name;

        auth_request_set $appcd_org $upstream_http_x_appcd_org;
        proxy_set_header X-Appcd-Org $appcd_org;

        auth_request_set $appcd_scopes $upstream_http_x_appcd_scopes;
        proxy_set_header X-Appcd-Scopes $appcd_scopes;

        auth_request_set $stackgen_tenant $upstream_http_x_stackgen_tenant;
        proxy_set_header X-Stackgen-Tenant $stackgen_tenant;

		rewrite /iac-gen/(.*) /$1  break;
        proxy_pass http://iac-gen:9000;
    }

    # location /env-manager/ {
    #     rewrite /env-manager/(.*) /$1  break;
    #     proxy_pass http://env-manager:9000;
    # }

    location  / {
        proxy_pass http://appcd-ui:8000;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
