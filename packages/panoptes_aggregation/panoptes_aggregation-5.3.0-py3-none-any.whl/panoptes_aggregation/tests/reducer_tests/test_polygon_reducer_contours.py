from panoptes_aggregation.reducers.polygon_reducer import process_data
from panoptes_aggregation.reducers.polygon_reducer_contours import\
    polygon_reducer_contours
from .base_test_class import ReducerTest
import numpy as np
import shapely

'''This tests the reducer by providing 3 clusters of 3 regular polygons of different
rotations, sizes and number of sides. There are three outliers. The first is
simple. The second has a single self-intersection. The third has two
self-intersections. The latter two need to be processed, the first by removing
the small extract `triangle` and the second by splitting the shape in 2.

Finally, there is repeat data but labelled as for a second tool, to test if
the reducer can reduce mutiple tools for a single task.
'''

extracted_data = [
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    -0.011871167727739784,
                    -0.28870602933343953,
                    -0.38037475471301413,
                    -0.2331790477845634,
                    0.06665584265632145,
                    0.3434907042620213,
                    0.4351594296415958,
                    0.2879637227131452,
                    -0.0118711677277397
                ], [
                    4.630602319839481,
                    5.081828653996981,
                    5.449443973123015,
                    5.225416400970543,
                    4.719344427837162,
                    4.630602319839481
                ], [
                    -1.726260190173002,
                    -2.14338918482516,
                    -2.3456481393346444,
                    -2.1307780991919705,
                    -1.7136491045398121,
                    -1.5113901500303277,
                    -1.726260190173002
                ]
            ],
            'T0_tool0_pathY': [
                [
                    0.361724434930079,
                    0.21452872800162825,
                    -0.08530616243925668,
                    -0.3621410240449564,
                    -0.453809749424531,
                    -0.30661404249608026,
                    -0.006779152055195435,
                    0.2700557095505044,
                    0.36172443493007894
                ], [
                    3.855330076852154,
                    3.615408779166577,
                    3.9704107662937083,
                    4.429735358097605,
                    4.358611580573953,
                    3.8553300768521543
                ], [
                    2.2716019279274726,
                    2.2643209142423775,
                    1.8994361013759973,
                    1.5418323021947127,
                    1.5491133158798083,
                    1.9139981287461882,
                    2.2716019279274726
                ]
            ],
            'T0_tool1_pathX': [
                [
                    -0.011871167727739784,
                    -0.28870602933343953,
                    -0.38037475471301413,
                    -0.2331790477845634,
                    0.06665584265632145,
                    0.3434907042620213,
                    0.4351594296415958,
                    0.2879637227131452,
                    -0.0118711677277397
                ]
            ],
            'T0_tool1_pathY': [
                [
                    0.361724434930079,
                    0.21452872800162825,
                    -0.08530616243925668,
                    -0.3621410240449564,
                    -0.453809749424531,
                    -0.30661404249608026,
                    -0.006779152055195435,
                    0.2700557095505044,
                    0.36172443493007894
                ]
            ],
            'gold_standard': False
        }
    },
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    -0.49223768418803526,
                    -0.3894572368218461,
                    -0.06253880643091841,
                    0.24234136097970757,
                    0.2956022809277974,
                    0.05713739436766835,
                    -0.2934843753237021,
                    -0.49223768418803493
                ], [
                    4.665646912973787,
                    4.9452546176219245,
                    5.272656813475263,
                    5.401312969268549,
                    5.234342375582135,
                    4.897477295041295,
                    4.644384004088639,
                    4.665646912973787
                ], [
                    -2.0530832043103215,
                    -2.347496085003458,
                    -2.2484817914071478,
                    -1.855054617117701,
                    -1.5606417364245644,
                    -1.6596560300208743,
                    -2.053083204310321
                ]
            ],
            'T0_tool0_pathY': [
                [
                    -0.03531752424854295,
                    -0.3714972196452143,
                    -0.5007448417839794,
                    -0.32573429502333007,
                    0.021747909361406553,
                    0.2800405841233082,
                    0.2546440769562919,
                    -0.03531752424854333
                ], [
                    3.894600505351456,
                    3.6988170828153155,
                    3.795354221725569,
                    4.111517487484036,
                    4.409229492419295,
                    4.4643070245969305,
                    4.235275578910275,
                    3.8946005053514554
                ], [
                    2.3322557650241134,
                    2.047944550980137,
                    1.6508199100765353,
                    1.53800648321691,
                    1.8223176972608863,
                    2.219442338164488,
                    2.3322557650241134
                ]
            ],
            'T0_tool1_pathX': [
                [
                    -0.49223768418803526,
                    -0.3894572368218461,
                    -0.06253880643091841,
                    0.24234136097970757,
                    0.2956022809277974,
                    0.05713739436766835,
                    -0.2934843753237021,
                    -0.49223768418803493
                ]
            ],
            'T0_tool1_pathY': [
                [
                    -0.03531752424854295,
                    -0.3714972196452143,
                    -0.5007448417839794,
                    -0.32573429502333007,
                    0.021747909361406553,
                    0.2800405841233082,
                    0.2546440769562919,
                    -0.03531752424854333
                ]
            ],
            'gold_standard': False
        }
    },
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    -0.15554523195117093,
                    0.19219246615042257,
                    0.44238509316213026,
                    0.40663249794462797,
                    0.11185711391672837,
                    -0.21996918242654376,
                    -0.3389744219158122,
                    -0.15554523195117032
                ], [
                    5.144708505321773,
                    4.860757556171935,
                    4.695377487814731,
                    4.7454457013476254,
                    4.98163291632684,
                    5.265583865476678,
                    5.4309639338338815,
                    5.3808957203009875,
                    5.144708505321773
                ], [
                    -1.8100930795620302,
                    -2.0695264316885313,
                    -2.262440502917424,
                    -2.298568655319627,
                    -2.1610061248664607,
                    -1.9141199483941913,
                    -1.6734309117084105,
                    -1.5515600900350757,
                    -1.6055321952784525,
                    -1.81009307956203
                ]
            ],
            'T0_tool0_pathY': [
                [
                    -0.25714285951044563,
                    -0.29983968008123657,
                    -0.05458843226212788,
                    0.2939316921253496,
                    0.4832779309024998,
                    0.3708687043107462,
                    0.04135045270402384,
                    -0.2571428595104454
                ], [
                    4.2683409230436045,
                    4.21827270951071,
                    3.9820854945314967,
                    3.698134545381657,
                    3.5327544770244548,
                    3.582822690557349,
                    3.819009905536562,
                    4.102960854686401,
                    4.2683409230436045
                ], [
                    2.3692156886043496,
                    2.360156076316269,
                    2.186455466379812,
                    1.9293903046514933,
                    1.7092442372650303,
                    1.6290260558015568,
                    1.7262707388936125,
                    1.9554764185681563,
                    2.2093952099680867,
                    2.3692156886043496
                ]
            ],
            'T0_tool1_pathX': [
                [
                    -0.15554523195117093,
                    0.19219246615042257,
                    0.44238509316213026,
                    0.40663249794462797,
                    0.11185711391672837,
                    -0.21996918242654376,
                    -0.3389744219158122,
                    -0.15554523195117032
                ]
            ],
            'T0_tool1_pathY': [
                [
                    -0.25714285951044563,
                    -0.29983968008123657,
                    -0.05458843226212788,
                    0.2939316921253496,
                    0.4832779309024998,
                    0.3708687043107462,
                    0.04135045270402384,
                    -0.2571428595104454
                ]
            ],
            'gold_standard': False
        }
    },
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    -0.5708915716746895,
                    -0.18726366567733527,
                    -0.1163720940026457,
                    -0.42910842832531043,
                    -0.8127363343226647,
                    -0.8836279059973544,
                    -0.5708915716746896
                ], [
                    2.5,
                    2.5,
                    3.5,
                    3.5,
                    1.5,
                    2.5
                ], [
                    0.5,
                    0.5,
                    1.5,
                    1.5,
                    -0.5,
                    0.5,
                    0.2,
                    0.5
                ]
            ],
            'T0_tool0_pathY': [
                [
                    1.597953918397208,
                    1.7375830572141175,
                    2.1396291388169097,
                    2.4020460816027924,
                    2.2624169427858827,
                    1.8603708611830907,
                    1.597953918397208
                ], [
                    2.,
                    3.,
                    3.,
                    2.,
                    2.2,
                    2.
                ], [
                    3.5,
                    4.5,
                    4.5,
                    3.5,
                    3.7,
                    5.7,
                    1.3,
                    3.5
                ]
            ],
            'gold_standard': False
        }
    }
]

kwargs_extra_data = {
    'created_at': [
        '2025-01-21 10:46:20 UTC',
        '2025-01-25 11:46:20 UTC',
        '2025-01-26 16:46:20 UTC',
        '2025-01-28 17:46:20 UTC'
    ]
}

# Ideally the comparison between the result and expectation would be done with
# shape.equal(), but that is awkward to implement, so doing it brute force here
processed_data = {
    'frame0': {
        'T0_tool0': {
            'X': [
                [0, 0],
                [1, 0],
                [2, 0],
                [3, 1],
                [4, 1],
                [5, 1],
                [6, 2],
                [7, 2],
                [8, 2],
                [9, 3],
                [10, 3],
                [11, 3]
            ],
            'data': [
                {
                    'polygon': shapely.Polygon(np.array([
                        [-0.011871167727739784, -0.28870602933343953, -0.38037475471301413, -0.2331790477845634, 0.06665584265632145, 0.3434907042620213, 0.4351594296415958, 0.2879637227131452, -0.0118711677277397],
                        [0.361724434930079, 0.21452872800162825, -0.08530616243925668, -0.3621410240449564, -0.453809749424531, -0.30661404249608026, -0.006779152055195435, 0.2700557095505044, 0.36172443493007894]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [4.630602319839481, 5.081828653996981, 5.449443973123015, 5.225416400970543, 4.719344427837162, 4.630602319839481],
                        [3.855330076852154, 3.615408779166577, 3.9704107662937083, 4.429735358097605, 4.358611580573953, 3.8553300768521543]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-1.726260190173002, -2.14338918482516, -2.3456481393346444, -2.1307780991919705, -1.7136491045398121, -1.5113901500303277, -1.726260190173002],
                        [2.2716019279274726, 2.2643209142423775, 1.8994361013759973, 1.5418323021947127, 1.5491133158798083, 1.9139981287461882, 2.2716019279274726]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-0.49223768418803526, -0.3894572368218461, -0.06253880643091841, 0.24234136097970757, 0.2956022809277974, 0.05713739436766835, -0.2934843753237021, -0.49223768418803493],
                        [-0.03531752424854295, -0.3714972196452143, -0.5007448417839794, -0.32573429502333007, 0.021747909361406553, 0.2800405841233082, 0.2546440769562919, -0.03531752424854333]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [4.665646912973787, 4.9452546176219245, 5.272656813475263, 5.401312969268549, 5.234342375582135, 4.897477295041295, 4.644384004088639, 4.665646912973787],
                        [3.894600505351456, 3.6988170828153155, 3.795354221725569, 4.111517487484036, 4.409229492419295, 4.4643070245969305, 4.235275578910275, 3.8946005053514554]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-2.0530832043103215, -2.347496085003458, -2.2484817914071478, -1.855054617117701, -1.5606417364245644, -1.6596560300208743, -2.053083204310321],
                        [2.3322557650241134, 2.047944550980137, 1.6508199100765353, 1.53800648321691, 1.8223176972608863, 2.219442338164488, 2.3322557650241134]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-0.15554523195117093, 0.19219246615042257, 0.44238509316213026, 0.40663249794462797, 0.11185711391672837, -0.21996918242654376, -0.3389744219158122, -0.15554523195117032],
                        [-0.25714285951044563, -0.29983968008123657, -0.05458843226212788, 0.2939316921253496, 0.4832779309024998, 0.3708687043107462, 0.04135045270402384, -0.2571428595104454]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [5.144708505321773, 4.860757556171935, 4.695377487814731, 4.7454457013476254, 4.98163291632684, 5.265583865476678, 5.4309639338338815, 5.3808957203009875, 5.144708505321773],
                        [4.2683409230436045, 4.21827270951071, 3.9820854945314967, 3.698134545381657, 3.5327544770244548, 3.582822690557349, 3.819009905536562, 4.102960854686401, 4.2683409230436045]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-1.8100930795620302, -2.0695264316885313, -2.262440502917424, -2.298568655319627, -2.1610061248664607, -1.9141199483941913, -1.6734309117084105, -1.5515600900350757, -1.6055321952784525, -1.81009307956203],
                        [2.3692156886043496, 2.360156076316269, 2.186455466379812, 1.9293903046514933, 1.7092442372650303, 1.6290260558015568, 1.7262707388936125, 1.9554764185681563, 2.2093952099680867, 2.3692156886043496]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-0.5708915716746895, -0.18726366567733527, -0.1163720940026457, -0.42910842832531043, -0.8127363343226647, -0.8836279059973544, -0.5708915716746896],
                        [1.597953918397208, 1.7375830572141175, 2.1396291388169097, 2.4020460816027924, 2.2624169427858827, 1.8603708611830907, 1.597953918397208]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [2.5, 2.5, 3.5, 3.5, 2.5],
                        [2.1, 3.0, 3.0, 2.0, 2.1]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [0.5, 0.5, 1.5, 1.5, 0.5],
                        [3.6, 4.5, 4.5, 3.5, 3.6]
                    ]).T),
                    'gold_standard': False
                }
            ]
        },
        'T0_tool1': {
            'X': [
                [0, 0],
                [1, 1],
                [2, 2]
            ],
            'data': [
                {
                    'polygon': shapely.Polygon(np.array([
                        [-0.011871167727739784, -0.28870602933343953, -0.38037475471301413, -0.2331790477845634, 0.06665584265632145, 0.3434907042620213, 0.4351594296415958, 0.2879637227131452, -0.0118711677277397],
                        [0.361724434930079, 0.21452872800162825, -0.08530616243925668, -0.3621410240449564, -0.453809749424531, -0.30661404249608026, -0.006779152055195435, 0.2700557095505044, 0.36172443493007894]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-0.49223768418803526, -0.3894572368218461, -0.06253880643091841, 0.24234136097970757, 0.2956022809277974, 0.05713739436766835, -0.2934843753237021, -0.49223768418803493],
                        [-0.03531752424854295, -0.3714972196452143, -0.5007448417839794, -0.32573429502333007, 0.021747909361406553, 0.2800405841233082, 0.2546440769562919, -0.03531752424854333]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [-0.15554523195117093, 0.19219246615042257, 0.44238509316213026, 0.40663249794462797, 0.11185711391672837, -0.21996918242654376, -0.3389744219158122, -0.15554523195117032],
                        [-0.25714285951044563, -0.29983968008123657, -0.05458843226212788, 0.2939316921253496, 0.4832779309024998, 0.3708687043107462, 0.04135045270402384, -0.2571428595104454]
                    ]).T),
                    'gold_standard': False
                }
            ]
        }
    }
}


# This is list of the clusters, with each cluster having the various contours
reduced_data_intersection_contours = [
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 0,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    0.3434907042620213,
                    0.06665584265632145,
                    0.035708140618821,
                    -0.06253880643091841,
                    -0.3894572368218461,
                    -0.49223768418803526,
                    -0.49223768418803493,
                    -0.2934843753237021,
                    -0.26109636989356166,
                    -0.21996918242654376,
                    0.11185711391672837,
                    0.40663249794462797,
                    0.44238509316213026,
                    0.4111953308040009,
                    0.3434907042620213
                ], [
                    -0.28870602933343953,
                    -0.2735139535802457,
                    -0.26109636989356166,
                    -0.20060780558908908,
                    -0.011871167727739784,
                    -0.0118711677277397,
                    0.2879637227131452,
                    0.4351594296415958,
                    0.4111953308040009,
                    0.25587931382701484,
                    0.24234136097970757,
                    0.035708140618821,
                    -0.2331790477845634,
                    -0.38037475471301413,
                    -0.28870602933343953
                ], [
                    -0.20060780558908908,
                    0.05713739436766835,
                    0.2956022809277974,
                    0.25587931382701484,
                    0.19219246615042257,
                    -0.15554523195117093,
                    -0.15554523195117032,
                    -0.3389744219158122,
                    -0.27351395358024566,
                    -0.22459368577467897,
                    -0.20060780558908908
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    -0.30661404249608026,
                    -0.453809749424531,
                    -0.44434808739102644,
                    -0.5007448417839794,
                    -0.3714972196452143,
                    -0.03531752424854295,
                    -0.03531752424854333,
                    0.2546440769562919,
                    0.25699003001207604,
                    0.3708687043107462,
                    0.4832779309024998,
                    0.2939316921253496,
                    -0.05458843226212788,
                    -0.08516218748775546,
                    -0.30661404249608026
                ], [
                    0.21452872800162825,
                    0.2226064979661171,
                    0.25699003001207604,
                    0.2613713844791226,
                    0.361724434930079,
                    0.36172443493007894,
                    0.2700557095505044,
                    -0.006779152055195435,
                    -0.08516218748775546,
                    -0.23741066668901195,
                    -0.32573429502333007,
                    -0.44434808739102644,
                    -0.3621410240449564,
                    -0.08530616243925668,
                    0.21452872800162825
                ], [
                    0.2613713844791226,
                    0.2800405841233082,
                    0.021747909361406553,
                    -0.23741066668901195,
                    -0.29983968008123657,
                    -0.25714285951044563,
                    -0.2571428595104454,
                    0.04135045270402384,
                    0.2226064979661171,
                    0.2486178657577423,
                    0.2613713844791226
                ]
            ],
            'T0_tool0_consensus': 0.5723807679762805,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2
        }
    },
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 1,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    4.630602319839481,
                    4.630602319839481,
                    4.658295462956292,
                    4.644384004088639,
                    4.707699854782151,
                    4.719344427837162,
                    4.791954327443189,
                    4.897477295041295,
                    5.162772021619619,
                    5.225416400970543,
                    5.24259169742927,
                    5.401312969268549,
                    5.391901686905876,
                    5.449443973123015,
                    5.410841064166533,
                    5.4309639338338815,
                    5.265583865476678,
                    4.98163291632684,
                    4.7454457013476254,
                    4.726741378282931,
                    4.630602319839481
                ], [
                    4.665646912973787,
                    4.658295462956292,
                    4.707699854782151,
                    4.791954327443189,
                    5.162772021619619,
                    5.234342375582135,
                    5.24259169742927,
                    5.391901686905876,
                    5.386015510591181,
                    5.410841064166533,
                    5.275562930243272,
                    5.272656813475263,
                    5.266194425673992,
                    5.266194425673992,
                    5.081828653996981,
                    4.726741378282931,
                    4.7171640385013776,
                    4.665646912973787,
                    4.665646912973787
                ], [
                    4.9452546176219245,
                    4.7171640385013776,
                    4.695377487814731,
                    4.860757556171935,
                    5.144708505321773,
                    5.3808957203009875,
                    5.386015510591181,
                    5.275562930243272,
                    5.274969757564323,
                    5.266194425673992,
                    4.9452546176219245
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    3.855330076852154,
                    3.8553300768521543,
                    4.012385695938597,
                    4.235275578910275,
                    4.292571925109859,
                    4.358611580573953,
                    4.368816236472241,
                    4.4643070245969305,
                    4.420931264734213,
                    4.429735358097605,
                    4.394520781788013,
                    4.111517487484036,
                    4.088389936777963,
                    3.9704107662937083,
                    3.9331323704395342,
                    3.819009905536562,
                    3.582822690557349,
                    3.5327544770244548,
                    3.698134545381657,
                    3.8042120327267175,
                    3.855330076852154
                ], [
                    3.8946005053514554,
                    4.012385695938597,
                    4.292571925109859,
                    4.368816236472241,
                    4.420931264734213,
                    4.409229492419295,
                    4.394520781788013,
                    4.088389936777963,
                    4.073925081093372,
                    3.9331323704395342,
                    3.8024957950329923,
                    3.795354221725569,
                    3.7934487353337105,
                    3.79344873533371,
                    3.615408779166577,
                    3.8042120327267175,
                    3.8585278257101407,
                    3.894600505351456,
                    3.8946005053514554
                ], [
                    3.6988170828153155,
                    3.8585278257101407,
                    3.9820854945314967,
                    4.21827270951071,
                    4.2683409230436045,
                    4.102960854686401,
                    4.073925081093372,
                    3.8024957950329927,
                    3.8019229748354095,
                    3.79344873533371,
                    3.6988170828153155
                ]
            ],
            'T0_tool0_consensus': 0.6353380315630046,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2
        }
    },
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 2,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    -1.5113901500303277,
                    -1.561128116636017,
                    -1.5606417364245644,
                    -1.5640152526307798,
                    -1.7136491045398121,
                    -1.8459444260649625,
                    -1.855054617117701,
                    -1.8834523076541,
                    -2.1307780991919705,
                    -2.1853949812266844,
                    -2.2484817914071478,
                    -2.2855174523162423,
                    -2.3456481393346444,
                    -2.3213831520236607,
                    -2.347496085003458,
                    -2.2716074328809563,
                    -2.262440502917424,
                    -2.0695264316885313,
                    -1.8100930795620302,
                    -1.81009307956203,
                    -1.6055321952784525,
                    -1.5599064027625509,
                    -1.5113901500303277
                ], [
                    -1.726260190173002,
                    -1.7022599463686408,
                    -1.6596560300208743,
                    -1.6346450301820536,
                    -1.5599064027625509,
                    -1.5515600900350757,
                    -1.5803444407979248,
                    -1.561128116636017,
                    -1.5640152526307798,
                    -1.8459444260649625,
                    -1.8834523076541,
                    -2.1853949812266844,
                    -2.2855174523162423,
                    -2.3213831520236607,
                    -2.288217289968108,
                    -2.288217289968108,
                    -2.2882172899681077,
                    -2.2716074328809563,
                    -2.166377691358144,
                    -2.14338918482516,
                    -2.1230644265945626,
                    -2.0530832043103215,
                    -2.053083204310321,
                    -1.8349423242472747,
                    -1.8349423242472744,
                    -1.8349423242472742,
                    -1.726260190173002
                ], [
                    -1.7022599463686408,
                    -1.656824116470657,
                    -1.6346450301820536,
                    -1.5803444407979248,
                    -1.6734309117084105,
                    -1.9141199483941913,
                    -2.1610061248664607,
                    -2.298568655319627,
                    -2.288217289968108,
                    -2.1663776913581434,
                    -2.1230644265945626,
                    -1.9214498872712094,
                    -1.8349423242472742,
                    -1.7022599463686408
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    1.9139981287461882,
                    1.8242684617394296,
                    1.8223176972608863,
                    1.8190599305289143,
                    1.5491133158798083,
                    1.5468040924528874,
                    1.53800648321691,
                    1.546149389944429,
                    1.5418323021947127,
                    1.6327300583550457,
                    1.6508199100765353,
                    1.7993618327116296,
                    1.8994361013759973,
                    1.943211297266067,
                    2.047944550980137,
                    2.1212293704700755,
                    2.186455466379812,
                    2.360156076316269,
                    2.3692156886043496,
                    2.3692156886043496,
                    2.2093952099680867,
                    1.9947427327289593,
                    1.9139981287461882
                ], [
                    2.2716019279274726,
                    2.231658814592464,
                    2.219442338164488,
                    2.1191286968822776,
                    1.9947427327289593,
                    1.9554764185681563,
                    1.9013409283006542,
                    1.8242684617394296,
                    1.8190599305289143,
                    1.5468040924528874,
                    1.546149389944429,
                    1.6327300583550457,
                    1.7993618327116296,
                    1.943211297266067,
                    2.003044096259028,
                    2.003044096259029,
                    2.0030440962590292,
                    2.1212293704700755,
                    2.2228485506345055,
                    2.2643209142423775,
                    2.2646756842169427,
                    2.3322557650241134,
                    2.3322557650241134,
                    2.269704874220669,
                    2.269704874220669,
                    2.269704874220669,
                    2.2716019279274726
                ], [
                    2.231658814592464,
                    2.156040895129682,
                    2.1191286968822776,
                    1.9013409283006542,
                    1.7262707388936125,
                    1.6290260558015568,
                    1.7092442372650303,
                    1.9293903046514933,
                    2.003044096259028,
                    2.222848550634506,
                    2.2646756842169427,
                    2.2681948790913045,
                    2.269704874220669,
                    2.231658814592464
                ]
            ],
            'T0_tool0_consensus': 0.7645350003018981,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2
        }
    },
    {
        'frame0': {
            'T0_tool1_cluster_label_for_contours': 0,
            'T0_tool1_number_of_contours': 3,
            'T0_tool1_contours_x': [
                [
                    0.3434907042620213,
                    0.06665584265632145,
                    0.035708140618821,
                    -0.06253880643091841,
                    -0.3894572368218461,
                    -0.49223768418803526,
                    -0.49223768418803493,
                    -0.2934843753237021,
                    -0.26109636989356166,
                    -0.21996918242654376,
                    0.11185711391672837,
                    0.40663249794462797,
                    0.44238509316213026,
                    0.4111953308040009,
                    0.3434907042620213
                ], [
                    -0.28870602933343953,
                    -0.2735139535802457,
                    -0.26109636989356166,
                    -0.20060780558908908,
                    -0.011871167727739784,
                    -0.0118711677277397,
                    0.2879637227131452,
                    0.4351594296415958,
                    0.4111953308040009,
                    0.25587931382701484,
                    0.24234136097970757,
                    0.035708140618821,
                    -0.2331790477845634,
                    -0.38037475471301413,
                    -0.28870602933343953
                ], [
                    -0.20060780558908908,
                    0.05713739436766835,
                    0.2956022809277974,
                    0.25587931382701484,
                    0.19219246615042257,
                    -0.15554523195117093,
                    -0.15554523195117032,
                    -0.3389744219158122,
                    -0.27351395358024566,
                    -0.22459368577467897,
                    -0.20060780558908908
                ]
            ],
            'T0_tool1_contours_y': [
                [
                    -0.30661404249608026,
                    -0.453809749424531,
                    -0.44434808739102644,
                    -0.5007448417839794,
                    -0.3714972196452143,
                    -0.03531752424854295,
                    -0.03531752424854333,
                    0.2546440769562919,
                    0.25699003001207604,
                    0.3708687043107462,
                    0.4832779309024998,
                    0.2939316921253496,
                    -0.05458843226212788,
                    -0.08516218748775546,
                    -0.30661404249608026
                ], [
                    0.21452872800162825,
                    0.2226064979661171,
                    0.25699003001207604,
                    0.2613713844791226,
                    0.361724434930079,
                    0.36172443493007894,
                    0.2700557095505044,
                    -0.006779152055195435,
                    -0.08516218748775546,
                    -0.23741066668901195,
                    -0.32573429502333007,
                    -0.44434808739102644,
                    -0.3621410240449564,
                    -0.08530616243925668,
                    0.21452872800162825
                ], [
                    0.2613713844791226,
                    0.2800405841233082,
                    0.021747909361406553,
                    -0.23741066668901195,
                    -0.29983968008123657,
                    -0.25714285951044563,
                    -0.2571428595104454,
                    0.04135045270402384,
                    0.2226064979661171,
                    0.2486178657577423,
                    0.2613713844791226
                ]
            ],
            'T0_tool1_consensus': 0.5723807679762805,
            'T0_tool1_cluster_labels': [0, 0, 0]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2
        }
    }
]

TestPolygonTReducerIntersectionContours = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data,
    processed_data,
    reduced_data_intersection_contours,
    'Test polygon reducer with a series of polygons in 3 clusters using intersection contour average. remember this is one cluster per row',
    kwargs={
        'eps': 0.5,
        'min_samples': 2
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data,
    test_name='TestPolygonTReducerIntersectionContours'
)

# This is list of the clusters, with each cluster having the various contours
# found using rastorisation
reduced_data_intersection_contours_rasterisation = [
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 0,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    -0.09573105137281351,
                    -0.048527880799572876,
                    0.0269971921176122,
                    0.06475972857620482,
                    0.3290974837863526,
                    0.357419386130297,
                    0.4140631908181859,
                    0.44238509316213026,
                    0.4140631908181859,
                    0.12140353326409359,
                    0.08364099680550108,
                    -0.20901866074859116,
                    -0.2373405630925356,
                    -0.25622183132183185,
                    -0.3223062701243688,
                    -0.49223768418803526,
                    -0.49223768418803526,
                    -0.3978313430415539,
                    -0.09573105137281351
                ], [
                    0.017556558002964073,
                    0.055319094461556695,
                    0.2252505085252231,
                    0.2535724108691675,
                    0.2630130449838156,
                    0.40462255670353764,
                    0.4376647761048062,
                    0.31021621555705636,
                    0.27245367909846374,
                    -0.020205978455628437,
                    -0.19957802663394303,
                    -0.26566246543648,
                    -0.30342500189507254,
                    -0.38839070892690575,
                    -0.22789992897788747,
                    0.017556558002964073
                ], [
                    0.12140353326409359,
                    0.19692860618127872,
                    0.2535724108691675,
                    0.30077558144240824,
                    0.055319094461556695,
                    -0.15237485606070234,
                    -0.26566246543648,
                    -0.30342500189507254,
                    -0.3411875383536651,
                    -0.17125612428999865,
                    -0.15237485606070234,
                    -0.1051716854874617,
                    0.12140353326409359
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    -0.4908052178174493,
                    -0.5007448417839794,
                    -0.4510467219513289,
                    -0.46098634591785903,
                    -0.3218316103864377,
                    -0.2820731145203173,
                    -0.08328063518971546,
                    -0.06340138725665523,
                    0.2944250755384281,
                    0.4832779309024998,
                    0.4832779309024998,
                    0.38388169123719895,
                    0.3441231953710786,
                    0.27454582760536794,
                    0.22484770777271745,
                    -0.02364289139053488,
                    -0.06340138725665523,
                    -0.3715297302190882,
                    -0.4908052178174493
                ], [
                    -0.4411070979847988,
                    -0.4411070979847988,
                    -0.3417108583194979,
                    -0.31189198641990756,
                    -0.23237499468766687,
                    -0.09322025915624554,
                    -0.003763643457474708,
                    0.24472695570577763,
                    0.284485451571898,
                    0.3640024433041388,
                    0.2646062036388378,
                    0.25466657967230777,
                    0.19502883587312714,
                    -0.08328063518971546,
                    -0.3715297302190882,
                    -0.4411070979847988
                ], [
                    -0.2920127384868474,
                    -0.30195236245337753,
                    -0.24231461865419696,
                    0.026055228442115608,
                    0.284485451571898,
                    0.27454582760536794,
                    0.2347873317392476,
                    0.16520996397353693,
                    0.03599485240864564,
                    -0.24231461865419696,
                    -0.26219386658725713,
                    -0.2721334905537872,
                    -0.2920127384868474
                ]
            ],
            'T0_tool0_consensus': 0.5723807679762805,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2,
            'rasterisation': True,
            'num_grid_points': 100
        }
    },
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 1,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    4.961447432277272,
                    5.02761645476483,
                    5.267479161282229,
                    5.432901717501125,
                    5.416359461879235,
                    5.449443973123015,
                    5.449443973123015,
                    5.399817206257346,
                    5.399817206257346,
                    5.226123522227505,
                    5.135141116307112,
                    4.895278409789714,
                    4.7877537482474315,
                    4.7215847257598735,
                    4.705042470137984,
                    4.638873447650425,
                    4.655415703272316,
                    4.630602319839481,
                    4.7215847257598735,
                    4.738126981381763,
                    4.754669237003653,
                    4.961447432277272
                ], [
                    5.052429838197665,
                    5.102056605063334,
                    5.375003822824512,
                    5.416359461879235,
                    5.395681642351874,
                    5.226123522227505,
                    5.077243221630499,
                    4.804296003869322,
                    4.696771342327039,
                    4.655415703272316,
                    4.66368683108326,
                    4.713313597948929,
                    4.729855853570818,
                    5.052429838197665
                ], [
                    4.936634048844438,
                    4.953176304466328,
                    5.267479161282229,
                    5.383274950635457,
                    5.391546078446401,
                    5.375003822824512,
                    5.143412244118058,
                    4.87046502635688,
                    4.688500214516094,
                    4.705042470137984,
                    4.729855853570818,
                    4.936634048844438
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    3.542164098717106,
                    3.5327544770244548,
                    3.579802585487711,
                    3.815043127803993,
                    3.9373682098084593,
                    3.9655970748864133,
                    3.9844163182717156,
                    4.078512535198229,
                    4.125560643661485,
                    4.436078159518977,
                    4.426668537826325,
                    4.4643070245969305,
                    4.370210807670418,
                    4.360801185977767,
                    4.294933834129208,
                    4.229066482280649,
                    4.003235561657018,
                    3.852681614574598,
                    3.8056335061113415,
                    3.7021276674921775,
                    3.683308424106875,
                    3.542164098717106
                ], [
                    3.6268506939509675,
                    3.6268506939509675,
                    3.890320101345203,
                    3.9467778315011106,
                    4.08792215689088,
                    4.417258916133674,
                    4.417258916133674,
                    4.379620429363069,
                    4.276114590743905,
                    3.993825939964367,
                    3.890320101345203,
                    3.852681614574598,
                    3.79622388441869,
                    3.6268506939509675
                ], [
                    3.7021276674921775,
                    3.6927180457995266,
                    3.7915190735723643,
                    4.050283670120274,
                    4.08792215689088,
                    4.116151021968833,
                    4.276114590743905,
                    4.229066482280649,
                    3.9750066965790642,
                    3.8809104796525515,
                    3.8432719928819465,
                    3.7021276674921775
                ]
            ],
            'T0_tool0_consensus': 0.6353380315630046,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2,
            'rasterisation': True,
            'num_grid_points': 100
        }
    },
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 2,
            'T0_tool0_number_of_contours': 3,
            'T0_tool0_contours_x': [
                [
                    -2.136358222636506,
                    -1.7140824979026017,
                    -1.5113901500303277,
                    -1.5113901500303277,
                    -1.5620632369983962,
                    -1.5958452949771087,
                    -1.8069831573440607,
                    -2.077239621173759,
                    -2.263040940056677,
                    -2.271486454551355,
                    -2.347496085003458,
                    -2.330605056014102,
                    -2.347496085003458,
                    -2.2883774835407116,
                    -2.254595425561999,
                    -2.1870313096045746,
                    -2.136358222636506
                ], [
                    -1.8914383022908416,
                    -1.832319700828095,
                    -1.5789542659877522,
                    -1.5578404797510572,
                    -1.5789542659877522,
                    -1.5451722080090402,
                    -1.638072867450499,
                    -1.6549638964398552,
                    -1.6971914689132457,
                    -1.730973526891958,
                    -1.8576562443121292,
                    -2.051903077689725,
                    -2.1194671936471496,
                    -2.144803737131184,
                    -2.275709211798694,
                    -2.2883774835407116,
                    -2.3221595415194236,
                    -2.3221595415194236,
                    -2.2799319690460336,
                    -2.1954768240992526,
                    -1.8914383022908416
                ], [
                    -1.925220360269554,
                    -1.8914383022908416,
                    -1.6634094109345332,
                    -1.5789542659877522,
                    -1.6211818384611427,
                    -1.7140824979026017,
                    -1.8661017588068072,
                    -2.1110216791524716,
                    -2.136358222636506,
                    -2.1954768240992526,
                    -2.2926002407880506,
                    -2.3052685125300676,
                    -2.16169476612054,
                    -1.925220360269554
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    1.5464025357965812,
                    1.5464025357965812,
                    1.8990367441427676,
                    1.924224901881781,
                    2.008185427678492,
                    2.2012946370109274,
                    2.3692156886043496,
                    2.3608196360246785,
                    2.1928985844312563,
                    2.1257301637938877,
                    2.0501656905768475,
                    1.9746012173598075,
                    1.8906406915630964,
                    1.7982841131867144,
                    1.6555512193323056,
                    1.6303630615932923,
                    1.5464025357965812
                ], [
                    1.5464025357965812,
                    1.5547985883762523,
                    1.7982841131867144,
                    1.8234722709257276,
                    1.8990367441427676,
                    1.9578091122004655,
                    2.1341262163735584,
                    2.2180867421702697,
                    2.234878847329612,
                    2.2768591102279676,
                    2.2768591102279676,
                    2.335631478285665,
                    2.2684630576482965,
                    2.2684630576482965,
                    2.1173341112142166,
                    2.008185427678492,
                    1.9494130596207944,
                    1.9158288493021098,
                    1.7814920080273722,
                    1.6387591141729634,
                    1.5464025357965812
                ], [
                    1.6303630615932923,
                    1.6303630615932923,
                    1.7311156925493454,
                    1.8906406915630964,
                    2.092145953475203,
                    2.243274899909283,
                    2.2768591102279676,
                    2.2684630576482965,
                    2.2600670050686253,
                    2.184502531851585,
                    1.999789375098821,
                    1.932620954461452,
                    1.7059275348103322,
                    1.6303630615932923
                ]
            ],
            'T0_tool0_consensus': 0.7645350003018981,
            'T0_tool0_cluster_labels': [0, 1, 2, 0, 1, 2, 0, 1, 2, -1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2,
            'rasterisation': True,
            'num_grid_points': 100
        }
    },
    {
        'frame0': {
            'T0_tool1_cluster_label_for_contours': 0,
            'T0_tool1_number_of_contours': 3,
            'T0_tool1_contours_x': [
                [
                    -0.09573105137281351,
                    -0.048527880799572876,
                    0.0269971921176122,
                    0.06475972857620482,
                    0.3290974837863526,
                    0.357419386130297,
                    0.4140631908181859,
                    0.44238509316213026,
                    0.4140631908181859,
                    0.12140353326409359,
                    0.08364099680550108,
                    -0.20901866074859116,
                    -0.2373405630925356,
                    -0.25622183132183185,
                    -0.3223062701243688,
                    -0.49223768418803526,
                    -0.49223768418803526,
                    -0.3978313430415539,
                    -0.09573105137281351
                ], [
                    0.017556558002964073,
                    0.055319094461556695,
                    0.2252505085252231,
                    0.2535724108691675,
                    0.2630130449838156,
                    0.40462255670353764,
                    0.4376647761048062,
                    0.31021621555705636,
                    0.27245367909846374,
                    -0.020205978455628437,
                    -0.19957802663394303,
                    -0.26566246543648,
                    -0.30342500189507254,
                    -0.38839070892690575,
                    -0.22789992897788747,
                    0.017556558002964073
                ], [
                    0.12140353326409359,
                    0.19692860618127872,
                    0.2535724108691675,
                    0.30077558144240824,
                    0.055319094461556695,
                    -0.15237485606070234,
                    -0.26566246543648,
                    -0.30342500189507254,
                    -0.3411875383536651,
                    -0.17125612428999865,
                    -0.15237485606070234,
                    -0.1051716854874617,
                    0.12140353326409359
                ]
            ],
            'T0_tool1_contours_y': [
                [
                    -0.4908052178174493,
                    -0.5007448417839794,
                    -0.4510467219513289,
                    -0.46098634591785903,
                    -0.3218316103864377,
                    -0.2820731145203173,
                    -0.08328063518971546,
                    -0.06340138725665523,
                    0.2944250755384281,
                    0.4832779309024998,
                    0.4832779309024998,
                    0.38388169123719895,
                    0.3441231953710786,
                    0.27454582760536794,
                    0.22484770777271745,
                    -0.02364289139053488,
                    -0.06340138725665523,
                    -0.3715297302190882,
                    -0.4908052178174493
                ], [
                    -0.4411070979847988,
                    -0.4411070979847988,
                    -0.3417108583194979,
                    -0.31189198641990756,
                    -0.23237499468766687,
                    -0.09322025915624554,
                    -0.003763643457474708,
                    0.24472695570577763,
                    0.284485451571898,
                    0.3640024433041388,
                    0.2646062036388378,
                    0.25466657967230777,
                    0.19502883587312714,
                    -0.08328063518971546,
                    -0.3715297302190882,
                    -0.4411070979847988
                ], [
                    -0.2920127384868474,
                    -0.30195236245337753,
                    -0.24231461865419696,
                    0.026055228442115608,
                    0.284485451571898,
                    0.27454582760536794,
                    0.2347873317392476,
                    0.16520996397353693,
                    0.03599485240864564,
                    -0.24231461865419696,
                    -0.26219386658725713,
                    -0.2721334905537872,
                    -0.2920127384868474
                ]
            ],
            'T0_tool1_consensus': 0.5723807679762805,
            'T0_tool1_cluster_labels': [0, 0, 0]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2,
            'rasterisation': True,
            'num_grid_points': 100
        }
    }
]

# Test with American English
TestPolygonTReducerIntersectionContoursRasterisation = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data,
    processed_data,
    reduced_data_intersection_contours_rasterisation,
    'Test polygon reducer with a series of polygons in 3 clusters using intersection contour average with rasterisation. remember this is one cluster per row',
    kwargs={
        'eps': 0.5,
        'min_samples': 2,
        'rasterization': True,
        'num_grid_points': 100
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data,
    test_name='TestPolygonTReducerIntersectionContoursRasterisation'
)


# Now to test cases with not enough intersection to cluster
extracted_data_no_overall_intersection = [
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    0.21554927386591496,
                    0.8346610570311462,
                    0.36812686536062333,
                    -0.25098491780460797,
                    0.2155492738659148
                ]
            ],
            'T0_tool0_pathY': [
                [
                    -0.25858097547222986,
                    0.20795321619829304,
                    0.8270649993635244,
                    0.3605308076930015,
                    -0.25858097547222986
                ]
            ],
            'gold_standard': False
        }
    },
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    0.3693081708169513,
                    0.553908720812514,
                    0.5957542682751744,
                    0.47526481648569685,
                    0.2488187190274737,
                    0.022372621569250545,
                    -0.09811683022022713,
                    -0.05627128275756679,
                    0.12832926723799587,
                    0.36930817081695105
                ]
            ],
            'T0_tool0_pathY': [
                [
                    -0.5218849589408747,
                    -0.3669867055244751,
                    -0.1296688129675387,
                    0.07902503930795732,
                    0.16144467844849417,
                    0.07902503930795748,
                    -0.1296688129675385,
                    -0.366986705524475,
                    -0.5218849589408747,
                    -0.5218849589408747
                ]
            ],
            'gold_standard': False
        }
    },
    {
        'frame0': {
            'T0_tool0_pathX': [
                [
                    0.09127357717866474,
                    0.024685520754786305,
                    -0.21171962328979593,
                    -0.5073252607061052,
                    -0.7238142284563371,
                    -0.7598889325232856,
                    -0.5986696179483486,
                    -0.3155925937742383,
                    -0.04311274566270751,
                    0.0912735771786648
                ]
            ],
            'T0_tool0_pathY': [
                [
                    0.3044349351140881,
                    0.5928594950295896,
                    0.7710035487895189,
                    0.7555115137889823,
                    0.5536322853795214,
                    0.2598273981716289,
                    0.011571424167481636,
                    -0.07497390733855891,
                    0.040686926109404054,
                    0.3044349351140878
                ]
            ],
            'gold_standard': False
        }
    }
]

kwargs_extra_data_no_overall_intersection = {
    'created_at': [
        '2025-01-21 10:46:20 UTC',
        '2025-01-25 11:46:20 UTC',
        '2025-01-26 16:46:20 UTC'
    ]
}

processed_data_no_overall_intersection = {
    'frame0': {
        'T0_tool0': {
            'X': [
                [0, 0],
                [1, 1],
                [2, 2]
            ],
            'data': [
                {
                    'polygon': shapely.Polygon(np.array([
                        [0.21554927386591496, 0.8346610570311462, 0.36812686536062333, -0.25098491780460797, 0.2155492738659148],
                        [-0.25858097547222986, 0.20795321619829304, 0.8270649993635244, 0.3605308076930015, -0.25858097547222986]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [0.3693081708169513, 0.553908720812514, 0.5957542682751744, 0.47526481648569685, 0.2488187190274737, 0.022372621569250545, -0.09811683022022713, -0.05627128275756679, 0.12832926723799587, 0.36930817081695105],
                        [-0.5218849589408747, -0.3669867055244751, -0.1296688129675387, 0.07902503930795732, 0.16144467844849417, 0.07902503930795748, -0.1296688129675385, -0.366986705524475, -0.5218849589408747, -0.5218849589408747]
                    ]).T),
                    'gold_standard': False
                }, {
                    'polygon': shapely.Polygon(np.array([
                        [0.09127357717866474, 0.024685520754786305, -0.21171962328979593, -0.5073252607061052, -0.7238142284563371, -0.7598889325232856, -0.5986696179483486, -0.3155925937742383, -0.04311274566270751, 0.0912735771786648],
                        [0.3044349351140881, 0.5928594950295896, 0.7710035487895189, 0.7555115137889823, 0.5536322853795214, 0.2598273981716289, 0.011571424167481636, -0.07497390733855891, 0.040686926109404054, 0.3044349351140878]
                    ]).T),
                    'gold_standard': False
                }
            ]
        }
    }
}

reduced_data_no_overall_intersection = [
    {
        'frame0': {
            'T0_tool0_cluster_labels': [-1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2
        }
    }
]

TestPolygonTReducerIntersectionContoursNoIntersection = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data_no_overall_intersection,
    processed_data_no_overall_intersection,
    reduced_data_no_overall_intersection,
    'Test the polygon contour reducer can handle the case where the intersecting polygons are not close enough to form a cluster with this eps',
    kwargs={
        'eps': 0.5,
        'min_samples': 2
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data,
    test_name='TestPolygonTReducerIntersectionContoursNoIntersection'
)

# Now test if it can handle not enough data to cluster, by increasing min_samples
reduced_data_not_enough_data = [
    {
        'frame0': {
            'T0_tool0_cluster_labels': [-1, -1, -1]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 4
        }
    }
]

TestPolygonTReducerIntersectionContoursNotEnoughData = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data_no_overall_intersection,
    processed_data_no_overall_intersection,
    reduced_data_not_enough_data,
    'Test if when there is not enough data to cluster, by "min_samples", it returns all as outliers',
    kwargs={
        'eps': 0.5,
        'min_samples': 4
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data,
    test_name='TestPolygonTReducerIntersectionContoursNotEnoughData'
)

# Case of cluster of 1. This is just the original extraction
reduced_data_cluster_of_1 = [
    {
        'frame0':
            {
                'T0_tool0_cluster_label_for_contours': 0,
                'T0_tool0_number_of_contours': 1,
                'T0_tool0_contours_x': [
                    [
                        0.21554927386591496,
                        0.8346610570311462,
                        0.36812686536062333,
                        -0.25098491780460797,
                        0.2155492738659148,
                        0.21554927386591496
                    ]
                ],
                'T0_tool0_contours_y': [
                    [
                        -0.25858097547222986,
                        0.20795321619829304,
                        0.8270649993635244,
                        0.3605308076930015,
                        -0.25858097547222986,
                        -0.25858097547222986
                    ]
                ],
                'T0_tool0_consensus': 1.0,
                'T0_tool0_cluster_labels': [0, 1, 2],
            },
        'parameters':
            {
                'eps': 0.5,
                'min_samples': 1
            }
    },
    {
        'frame0':
            {
                'T0_tool0_cluster_label_for_contours': 1,
                'T0_tool0_number_of_contours': 1,
                'T0_tool0_contours_x': [
                    [
                        0.3693081708169513,
                        0.553908720812514,
                        0.5957542682751744,
                        0.47526481648569685,
                        0.2488187190274737,
                        0.022372621569250545,
                        -0.09811683022022713,
                        -0.05627128275756679,
                        0.12832926723799587,
                        0.36930817081695105,
                        0.3693081708169513
                    ]
                ],
                'T0_tool0_contours_y': [
                    [
                        -0.5218849589408747,
                        -0.3669867055244751,
                        -0.1296688129675387,
                        0.07902503930795732,
                        0.16144467844849417,
                        0.07902503930795748,
                        -0.1296688129675385,
                        -0.366986705524475,
                        -0.5218849589408747,
                        -0.5218849589408747,
                        -0.5218849589408747
                    ]
                ],
                'T0_tool0_consensus': 1.0,
                'T0_tool0_cluster_labels': [0, 1, 2],
            },
        'parameters':
            {
                'eps': 0.5,
                'min_samples': 1
            }
    },
    {
        'frame0':
            {
                'T0_tool0_cluster_label_for_contours': 2,
                'T0_tool0_number_of_contours': 1,
                'T0_tool0_contours_x': [
                    [
                        0.09127357717866474,
                        0.024685520754786305,
                        -0.21171962328979593,
                        -0.5073252607061052,
                        -0.7238142284563371,
                        -0.7598889325232856,
                        -0.5986696179483486,
                        -0.3155925937742383,
                        -0.04311274566270751,
                        0.0912735771786648,
                        0.09127357717866474
                    ]
                ],
                'T0_tool0_contours_y': [
                    [
                        0.3044349351140881,
                        0.5928594950295896,
                        0.7710035487895189,
                        0.7555115137889823,
                        0.5536322853795214,
                        0.2598273981716289,
                        0.011571424167481636,
                        -0.07497390733855891,
                        0.040686926109404054,
                        0.3044349351140878,
                        0.3044349351140881
                    ]
                ],
                'T0_tool0_consensus': 1.0,
                'T0_tool0_cluster_labels': [0, 1, 2],
            },
        'parameters':
            {
                'eps': 0.5,
                'min_samples': 1
            }
    }
]


TestPolygonTReducerIntersectionContoursClusterOfOne = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data_no_overall_intersection,
    processed_data_no_overall_intersection,
    reduced_data_cluster_of_1,
    'Test polygon reducer with a series of polygons in 3 to see if clusters of 1 can be found',
    kwargs={
        'eps': 0.5,
        'min_samples': 1
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data,
    test_name='TestPolygonTReducerIntersectionContoursClusterOfOne'
)

# Test if can use rasterisation if cluster has 10 or more polygons.
# This is not realistic data, just the simplest possible cluster of 10
classification_square = {
    'frame0': {
        'T0_tool0_pathX': [
            [
                0,
                0,
                1,
                1,
                0
            ]
        ],
        'T0_tool0_pathY': [
            [
                0,
                1,
                1,
                0,
                0
            ]
        ],
        'gold_standard': False
    }
}

extracted_data_10_identical_squares = [classification_square for i in range(10)]

kwargs_extra_data_10_identical_squares = {
    'created_at': [
        '2025-01-21 10:46:20 UTC',
        '2025-01-21 10:46:21 UTC',
        '2025-01-21 10:46:22 UTC',
        '2025-01-21 10:46:23 UTC',
        '2025-01-21 10:46:24 UTC',
        '2025-01-21 10:46:25 UTC',
        '2025-01-21 10:46:26 UTC',
        '2025-01-21 10:46:27 UTC',
        '2025-01-21 10:46:28 UTC',
        '2025-01-21 10:46:29 UTC'
    ]
}

processed_data_10_identical_squares_dictionary = {
    'polygon': shapely.Polygon(np.array([[0, 0], [0, 1], [1, 1], [1, 0]])),
    'gold_standard': False
}

processed_data_10_identical_squares = {
    'frame0': {
        'T0_tool0': {
            'X': [
                [0, 0],
                [1, 1],
                [2, 2],
                [3, 3],
                [4, 4],
                [5, 5],
                [6, 6],
                [7, 7],
                [8, 8],
                [9, 9]
            ],
            'data': [processed_data_10_identical_squares_dictionary for i in range(10)],
        }
    }
}

# Now test if it can handle not enough data to cluster, by increasing min_samples
reduced_data_10_identical_squares = [
    {
        'frame0': {
            'T0_tool0_cluster_label_for_contours': 0,
            'T0_tool0_number_of_contours': 10,
            'T0_tool0_contours_x': [
                [
                    0.0,
                    0.9932885906040269,
                    1.0,
                    0.006711409395973154,
                    0.0
                ], [
                    0.0006711409395973155,
                    0.9932885906040269,
                    0.9993288590604027,
                    0.006711409395973154,
                    0.0006711409395973155
                ], [
                    0.001342281879194631,
                    0.9932885906040269,
                    0.9986577181208054,
                    0.006711409395973155,
                    0.001342281879194631
                ], [
                    0.002013422818791946,
                    0.9932885906040267,
                    0.997986577181208,
                    0.006711409395973153,
                    0.002013422818791946
                ], [
                    0.002684563758389262,
                    0.9932885906040267,
                    0.9973154362416108,
                    0.006711409395973154,
                    0.002684563758389262
                ], [
                    0.003355704697986577,
                    0.9932885906040269,
                    0.9966442953020134,
                    0.006711409395973154,
                    0.003355704697986577
                ], [
                    0.004026845637583892,
                    0.9932885906040267,
                    0.9959731543624161,
                    0.006711409395973154,
                    0.004026845637583892
                ], [
                    0.004697986577181208,
                    0.9932885906040267,
                    0.9953020134228188,
                    0.006711409395973154,
                    0.004697986577181208
                ], [
                    0.005369127516778524,
                    0.9932885906040269,
                    0.9946308724832215,
                    0.006711409395973155,
                    0.005369127516778524
                ], [
                    0.006040268456375839,
                    0.9932885906040269,
                    0.9939597315436242,
                    0.006711409395973154,
                    0.006040268456375839
                ]
            ],
            'T0_tool0_contours_y': [
                [
                    0.006711409395973154,
                    0.0,
                    0.9932885906040269,
                    1.0,
                    0.006711409395973154
                ], [
                    0.006711409395973154,
                    0.0006711409395973155,
                    0.9932885906040269,
                    0.9993288590604027,
                    0.006711409395973154
                ], [
                    0.006711409395973155,
                    0.001342281879194631,
                    0.9932885906040269,
                    0.9986577181208054,
                    0.006711409395973155
                ], [
                    0.006711409395973153,
                    0.002013422818791946,
                    0.9932885906040267,
                    0.997986577181208,
                    0.006711409395973153
                ], [
                    0.006711409395973154,
                    0.002684563758389262,
                    0.9932885906040267,
                    0.9973154362416108,
                    0.006711409395973154
                ], [
                    0.006711409395973154,
                    0.003355704697986577,
                    0.9932885906040269,
                    0.9966442953020134,
                    0.006711409395973154
                ], [
                    0.006711409395973154,
                    0.004026845637583892,
                    0.9932885906040267,
                    0.9959731543624161,
                    0.006711409395973154
                ], [
                    0.006711409395973154,
                    0.004697986577181208,
                    0.9932885906040267,
                    0.9953020134228188,
                    0.006711409395973154
                ], [
                    0.006711409395973155,
                    0.005369127516778524,
                    0.9932885906040269,
                    0.9946308724832215,
                    0.006711409395973155
                ], [
                    0.006711409395973154,
                    0.006040268456375839,
                    0.9932885906040269,
                    0.9939597315436242,
                    0.006711409395973154
                ]
            ],
            'T0_tool0_consensus': 1.0,
            'T0_tool0_cluster_labels': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        },
        'parameters': {
            'eps': 0.5,
            'min_samples': 2,
            'num_grid_points': 150
        }
    }
]

TestPolygonTReducerIntersectionContours10IdenticalSquares = ReducerTest(
    polygon_reducer_contours,
    process_data,
    extracted_data_10_identical_squares,
    processed_data_10_identical_squares,
    reduced_data_10_identical_squares,
    'Test polygon reducer contours can switch to rasterisation if cluster has 10 polygons',
    kwargs={
        'eps': 0.5,
        'min_samples': 2,
        'num_grid_points': 150
    },
    output_kwargs=True,
    network_kwargs=kwargs_extra_data_10_identical_squares,
    test_name='TestPolygonTReducerIntersectionContours10IdenticalSquares'
)
