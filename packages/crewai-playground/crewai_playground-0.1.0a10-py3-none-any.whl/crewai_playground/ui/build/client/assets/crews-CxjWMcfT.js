import{w as oe,u as ce}from"./store-BDLt0vbv.js";import{q as ne,r as n,x as le,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{B as ae,L as de}from"./Layout-B81zoSt7.js";import{L as ue,T as me,I as ge}from"./textarea-UcLoFDyB.js";import{S as he,i as pe,j as fe,k as xe,l as we}from"./select-Cc29qyRs.js";import{K as be}from"./KickoffNavigation-IQLivJkc.js";import{A as ye,a as je,b as Ne}from"./alert-lWJ1rAjF.js";import{C as ve}from"./card-CMaBRHIZ.js";import{d as re,a as Ce,b as Se,M as Z,i as ke,C as Ee,B as $e,c as Re,e as Te,H,P as q}from"./index-K9TuxQyt.js";import{L as Q}from"./play-CkFdbzCt.js";import{M as Ie}from"./index-ChbM4Wl4.js";import"./index-BKaxNvVC.js";import"./chevron-down-CuwaHdVJ.js";import"./transform-BEtJ_6wc.js";const M=d=>{switch(d){case"completed":return"#6366f1";case"running":return"#10b981";case"waiting":return"#f59e0b";case"initializing":return"#3b82f6";case"pending":return"#64748b";default:return"#64748b"}},L=new re.graphlib.Graph().setDefaultEdgeLabel(()=>({})),Ae=d=>({width:280,height:150}),Oe=(d,o,a="TB")=>{if(!d.length)return{nodes:d,edges:o,fullWidth:0,fullHeight:0};const{width:w,height:h}=Ae(),g=Math.max(w,320),c=Math.max(h,200);L.setGraph({rankdir:a,nodesep:100,ranksep:150}),d.forEach(f=>{f.data&&(f.data.uniformWidth=g,f.data.uniformHeight=c),L.setNode(f.id,{width:g,height:c})}),o.forEach(f=>{L.setEdge(f.source,f.target)}),re.layout(L);const p=L.graph(),x=p&&p.width?p.width/2:0,r=p&&p.height?p.height/2:0;return{nodes:d.map(f=>{const v=L.node(f.id);return v?{...f,position:{x:v.x-g/2,y:v.y-c/2},data:{...f.data,uniformWidth:g,uniformHeight:c}}:(console.warn(`No dagre node found for id: ${f.id}`),f)}),edges:o,fullWidth:x,fullHeight:r}},We=({data:d,id:o})=>{const a=d,w=M(a.status),h=a.hasIncomingEdge??!1,g=a.hasOutgoingEdge??!1;return e.jsxs("div",{className:"px-4 py-3 shadow-md rounded-md bg-white border-2",style:{borderColor:w,width:a.uniformWidth?`${a.uniformWidth}px`:"320px",minHeight:a.uniformHeight?`${a.uniformHeight}px`:"180px"},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-sm",children:a.role}),e.jsx("div",{className:"rounded-full w-3 h-3",style:{backgroundColor:w}})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:a.name}),e.jsx("div",{className:"mt-2 text-xs",children:a.description&&a.description.length>80?`${a.description.substring(0,80)}...`:a.description}),a.associatedTasks&&a.associatedTasks.length>0&&e.jsxs("div",{className:"mt-3 border-t pt-2",children:[e.jsx("div",{className:"text-xs font-semibold mb-1",children:"Tasks:"}),e.jsx("div",{className:"space-y-2",children:a.associatedTasks.map(c=>e.jsxs("div",{className:"text-xs p-2 rounded bg-gray-50 border border-gray-100",style:{borderLeft:`3px solid ${M(c.status)}`},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-medium",children:c.description.length>50?`${c.description.substring(0,50)}...`:c.description}),e.jsx("div",{className:"ml-1 text-[10px] px-1.5 py-0.5 rounded-full font-medium",style:{backgroundColor:M(c.status),color:"white",opacity:.9},children:c.status})]}),c.output&&e.jsxs("div",{className:"mt-1.5",children:[e.jsx("div",{className:"text-[10px] text-gray-500 font-medium",children:"Output:"}),e.jsx("div",{className:"whitespace-pre-wrap overflow-hidden max-h-16 overflow-y-auto text-[10px] mt-0.5",children:typeof c.output=="string"?c.output.substring(0,120)+(c.output.length>120?"...":""):JSON.stringify(c.output,null,2).substring(0,120)+"..."})]})]},c.id))})]}),h&&e.jsx(H,{type:"target",position:q.Top,className:"w-2 h-2 bg-blue-500",isConnectable:!1}),g&&e.jsx(H,{type:"source",position:q.Bottom,className:"w-2 h-2 bg-blue-500",isConnectable:!1})]})},ze=({data:d})=>{const o=d,a=M(o.status),w=o.hasIncomingEdge??!1,h=o.hasOutgoingEdge??!1;return e.jsxs("div",{className:"px-4 py-2 shadow-md rounded-md bg-white border-2 w-[280px]",style:{borderColor:a},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-sm",children:"Task"}),e.jsx("div",{className:"rounded-full w-3 h-3",style:{backgroundColor:a}})]}),o.assignedAgentName&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Assigned to: ",o.assignedAgentName]}),e.jsx("div",{className:"mt-2 text-xs",children:o.description&&o.description.length>100?`${o.description.substring(0,100)}...`:o.description}),w&&e.jsx(H,{type:"target",position:q.Top,className:"w-2 h-2 bg-blue-500",isConnectable:!1}),h&&e.jsx(H,{type:"source",position:q.Bottom,className:"w-2 h-2 bg-blue-500",isConnectable:!1})]})},De=({data:d})=>{const o=d,a=M(o.status),w=o.hasOutgoingEdge??!1;return e.jsxs("div",{className:"px-4 py-2 shadow-md rounded-md bg-white border-2 w-[280px]",style:{borderColor:a},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"font-bold text-sm",children:"Crew"}),e.jsx("div",{className:"rounded-full w-3 h-3",style:{backgroundColor:a}})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:o.name}),e.jsxs("div",{className:"mt-2 text-xs",children:["Status: ",o.status]}),w&&e.jsx(H,{type:"source",position:q.Bottom,className:"w-2 h-2 bg-blue-500",isConnectable:!1})]})},Le=({crewId:d,isRunning:o,resetKey:a=0})=>{var ee,te,se;ne();const w=n.useRef(null),h=n.useRef(null),g=n.useRef(null),c=n.useRef(0),p=n.useRef(null),x=n.useRef(null),[r,R]=n.useState({crew:null,agents:[],tasks:[]}),[f,v]=n.useState([]),[X,z]=n.useState([]),[F,P]=n.useState(null),U=n.useCallback(s=>v(i=>Ce(s,i)),[]),B=n.useCallback(s=>z(i=>Se(s,i)),[]),[O,D]=n.useState("connecting"),[J,l]=n.useState(!1),[j,u]=n.useState(!1),[C,S]=n.useState(null),ie={agent:We,task:ze,crew:De},Y=n.useCallback(async s=>{if(s){l(!0),S(null);try{const i=await fetch(`/api/crews/${s}/initialize`,{method:"POST",headers:{"Content-Type":"application/json"}}),b=await i.json();if(!i.ok)throw new Error(b.message||"Failed to initialize crew");console.log("Crew initialization successful:",b)}catch(i){console.error("Error initializing crew:",i),S(`Failed to initialize crew: ${i instanceof Error?i.message:String(i)}`)}finally{l(!1)}}},[]),V=n.useCallback(()=>{if(h.current&&h.current.readyState===WebSocket.OPEN){console.log("WebSocket already connected");return}p.current&&(clearTimeout(p.current),p.current=null),x.current&&(clearInterval(x.current),x.current=null),D("connecting");try{const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/crew-visualization/${d}`;console.log(`Connecting to WebSocket at ${s}`);const i=new WebSocket(s);h.current=i,i.onopen=()=>{console.log("WebSocket connection established"),c.current=0},i.onmessage=b=>{try{const t=JSON.parse(b.data);t.type==="connection_established"?(D("connected"),g.current=t.client_id,console.log(`Connection established with client ID: ${t.client_id}`),d&&i.send(JSON.stringify({type:"register_crew",crew_id:d})),x.current=setInterval(()=>{i.readyState===WebSocket.OPEN&&i.send(JSON.stringify({type:"ping"}))},3e4),i.send(JSON.stringify({type:"request_state"}))):t.type==="crew_registered"?console.log(`Registered for crew: ${t.crew_id}`):t.type==="pong"?console.log("Heartbeat pong received"):t.crew!==void 0||t.agents!==void 0||t.tasks!==void 0?(console.log("ðŸ”„ Received crew visualization data:",{crew:t.crew?{id:t.crew.id,status:t.crew.status,hasOutput:!!t.crew.output}:null,agents:t.agents?t.agents.length:0,tasks:t.tasks?t.tasks.length:0,timestamp:t.timestamp}),R(W=>{var y,k,T,E,I,$;const N={...W};if(t.crew!==void 0&&(N.crew=t.crew,console.log("âœ… Updated crew state:",{id:(y=t.crew)==null?void 0:y.id,status:(k=t.crew)==null?void 0:k.status,hasOutput:!!((T=t.crew)!=null&&T.output),outputLength:(E=t.crew)!=null&&E.output?t.crew.output.length:0}),((I=t.crew)==null?void 0:I.status)==="completed"&&(($=t.crew)!=null&&$.output)&&console.log("ðŸŽ‰ Crew completed with output! Result will be displayed.")),t.agents!==void 0){const A=new Map(W.agents.map(m=>[m.id,m]));t.agents.forEach(m=>{A.set(m.id,m)}),N.agents=Array.from(A.values()),console.log("ðŸ‘¥ Updated agents:",N.agents.map(m=>({id:m.id,status:m.status})))}if(t.tasks!==void 0){const A=new Map(W.tasks.map(m=>[m.id,m]));t.tasks.forEach(m=>{A.set(m.id,m)}),N.tasks=Array.from(A.values()),console.log("ðŸ“‹ Updated tasks:",N.tasks.map(m=>({id:m.id,status:m.status})))}return t.timestamp&&(N.timestamp=t.timestamp),N}),console.log("âœ… Setting hasReceivedData to true"),u(!0)):typeof t=="object"&&t!==null&&("crew"in t||"agents"in t||"tasks"in t||"timestamp"in t)&&(console.log("Fallback: Received potential crew data:",t),u(!0),R(W=>{const N={...W};return"crew"in t&&t.crew&&(N.crew=t.crew),"agents"in t&&t.agents&&(N.agents=t.agents),"tasks"in t&&t.tasks&&(N.tasks=t.tasks),"timestamp"in t&&t.timestamp&&(N.timestamp=t.timestamp),N}))}catch(t){console.error("Error processing WebSocket message:",t)}},i.onclose=b=>{if(console.log(`WebSocket connection closed: ${b.code} ${b.reason}`),D("disconnected"),x.current&&(clearInterval(x.current),x.current=null),c.current<5){const t=Math.min(1e3*2**c.current,3e4);console.log(`Attempting to reconnect in ${t}ms (attempt ${c.current+1}/5)`),p.current=setTimeout(()=>{c.current+=1,V()},t)}else console.log("Maximum reconnection attempts reached"),S("Failed to connect to visualization service after multiple attempts. Please try again later.")},i.onerror=b=>{console.error("WebSocket error:",b),S("Error connecting to visualization service")}}catch(s){console.error("Error setting up WebSocket:",s),D("disconnected"),S(`Failed to connect: ${s instanceof Error?s.message:String(s)}`)}},[d]);return n.useEffect(()=>(R({crew:null,agents:[],tasks:[]}),u(!1),S(null),h.current&&(h.current.close(),h.current=null),p.current&&(clearTimeout(p.current),p.current=null),x.current&&(clearInterval(x.current),x.current=null),c.current=0,d&&Y(d).then(()=>{V()}),()=>{h.current&&(h.current.close(),h.current=null),p.current&&(clearTimeout(p.current),p.current=null),x.current&&(clearInterval(x.current),x.current=null)}),[d,V,Y]),n.useEffect(()=>{R({crew:null,agents:[],tasks:[]}),u(!1),S(null),console.log(`State reset triggered by resetKey: ${a}`)},[a]),n.useEffect(()=>{F&&f.length>0&&setTimeout(()=>{F.fitView({padding:.2})},50)},[f.length,F,d,a]),n.useEffect(()=>{var N;if(!r.crew&&!r.agents.length&&!r.tasks.length)return;const s=[],i=[];if(r.crew){const y={id:`crew-${r.crew.id}`,type:"crew",position:{x:0,y:0},data:{...r.crew,hasOutgoingEdge:r.agents.length>0,hasIncomingEdge:!1}};s.push(y)}const b=[...r.agents].sort((y,k)=>{const T={running:0,waiting:1,initializing:2,completed:3};return(T[y.status]||99)-(T[k.status]||99)});if(b.forEach((y,k)=>{var _,K;const T=r.tasks.filter(G=>G.agent_id===y.id),E=k===0,I=k===b.length-1,$=E||((_=r.crew)==null?void 0:_.type)==="sequential"&&k>0,A=((K=r.crew)==null?void 0:K.type)==="sequential"&&!I,m={id:`agent-${y.id}`,type:"agent",position:{x:0,y:0},data:{...y,associatedTasks:T,isFirst:E,isLast:I,hasIncomingEdge:$,hasOutgoingEdge:A}};if(s.push(m),r.crew&&k===0){const G={id:`crew-${r.crew.id}-to-agent-${y.id}`,source:`crew-${r.crew.id}`,target:`agent-${y.id}`,type:"default",markerEnd:{type:Z.ArrowClosed,color:"#64748b"},style:{strokeWidth:2,stroke:"#64748b"}};i.push(G)}}),((N=r.crew)==null?void 0:N.type)==="sequential"&&r.crew.execution_order)for(let y=0;y<r.crew.execution_order.length-1;y++){const k=r.crew.execution_order[y],T=r.crew.execution_order[y+1],E=b.find($=>$.id===k),I=b.find($=>$.id===T);if(E&&I){const $=`agent-${E.id}`,A=`agent-${I.id}`;let m="#64748b",_=!1;E.status==="completed"?m="#6366f1":E.status==="running"&&(m="#10b981",_=!0);const K={id:`agent-${E.id}-to-${I.id}`,source:$,target:A,type:"default",markerEnd:{type:Z.ArrowClosed,color:m},style:{strokeWidth:2,stroke:m},animated:_};i.push(K)}}const{nodes:t,edges:W}=Oe(s,i,"TB");v(t),z(W)},[r,v,z]),le().pathname,(ee=r.crew)!=null&&ee.id,e.jsxs(ve,{className:"p-6 mb-6 overflow-hidden relative",children:[e.jsx("div",{className:"flex justify-between items-center mb-4",children:e.jsx("h3",{className:"text-lg font-semibold",children:"Crew Execution Visualization"})}),!j&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-white/80 dark:bg-slate-900/80 z-10",children:[e.jsx(Q,{className:"h-8 w-8 animate-spin text-indigo-500 mb-4"}),e.jsx("h3",{className:"text-lg font-medium",children:J?"Initializing crew...":o?"Waiting for data...":"Loading visualization..."}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:J?"Setting up the crew structure...":o?"The crew execution will appear here once it starts":"Connecting to visualization service..."}),e.jsxs("div",{className:"mt-4 flex items-center space-x-2",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${O==="connected"?"bg-green-500":O==="connecting"?"bg-amber-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs",children:O==="connected"?"Connected":O==="connecting"?"Connecting...":"Disconnected"}),O==="disconnected"&&e.jsx(ae,{size:"sm",variant:"outline",onClick:()=>V(),className:"ml-2",children:"Reconnect"})]})]}),C&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4",children:e.jsx("p",{className:"text-sm",children:C})}),e.jsx("div",{className:"h-[600px] border rounded-md overflow-hidden mb-6",ref:w,children:e.jsxs(ke,{nodes:f,edges:X,onNodesChange:U,onEdgesChange:B,nodeTypes:ie,fitView:!0,fitViewOptions:{padding:.2},attributionPosition:"bottom-right",defaultEdgeOptions:{type:"default",markerEnd:{type:Z.ArrowClosed}},connectionLineType:Ee.SmoothStep,proOptions:{hideAttribution:!0},minZoom:.5,maxZoom:1.5,elementsSelectable:!0,onInit:P,children:[e.jsx($e,{color:"#aaa",gap:16}),e.jsx(Re,{}),e.jsx(Te,{nodeStrokeWidth:3,zoomable:!0,pannable:!0})]})}),((te=r.crew)==null?void 0:te.status)==="completed"&&((se=r.crew)==null?void 0:se.output)&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Crew Results"}),e.jsx("div",{className:"p-6 rounded-lg border bg-card overflow-auto",children:e.jsx("div",{className:"text-base leading-7",children:e.jsx(Ie,{components:{h1:({...s})=>e.jsx("h1",{className:"text-2xl font-bold mt-6 mb-4",...s}),h2:({...s})=>e.jsx("h2",{className:"text-xl font-bold mt-5 mb-3",...s}),h3:({...s})=>e.jsx("h3",{className:"text-lg font-bold mt-4 mb-2",...s}),p:({...s})=>e.jsx("p",{className:"mb-4",...s}),ul:({...s})=>e.jsx("ul",{className:"list-disc pl-6 mb-4",...s}),ol:({...s})=>e.jsx("ol",{className:"list-decimal pl-6 mb-4",...s}),li:({...s})=>e.jsx("li",{className:"mb-1",...s}),a:({...s})=>e.jsx("a",{className:"text-blue-500 hover:underline",...s}),blockquote:({...s})=>e.jsx("blockquote",{className:"border-l-4 border-muted pl-4 italic my-4",...s}),code:s=>{const{children:i,className:b}=s;return!/language-(\w+)/.exec(b||"")&&(typeof i=="string"?!i.includes(`
`):!0)?e.jsx("code",{className:"bg-muted px-1 py-0.5 rounded",...s,children:i}):e.jsx("pre",{className:"p-4 rounded-md bg-muted overflow-x-auto",children:e.jsx("code",{className:b,children:i})})}},children:r.crew.output})})})]})]})};function Ye(){return[{title:"CrewAI - Kickoff Mode"},{name:"description",content:"Run a crew directly with specific inputs"}]}const et=oe(function(){ne();const{crews:o,setCrews:a}=ce(),[w,h]=n.useState(!1),[g,c]=n.useState(""),[p,x]=n.useState(null),[r,R]=n.useState([]),[f,v]=n.useState(null),[X,z]=n.useState(null),[F,P]=n.useState(!1),[U,B]=n.useState(0);n.useEffect(()=>{P(!1),z(null),v(null),B(1)},[]),n.useEffect(()=>{(async()=>{try{h(!0);const u=await(await fetch("/api/crews")).json();u.crews&&(a(u.crews),u.crews.length>0&&!g&&c(u.crews[0].id))}catch(j){console.error("Error fetching crews:",j)}finally{h(!1)}})()},[a,g]),n.useEffect(()=>{(async()=>{if(!g){x(null),R([]);return}try{h(!0);const u=await(await fetch(`/api/initialize?crew_id=${g}`)).json();if(u.status==="success"){const C=o.find(S=>S.id===g);C&&(x({id:C.id,name:C.name,description:C.description,required_inputs:u.required_inputs||[]}),R((u.required_inputs||[]).map(S=>({name:S.name,description:S.description,value:""}))))}else v(u.detail||"Failed to fetch crew details")}catch(j){console.error("Error fetching crew details:",j),v("Failed to fetch crew details. Please try again later.")}finally{h(!1)}})()},[g,o]);const O=(l,j)=>{R(u=>u.map(C=>C.name===l?{...C,value:j}:C))},D=async l=>{if(l.preventDefault(),!g)return;h(!0),v(null),z(null),P(!0),B(u=>u+1);const j={};r.forEach(u=>{j[u.name]=u.value});try{const C=await(await fetch(`/api/crews/${g}/kickoff`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inputs:j})})).json();C.status==="success"||v(C.detail||"Failed to run crew")}catch(u){console.error("Error running crew:",u),v("Failed to run crew. Please try again later.")}finally{h(!1)}},J=e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Select a Crew"}),e.jsxs(he,{value:g,onValueChange:c,disabled:w,children:[e.jsx(pe,{id:"crew-select",className:"w-full",children:e.jsx(fe,{placeholder:"Select a crew"})}),e.jsx(xe,{children:o.map(l=>e.jsx(we,{value:l.id,children:l.name},l.id))})]})]}),p&&e.jsxs("div",{className:"p-4 rounded-lg border bg-accent/50",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:p.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:p.description})]}),r.length>0&&e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Required Inputs"}),r.map(l=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ue,{htmlFor:l.name,className:"text-sm font-medium",children:[l.name,l.description&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 block mt-1",children:l.description})]}),l.description.toLowerCase().includes("longer")?e.jsx(me,{id:l.name,value:l.value,onChange:j=>O(l.name,j.target.value),disabled:w,className:"min-h-24 text-sm"}):e.jsx(ge,{id:l.name,value:l.value,onChange:j=>O(l.name,j.target.value),disabled:w,className:"text-sm"})]},l.name)),e.jsx(ae,{type:"submit",className:"w-full",disabled:w||r.some(l=>!l.value),children:w?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"mr-2 h-4 w-4 animate-spin"}),"Running Crew..."]}):"Run Crew"})]})]});return e.jsxs(de,{rightSidebar:J,children:[f&&e.jsxs(ye,{variant:"destructive",className:"mb-6",children:[e.jsx(je,{children:"Error"}),e.jsx(Ne,{children:f})]}),g&&e.jsx(be,{crewId:g}),g&&e.jsx(Le,{crewId:g,isRunning:F,resetKey:U}),!f&&!g&&e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Run a Crew Directly"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a crew from the sidebar, provide the required inputs, and run it to see results here."}),w&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx(Q,{className:"h-8 w-8 animate-spin text-primary"})})]})})]})});export{et as default,Ye as meta};
