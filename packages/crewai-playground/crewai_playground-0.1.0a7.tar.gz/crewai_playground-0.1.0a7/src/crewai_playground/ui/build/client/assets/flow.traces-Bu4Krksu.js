import{w as se,u as te}from"./store-BDLt0vbv.js";import{q as re,p as ae,r as n,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{C as w,a as N,b as y,d as L,c as S}from"./card-Cd_s9Lcu.js";import{T as ie,a as ne,b as P,c as $}from"./tabs-Rg-Jy3Im.js";import{B as T}from"./badge-BrVE-78x.js";import{a as le,B as U,f as ce,M as de}from"./sun-CQoWRrLL.js";import{I as oe,T as me,a as ue,A as xe,b as fe,c as he,d as ge}from"./scroll-area-DfJgwTXN.js";import"./separator-DFnxFCCM.js";import{A as je,a as pe,b as be}from"./alert-C8ewgBGD.js";import{S as ve,i as we,j as Ne,k as ye,l as Se}from"./select-Dsrp1aXH.js";import{L as q}from"./loader-circle-BOkGL-CS.js";import"./index-BKaxNvVC.js";import"./chevron-down-7prL2jkC.js";import"./transform-BEtJ_6wc.js";/**
 * @license lucide-react v0.483.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],_e=le("ArrowLeft",Te);function Re(){return[{title:"CrewAI - Flow Traces"},{name:"description",content:"View execution traces for flows"}]}function D(t){try{return(typeof t=="number"?new Date(t*1e3):new Date(t)).toLocaleString()}catch{return"Invalid time"}}function B(t,r){try{const i=typeof t=="number"?new Date(t*1e3):new Date(t);if(!r)return"In progress";const l=(typeof r=="number"?new Date(r*1e3):new Date(r)).getTime()-i.getTime(),f=Math.floor(l/1e3%60),h=Math.floor(l/(1e3*60)%60),_=Math.floor(l/(1e3*60*60));return _>0?`${_}h ${h}m ${f}s`:h>0?`${h}m ${f}s`:`${f}s`}catch{return"Invalid time"}}function G(t){switch(t.toLowerCase()){case"running":case"initializing":return"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300 border-blue-200 dark:border-blue-800";case"completed":return"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 border-green-200 dark:border-green-800";case"failed":return"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300 border-red-200 dark:border-red-800";case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300 border-yellow-200 dark:border-yellow-800";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300 border-gray-200 dark:border-gray-800"}}const V=t=>!t||!Array.isArray(t)?[]:t.map(r=>{var f,h;const i=typeof r.start_time=="number"?new Date(r.start_time*1e3):new Date(r.start_time),x=r.end_time?typeof r.end_time=="number"?new Date(r.end_time*1e3):new Date(r.end_time):null,l=x&&i?x.getTime()-i.getTime():0;return{id:r.id,name:r.name,startTime:i,endTime:x,status:r.status,parentId:r.parent_id,children:r.children?V(r.children):[],depth:0,duration:l,serviceName:(f=r.attributes)==null?void 0:f.service_name,operation:(h=r.attributes)==null?void 0:h.operation}}),K=t=>{const r=typeof t.start_time=="number"?new Date(t.start_time*1e3):new Date(t.start_time),i=t.end_time?typeof t.end_time=="number"?new Date(t.end_time*1e3):new Date(t.end_time):null,x=i&&r?i.getTime()-r.getTime():0;return{id:t.id,name:t.name,startTime:r,endTime:i,status:t.status,duration:x,parentId:t.parent_id,depth:0,tags:t.attributes||{},logs:t.events?t.events.map(l=>({timestamp:typeof l.timestamp=="number"?new Date(l.timestamp):new Date(l.timestamp),fields:l.attributes||{}})):[]}},He=se(function(){var O,R,H;const r=re(),[i,x]=ae(),{flows:l,setFlows:f,isDarkMode:h,toggleDarkMode:_}=te(),[C,k]=n.useState(!1),[p,A]=n.useState(null),[d,b]=n.useState(""),[v,I]=n.useState([]),[g,j]=n.useState(null),[M,z]=n.useState(null),[Q,W]=n.useState("overview"),a=n.useMemo(()=>!g||!Array.isArray(v)?null:v.find(s=>s&&s.id===g)||null,[v,g]);n.useEffect(()=>{const s=i.get("flowId"),c=i.get("traceId");s&&b(s),c&&j(c)},[i]),n.useEffect(()=>{const s=new URLSearchParams;d&&s.set("flowId",d),g&&s.set("traceId",g),x(s)},[d,g,x]),n.useEffect(()=>{const s=async()=>{try{const o=await(await fetch("/api/flows")).json();o.flows&&(f(o.flows),o.flows.length>0&&!d&&b(o.flows[0].id))}catch(c){console.error("Error fetching flows:",c),A("Failed to fetch flows. Please try again later.")}finally{k(!1)}};l.length?!d&&l.length>0&&b(l[0].id):(k(!0),s())},[l,f,d]),n.useEffect(()=>{const s=i.get("flowId");s&&!d&&b(s)},[i,d]),n.useEffect(()=>{(async()=>{if(!d){I([]),j("");return}try{k(!0),A(null),i.get("flowId")!==d&&x({flowId:d});const o=await(await fetch(`/api/flows/${d}/traces`)).json();if(o.status==="success"&&Array.isArray(o.traces)){console.log("Received traces:",o.traces);const m=o.traces.filter(u=>u&&typeof u=="object"&&u.id&&u.start_time!==void 0&&(u.status==="completed"||u.status==="failed"||u.status==="running"||u.status==="initializing"));m.sort((u,J)=>{const ee=typeof u.start_time=="number"?u.start_time:0;return(typeof J.start_time=="number"?J.start_time:0)-ee}),console.log("Valid traces after filtering:",m),I(m),m.length>0&&!g?j(m[0].id):m.length===0&&j("")}else A(o.detail||"Failed to fetch flow traces"),I([]),j("")}catch(c){console.error("Error fetching flow traces:",c),A("Failed to fetch flow traces. Please try again later."),I([]),j("")}finally{k(!1)}})()},[d]);const F=n.useMemo(()=>{if(!M||!a)return null;const s=o=>{if(!o||!Array.isArray(o))return null;for(const m of o)if(m){if(m.id===M)return m;if(m.children&&Array.isArray(m.children)&&m.children.length>0){const u=s(m.children);if(u)return u}}return null},c=a.spans||[];return Array.isArray(c)?s(c):null},[M,a]),E=n.useMemo(()=>F?K(F):null,[F,K]),X=n.useMemo(()=>{if(!a)return[];const s=a.spans||[];return Array.isArray(s)?V(s):[]},[a]);n.useMemo(()=>{if(!a||!a.spans)return[];const s=a.spans.filter(c=>!c.parent_id||c.parent_id===a.id);return V(s)},[a]);const Y=()=>{r("/flow")},Z=()=>C?e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx(q,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Loading traces..."})]}):p?e.jsx("div",{className:"p-4 text-red-500",children:p}):v.length===0?e.jsx("div",{className:"p-4 text-gray-500 dark:text-gray-400",children:"No traces found."}):e.jsx("div",{className:"space-y-2",children:v.map(s=>e.jsxs("div",{className:`p-3 border rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 ${(a==null?void 0:a.id)===s.id?"border-primary bg-gray-50 dark:bg-gray-800":""}`,onClick:()=>{j(s.id),z(null)},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"font-medium",children:["Trace ",s.id.slice(0,7)]}),e.jsx(T,{variant:s.status==="completed"?"outline":s.status==="running"?"default":"destructive",className:s.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300":"",children:s.status})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mt-1",children:[e.jsx("div",{children:D(s.start_time)}),e.jsx("div",{children:B(s.start_time,s.end_time)})]})]},s.id))});return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background text-foreground",children:[e.jsx("header",{className:"py-4 px-6 border-b bg-background",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{variant:"ghost",size:"icon",onClick:Y,className:"mr-4",children:e.jsx(_e,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-2xl font-bold",children:"Flow Traces"})]}),e.jsx(U,{variant:"ghost",size:"icon",onClick:_,className:"h-8 w-8",children:h?e.jsx(ce,{className:"h-4 w-4"}):e.jsx(de,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[e.jsxs("aside",{className:"w-80 border-r flex-shrink-0 overflow-y-auto p-4 bg-background",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs(ve,{onValueChange:b,value:d,children:[e.jsx(we,{children:e.jsx(Ne,{placeholder:"Select a flow"})}),e.jsx(ye,{children:l.map(s=>e.jsx(Se,{value:s.id,children:s.name},s.id))})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:Z()})]}),e.jsxs("main",{className:"flex-1 overflow-y-auto p-6 bg-background",children:[p&&e.jsxs(je,{variant:"destructive",className:"mb-6",children:[e.jsx(pe,{children:"Error"}),e.jsx(be,{children:p})]}),C&&e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(q,{className:"h-8 w-8 animate-spin text-primary"})}),!C&&!p&&!a&&e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Flow Traces"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Select a flow and a trace from the sidebar to view execution details."})]})}),a&&e.jsx("div",{className:"space-y-4",children:e.jsxs(ie,{defaultValue:"overview",value:Q,onValueChange:W,className:"w-full",children:[e.jsxs(ne,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(P,{value:"overview",className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:"Overview"})]}),e.jsx(P,{value:"methods",children:"Methods"}),e.jsx(P,{value:"events",children:"Events"})]}),e.jsx($,{value:"overview",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs(w,{children:[e.jsxs(N,{className:"pb-2",children:[e.jsx(y,{className:"text-lg",children:"Timeline"}),e.jsx(L,{children:"Visualization of execution spans over time"})]}),e.jsx(S,{children:e.jsx(me,{spans:X,onSpanClick:s=>z(s.id)})})]}),E&&e.jsxs(w,{children:[e.jsx(N,{className:"pb-2",children:e.jsx(y,{className:"text-lg",children:"Span Details"})}),e.jsx(S,{children:E&&e.jsx(ue,{span:E})})]}),e.jsxs(w,{children:[e.jsx(N,{className:"pb-2",children:e.jsx(y,{className:"text-lg",children:"Flow Summary"})}),e.jsx(S,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Methods"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"text-lg",variant:"outline",children:((O=a.spans)==null?void 0:O.filter(s=>s.parent_id===a.id).length)||0}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total methods"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Status"}),e.jsx(T,{className:G(a.status),variant:"outline",children:a.status})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Duration"}),e.jsx("div",{className:"text-sm",children:B(a.start_time,a.end_time)})]})]})})]})]})}),e.jsx($,{value:"methods",children:e.jsxs(w,{children:[e.jsxs(N,{className:"pb-2",children:[e.jsx(y,{className:"text-lg",children:"Methods"}),e.jsx(L,{children:"Flow execution methods and their details"})]}),e.jsx(S,{children:e.jsx("div",{className:"space-y-4",children:e.jsx(xe,{type:"single",collapsible:!0,className:"w-full",children:(R=a.spans)==null?void 0:R.filter(s=>s.parent_id===a.id).map(s=>e.jsxs(fe,{value:s.id,children:[e.jsx(he,{className:"hover:bg-muted px-4",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:G(s.status),variant:"outline",children:s.status}),e.jsx("span",{className:"ml-2 font-medium",children:s.name})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:B(s.start_time,s.end_time)})]})}),e.jsxs(ge,{className:"px-4 py-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Method ID"}),e.jsx("div",{className:"text-sm font-mono",children:s.id}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Start Time"}),e.jsx("div",{children:D(s.start_time)}),s.end_time&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"End Time"}),e.jsx("div",{children:D(s.end_time)})]})]}),s.attributes&&Object.keys(s.attributes).length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Attributes"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[200px]",children:JSON.stringify(s.attributes,null,2)})]})]})]},s.id))})})})]})}),e.jsx($,{value:"events",children:e.jsxs(w,{children:[e.jsxs(N,{className:"pb-2",children:[e.jsx(y,{className:"text-lg",children:"Events"}),e.jsx(L,{children:"Flow execution events and their details"})]}),e.jsx(S,{children:e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"border rounded-md divide-y",children:(H=a.spans)==null?void 0:H.flatMap(s=>s.events||[]).map((s,c)=>e.jsxs("div",{className:"p-3 hover:bg-muted",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(T,{variant:"outline",children:s.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:D(s.timestamp)})]}),s.attributes&&Object.keys(s.attributes).length>0&&e.jsx("div",{className:"mt-2 text-xs font-mono bg-muted p-2 rounded",children:JSON.stringify(s.attributes,null,2)})]},c))})})})]})})]})})]})]})]})});export{He as default,Re as meta};
