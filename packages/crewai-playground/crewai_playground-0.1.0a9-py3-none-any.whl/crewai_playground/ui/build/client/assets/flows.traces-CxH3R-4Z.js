import{w as Y,u as Z}from"./store-BDLt0vbv.js";import{q as ee,p as se,r as i,l as e}from"./chunk-GNGMS2XR-KLeu_BA0.js";import{L as te}from"./Layout-DKHufUNX.js";import{F as re}from"./FlowNavigation-CbX_2-8q.js";import{C as v,a as b,b as w,c as y,d as M}from"./card-B1lx2btn.js";import{T as ae,a as ie,b as E,c as L}from"./tabs-DDlzywPH.js";import{B as T}from"./badge-BqQV3u5m.js";import{S as ne,I as le,T as ce,a as de,A as oe,b as me,c as ue,d as xe}from"./scroll-area-Dql3cGC_.js";import"./separator-DebHuMXk.js";import{A as fe,a as he,b as je}from"./alert-DlesyTNp.js";import{S as ge,i as pe,j as ve,k as be,l as we}from"./select-DG1lcftZ.js";import{L as J}from"./play-Dmz1CelZ.js";import"./index-BKaxNvVC.js";import"./chevron-down-BqB9OCfP.js";import"./transform-BEtJ_6wc.js";function Ve(){return[{title:"CrewAI - Flow Traces"},{name:"description",content:"View execution traces for flows"}]}function k(r){try{return(typeof r=="number"?new Date(r*1e3):new Date(r)).toLocaleString()}catch{return"Invalid time"}}function P(r,t){try{const c=typeof r=="number"?new Date(r*1e3):new Date(r);if(!t)return"In progress";const u=(typeof t=="number"?new Date(t*1e3):new Date(t)).getTime()-c.getTime(),h=Math.floor(u/1e3%60),f=Math.floor(u/(1e3*60)%60),j=Math.floor(u/(1e3*60*60));return j>0?`${j}h ${f}m ${h}s`:f>0?`${f}m ${h}s`:`${h}s`}catch{return"Invalid time"}}function U(r){switch(r.toLowerCase()){case"running":case"initializing":return"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300 border-blue-200 dark:border-blue-800";case"completed":return"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300 border-green-200 dark:border-green-800";case"failed":return"bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300 border-red-200 dark:border-red-800";case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300 border-yellow-200 dark:border-yellow-800";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300 border-gray-200 dark:border-gray-800"}}const $=r=>!r||!Array.isArray(r)?[]:r.map(t=>{var h,f;const c=typeof t.start_time=="number"?new Date(t.start_time*1e3):new Date(t.start_time),x=t.end_time?typeof t.end_time=="number"?new Date(t.end_time*1e3):new Date(t.end_time):null,u=x&&c?x.getTime()-c.getTime():0;return{id:t.id,name:t.name,startTime:c,endTime:x,status:t.status,parentId:t.parent_id,children:t.children?$(t.children):[],depth:0,duration:u,serviceName:(h=t.attributes)==null?void 0:h.service_name,operation:(f=t.attributes)==null?void 0:f.operation}}),q=r=>{const t=typeof r.start_time=="number"?new Date(r.start_time*1e3):new Date(r.start_time),c=r.end_time?typeof r.end_time=="number"?new Date(r.end_time*1e3):new Date(r.end_time):null,x=c&&t?c.getTime()-t.getTime():0;return{id:r.id,name:r.name,startTime:t,endTime:c,status:r.status,duration:x,parentId:r.parent_id,depth:0,tags:r.attributes||{},logs:r.events?r.events.map(u=>({timestamp:typeof u.timestamp=="number"?new Date(u.timestamp):new Date(u.timestamp),fields:u.attributes||{}})):[]}},Oe=Y(function(){var O,B,z;ee();const[t,c]=se(),{flows:x,setFlows:u,isDarkMode:h}=Z(),[f,j]=i.useState(!1),[_,A]=i.useState(null),[n,N]=i.useState(""),[S,I]=i.useState([]),[g,p]=i.useState(null),[D,V]=i.useState(null),[H,G]=i.useState("overview"),a=i.useMemo(()=>!g||!Array.isArray(S)?null:S.find(s=>s&&s.id===g)||null,[S,g]);i.useEffect(()=>{const s=t.get("flowId"),l=t.get("traceId");s&&N(s),l&&p(l)},[t]),i.useEffect(()=>{const s=new URLSearchParams;n&&s.set("flowId",n),g&&s.set("traceId",g),c(s)},[n,g,c]),i.useEffect(()=>{const s=async()=>{try{const d=await(await fetch("/api/flows")).json();d.flows&&(u(d.flows),d.flows.length>0&&!n&&N(d.flows[0].id))}catch(l){console.error("Error fetching flows:",l),A("Failed to fetch flows. Please try again later.")}finally{j(!1)}};x.length?!n&&x.length>0&&N(x[0].id):(j(!0),s())},[x,u,n]),i.useEffect(()=>{const s=t.get("flowId");s&&!n&&N(s)},[t,n]),i.useEffect(()=>{(async()=>{if(!n){I([]),p("");return}try{j(!0),A(null),t.get("flowId")!==n&&c({flowId:n});const d=await(await fetch(`/api/flows/${n}/traces`)).json();if(d.status==="success"&&Array.isArray(d.traces)){console.log("Received traces:",d.traces);const o=d.traces.filter(m=>m&&typeof m=="object"&&m.id&&m.start_time!==void 0&&(m.status==="completed"||m.status==="failed"||m.status==="running"||m.status==="initializing"));o.sort((m,R)=>{const X=typeof m.start_time=="number"?m.start_time:0;return(typeof R.start_time=="number"?R.start_time:0)-X}),console.log("Valid traces after filtering:",o),I(o),o.length>0&&!g?p(o[0].id):o.length===0&&p("")}else A(d.detail||"Failed to fetch flow traces"),I([]),p("")}catch(l){console.error("Error fetching flow traces:",l),A("Failed to fetch flow traces. Please try again later."),I([]),p("")}finally{j(!1)}})()},[n]);const C=i.useMemo(()=>{if(!D||!a)return null;const s=d=>{if(!d||!Array.isArray(d))return null;for(const o of d)if(o){if(o.id===D)return o;if(o.children&&Array.isArray(o.children)&&o.children.length>0){const m=s(o.children);if(m)return m}}return null},l=a.spans||[];return Array.isArray(l)?s(l):null},[D,a]),F=i.useMemo(()=>C?q(C):null,[C,q]),K=i.useMemo(()=>{if(!a)return[];const s=a.spans||[];return Array.isArray(s)?$(s):[]},[a]);i.useMemo(()=>{if(!a||!a.spans)return[];const s=a.spans.filter(l=>!l.parent_id||l.parent_id===a.id);return $(s)},[a]);const Q=()=>f?e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx(J,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Loading traces..."})]}):_?e.jsx("div",{className:"p-4 text-red-500",children:_}):S.length===0?e.jsx("div",{className:"p-4 text-gray-500 dark:text-gray-400",children:"No traces found."}):e.jsx("div",{className:"space-y-2",children:S.map(s=>e.jsxs("div",{className:`p-3 border rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 ${(a==null?void 0:a.id)===s.id?"border-primary bg-gray-50 dark:bg-gray-800":""}`,onClick:()=>{p(s.id),V(null)},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"font-medium",children:["Trace ",s.id.slice(0,7)]}),e.jsx(T,{variant:s.status==="completed"?"outline":s.status==="running"?"default":"destructive",className:s.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300":"",children:s.status})]}),e.jsxs("div",{className:"flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mt-1",children:[e.jsx("div",{children:k(s.start_time)}),e.jsx("div",{children:P(s.start_time,s.end_time)})]})]},s.id))}),W=e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Flows & Traces"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select a flow and trace to view details"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Flow"}),e.jsxs(ge,{onValueChange:N,value:n,children:[e.jsx(pe,{children:e.jsx(ve,{placeholder:"Select a flow"})}),e.jsx(be,{children:x.map(s=>e.jsx(we,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Traces"}),e.jsx(ne,{className:"h-[500px] border rounded-md",children:e.jsx("div",{className:"p-4",children:Q()})})]})]});return e.jsx(te,{rightSidebar:W,children:e.jsxs("div",{className:"w-full",children:[_&&e.jsxs(fe,{variant:"destructive",className:"mb-6",children:[e.jsx(he,{children:"Error"}),e.jsx(je,{children:_})]}),n&&e.jsx(re,{flowId:n}),a?e.jsxs(v,{children:[e.jsx(b,{children:e.jsx(w,{children:a.flow_name})}),e.jsx(y,{children:e.jsxs(ae,{defaultValue:"overview",value:H,onValueChange:G,className:"w-full",children:[e.jsxs(ie,{className:"grid grid-cols-3 mb-4",children:[e.jsxs(E,{value:"overview",className:"flex items-center gap-1",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{children:"Overview"})]}),e.jsx(E,{value:"methods",children:"Methods"}),e.jsx(E,{value:"events",children:"Events"})]}),e.jsx(L,{value:"overview",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs(v,{children:[e.jsxs(b,{className:"pb-2",children:[e.jsx(w,{className:"text-lg",children:"Timeline"}),e.jsx(M,{children:"Visualization of execution spans over time"})]}),e.jsx(y,{children:e.jsx(ce,{spans:K,onSpanClick:s=>V(s.id)})})]}),F&&e.jsxs(v,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(w,{className:"text-lg",children:"Span Details"})}),e.jsx(y,{children:F&&e.jsx(de,{span:F})})]}),e.jsxs(v,{children:[e.jsx(b,{className:"pb-2",children:e.jsx(w,{className:"text-lg",children:"Flow Summary"})}),e.jsx(y,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Methods"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"text-lg",variant:"outline",children:((O=a.spans)==null?void 0:O.filter(s=>s.parent_id===a.id).length)||0}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total methods"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Status"}),e.jsx(T,{className:U(a.status),variant:"outline",children:a.status})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium",children:"Duration"}),e.jsx("div",{className:"text-sm",children:P(a.start_time,a.end_time)})]})]})})]})]})}),e.jsx(L,{value:"methods",children:e.jsxs(v,{children:[e.jsxs(b,{className:"pb-2",children:[e.jsx(w,{className:"text-lg",children:"Methods"}),e.jsx(M,{children:"Flow execution methods and their details"})]}),e.jsx(y,{children:e.jsx("div",{className:"space-y-4",children:e.jsx(oe,{type:"single",collapsible:!0,className:"w-full",children:(B=a.spans)==null?void 0:B.filter(s=>s.parent_id===a.id).map(s=>e.jsxs(me,{value:s.id,children:[e.jsx(ue,{className:"hover:bg-muted px-4",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:U(s.status),variant:"outline",children:s.status}),e.jsx("span",{className:"ml-2 font-medium",children:s.name})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:P(s.start_time,s.end_time)})]})}),e.jsxs(xe,{className:"px-4 py-2 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Method ID"}),e.jsx("div",{className:"text-sm font-mono",children:s.id}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Start Time"}),e.jsx("div",{children:k(s.start_time)}),s.end_time&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"End Time"}),e.jsx("div",{children:k(s.end_time)})]})]}),s.attributes&&Object.keys(s.attributes).length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"text-sm font-medium mb-2",children:"Attributes"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded-md overflow-auto max-h-[200px]",children:JSON.stringify(s.attributes,null,2)})]})]})]},s.id))})})})]})}),e.jsx(L,{value:"events",children:e.jsxs(v,{children:[e.jsxs(b,{className:"pb-2",children:[e.jsx(w,{className:"text-lg",children:"Events"}),e.jsx(M,{children:"Flow execution events and their details"})]}),e.jsx(y,{children:e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"border rounded-md divide-y",children:(z=a.spans)==null?void 0:z.flatMap(s=>s.events||[]).map((s,l)=>e.jsxs("div",{className:"p-3 hover:bg-muted",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(T,{variant:"outline",children:s.name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:k(s.timestamp)})]}),s.attributes&&Object.keys(s.attributes).length>0&&e.jsx("div",{className:"mt-2 text-xs font-mono bg-muted p-2 rounded",children:JSON.stringify(s.attributes,null,2)})]},l))})})})]})})]})})]}):f?e.jsx("div",{className:"flex justify-center items-center p-8",children:e.jsx(J,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"text-center p-8 text-gray-500",children:"Select a flow and trace to view details"})]})})});export{Oe as default,Ve as meta};
