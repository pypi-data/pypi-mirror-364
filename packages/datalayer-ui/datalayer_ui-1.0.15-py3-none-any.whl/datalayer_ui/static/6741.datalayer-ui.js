"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[6741],{31335:(e,t,n)=>{n.d(t,{I:()=>w});var s=n(9387),a=n(85181),o=n(80736),i=n(27102),l=n(39821),r=n(58078),c=n(80006),d=n(15115),u=n(84514),h=n(81396),m=n(58875),p=n(36008),g=n(50596),_=n(38621),f=n(63948),x=n(72870),b=n(59651),v=n(73897),y=n(86178),C=n(18683);const k=25;function w(e){const{disabled:t,display:n,filterKernel:w,multiServiceManager:j,postActions:S,preActions:E,preference:R,runtimeDesc:A,sessionContext:I,setRuntimeDesc:M,translator:N,variant:T}=e,[D,O]=(0,s.useState)((0,y.N)(j,R?.id,N,w,T)),P=(0,s.useMemo)(()=>(N??a.wK).load("jupyterlab"),[N]),[$,F]=(0,s.useState)(!1),K={maxHeight:"large",width:"cell"===T?"small":"auto"};return(0,s.useEffect)(()=>{if(I&&D){const e=I.session?.kernel?.id;e&&Object.entries(D).forEach(([t,n])=>{n.forEach(t=>{t.kernelId===e&&M(t)})})}F(!0)},[D]),(0,C.jsx)(C.Fragment,{children:"menu"===n?(0,C.jsxs)(d.W,{children:["cell"===T?(0,C.jsx)(d.W.Anchor,{children:(0,C.jsx)(m.K,{disabled:t||null===D,icon:()=>(0,C.jsx)("span",{className:"dla-Cell-runtime-icon",children:(0,C.jsx)(_.GQJ,{})}),"aria-label":P.__("Assign a Runtime to the Cell."),title:P.__("Assign a Runtime to the Cell."),size:"small",variant:"invisible"})}):(0,C.jsxs)(d.W.Button,{variant:"default",disabled:t||null===D,children:[(0,C.jsx)(c.A,{fontWeight:"bold",children:P.__("Runtime:")})," "+(A?.displayName??P.__("No Runtime"))]}),(0,C.jsx)(d.W.Overlay,{...K,width:"medium",sx:{overflowY:"auto"},side:"cell"===T?"outside-left":"outside-right",children:(0,C.jsxs)(o.l,{selectionVariant:"single",children:["cell"===T&&(0,C.jsxs)(o.l.Item,{selected:void 0===A,onSelect:()=>{M(void 0)},children:[R?.location&&(0,C.jsx)(o.l.LeadingVisual,{children:"local"===R.location?(0,C.jsx)(x.A,{}):"browser"===R.location?(0,C.jsx)(f.A,{}):(0,C.jsx)(p.A,{})}),P.__("Assign the Notebook Runtime")]},"null"),!!E&&E,Object.entries(D??{}).map(([e,t])=>(0,C.jsxs)(o.l.Group,{children:[(0,C.jsx)(o.l.GroupHeading,{children:e}),t.map(e=>{const t=e.podName?` - ${e.podName.split("-",2).reverse()[0]}`:e.kernelId?` - ${e.kernelId}`:"",n=(e.displayName??"")+t,s=(e.displayName?.length??0)>k?e.displayName.slice(0,k)+"â€¦":e.displayName??"";return(0,C.jsxs)(o.l.Item,{title:n,selected:(e.location===e?.location||(0,v.R)(e.location)&&(0,v.R)(e?.location??"local"))&&(e.kernelId??e.name)===(e?.kernelId??e?.name),onSelect:()=>{M(e)},children:[(0,C.jsx)(o.l.LeadingVisual,{children:"local"===e.location?(0,C.jsx)(x.A,{}):"browser"===e.location?(0,C.jsx)(f.A,{}):(0,C.jsx)(p.A,{})}),s+t.slice(0,10)]},e.name)})]},e)),!!S&&(0,C.jsxs)(C.Fragment,{children:[(0,C.jsx)(o.l.Divider,{}),S]})]})})]}):(0,C.jsxs)(C.Fragment,{children:[$&&(0,C.jsx)(h.A,{name:"kernel-options","aria-labelledby":"kernel-options",children:Object.entries(D??{}).map(([e,t])=>(0,C.jsxs)(g.a,{children:[(0,C.jsx)(g.a,{as:"h4",style:{marginTop:0},children:e}),t.map(e=>(0,C.jsxs)(g.a,{title:e.name,children:[(0,C.jsxs)(u.A,{children:[(0,C.jsx)(l.A,{value:e.kernelId,onChange:()=>{M(e)},checked:(e.location===e?.location||(0,v.R)(e.location)&&(0,v.R)(e?.location??"local"))&&(e.kernelId??e.name)===(A?.kernelId??A?.name)}),(0,C.jsx)(u.A.Label,{children:(0,C.jsxs)(g.a,{display:"flex",children:[(0,C.jsx)(g.a,{children:e.displayName}),e.kernelId&&"remote"===e.location&&(0,C.jsx)(g.a,{ml:3,mt:1,children:(0,C.jsx)(b.m,{kernelId:e.kernelId,serviceManager:j.remote},"credits-indicator")})]})}),(0,C.jsx)(u.A.Caption,{children:(0,C.jsxs)(r.A,{sx:{marginTop:1},children:[(0,C.jsx)(i.A,{variant:"secondary",children:e.name}),(0,C.jsx)(i.A,{variant:"secondary",sx:{marginLeft:1},children:e.location}),e.burningRate&&(0,C.jsxs)(i.A,{variant:"sponsors",sx:{marginLeft:1},children:[e.burningRate," credits/second"]}),e.gpu&&(0,C.jsx)(i.A,{variant:"success",sx:{marginLeft:1},children:"GPU"})]})})]}),(0,C.jsx)(o.l.Divider,{})]},e.kernelId))]},e))}),!!S&&(0,C.jsx)(C.Fragment,{children:S})]})})}},33574:(e,t,n)=>{n.d(t,{YN:()=>_,zl:()=>m});var s=n(9387),a=n(85181),o=n(88037),i=n(72490),l=n(58875),r=n(38621),c=n(50596),d=n(73425),u=n(18683);function h(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){const{model:t}=e,[n,a]=(0,s.useState)(!1),[o,i]=(0,s.useState)(!1),h=(0,s.useCallback)(()=>{a(!1)},[]);return(0,s.useEffect)(()=>{const e=e=>{const t=e.getMetadata("datalayer")??{};i(!!t.kernel)};return e(t),t.metadataChanged.connect(e),()=>{t.metadataChanged.disconnect(e)}},[t]),o?(0,u.jsxs)(c.a,{className:"dla-Cell-variables-icon",children:[(0,u.jsx)(l.K,{style:{color:"var(--jp-brand-color1)",width:"33px",marginTop:"-2px"},icon:r.HGl,"aria-label":"Set variables to transfer between Runtimes",variant:"invisible",size:"small",title:"Set variables to transfer between Runtimes",onClick:e=>{e.preventDefault(),a(!0)}}),n&&(0,u.jsx)(d.m,{...e,onClose:h})]}):(0,u.jsx)(u.Fragment,{})}class p{constructor(e,t){this.commands=t,h(this,"_isDisposed",!1),h(this,"_cellActions",new WeakMap),h(this,"_panel",void 0),this._panel=e,this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this)})}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,i.Signal.clearData(this))}updateConnectedCell(e,t){t.oldValues.forEach(e=>{this._removeAction(e)}),Promise.all(t.newValues.map(e=>this._addAction(e)))}async _addAction(e){const t=this._panel.content.widgets.find(t=>t.model===e);if("code"===t?.model.type){await t.ready;const n=o._Q.create((0,u.jsx)(m,{model:t.model,preference:this._panel.sessionContext?{id:this._panel.sessionContext.session?.kernel?.id,language:this._panel.sessionContext.specsManager.specs?.kernelspecs[this._panel.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:this._panel.sessionContext,translator:this._panel.translator}));n.addClass("dla-Cell-action"),this._cellActions.has(e)&&this._cellActions.get(e)?.dispose(),this._cellActions.set(e,t),this._panel.disposed.connect(()=>{this._cellActions.delete(e),n.dispose()}),t.layout.addWidget(n)}}_removeAction(e){this._cellActions.get(e)?.dispose()}}class g{constructor(e){this.commands=e,h(this,"_extensions",new WeakMap)}createNew(e,t){const n=new p(e,this.commands);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}}const _={id:"@datalayer/ui:runtimes:cell-action",description:"Cell action item",optional:[a.sQ],autoStart:!1,activate:(e,t)=>{e.docRegistry.addWidgetExtension("Notebook",new g(e.commands))}}},51009:(e,t,n)=>{n.d(t,{J:()=>d});var s={};function a(){return"\ndef _list_variables():\n    import json\n    from types import BuiltinFunctionType, BuiltinMethodType, FunctionType, MethodType, MethodWrapperType, ModuleType, TracebackType\n\n    _FORBIDDEN_TYPES = [type, BuiltinFunctionType, BuiltinMethodType, FunctionType, MethodType, MethodWrapperType, ModuleType, TracebackType]\n    try:\n        from IPython.core.autocall import ExitAutocall\n        _FORBIDDEN_TYPES.append(ExitAutocall)\n    except ImportError:\n        pass\n    _exclude = tuple(_FORBIDDEN_TYPES)\n\n    _all = frozenset(globals())\n    _vars = {}\n    for _n in _all:\n        _v = globals()[_n]\n        \n        if not (\n            _n.startswith('_') or\n            isinstance(_v, _exclude) or\n            # Special IPython variables\n            (_n == 'In' and isinstance(_v, list)) or\n            (_n == 'Out' and isinstance(_v, dict))\n        ):\n            _vars[_n] = type(_v).__qualname__\n\n    return json.dumps(_vars)\n\n_list_variables()"}function o(e){return`\ndef _pickle_variables():\n    from base64 import encodebytes\n    import json\n    import pickle\n    _names = {${e.map(e=>`"${e}"`).join(",")}}\n    _data = {}\n    for _n in _names:\n        try:\n            _v = globals()[_n]\n            dump = pickle.dumps(_v)\n            _data[_n] = encodebytes(dump).decode("ascii")\n        except:\n            ...\n\n    return json.dumps(_data)\n\n_pickle_variables()\n`}function i(e){return`\ndef _load_variables():\n    from base64 import decodebytes\n    import json\n    import pickle\n    _data = json.loads(${e})\n    _loaded = []\n    for _n, _v in _data.items():\n        try:\n            dump = decodebytes(_v.encode("ascii"))\n            globals()[_n] = pickle.loads(dump)\n            _loaded.append(_n)\n        except:\n            ...\n    return json.dumps(_loaded)\n\n_load_variables()\n`}function l(e){return`\ndef _change_current_directory():\n    import os\n    from pathlib import Path\n    _local_content_mount_point = Path(Path.home() / ${e.split("/").map(e=>`"${e}"`).join(" / ")})\n    _local_content_mount_point.mkdir(parents=True, exist_ok=True)\n    os.chdir(_local_content_mount_point)\n\n    assert Path.cwd() == _local_content_mount_point\n\n_change_current_directory()\n`}function r(e){return Array.from(e.matchAll(/^((?<output>[A-z][\w]*)\s*=[^=]|\((?<walrus>[A-z][\w]*)\s*:=[^=)]+\))/gm)).map(e=>e.groups?.output??e.groups?.walrus??"").filter(e=>!!e)}function c(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(s),n.d(s,{changeCurrentWorkingDirectory:()=>l,getOutputCandidates:()=>r,listVariables:()=>a,loadVariables:()=>i,saveVariables:()=>o});class d{static register(e,t){this.$language.set(e,t)}static supports(e){return this.$language.has(e)}constructor(e){if(c(this,"_language",void 0),!d.$language.has(e))throw new Error(`${e} is not supported.`);this._language=e}get language(){return this._language}changeCurrentWorkingDirectory(e){return d.$language.get(this.language).changeCurrentWorkingDirectory(e)}listVariables(){return d.$language.get(this.language).listVariables()}loadVariables(e){return d.$language.get(this.language).loadVariables(e)}saveVariables(e){return d.$language.get(this.language).saveVariables(e)}getOutputCandidates(e){return d.$language.get(this.language).getOutputCandidates(e)}}c(d,"$language",new Map),d.register("python",s)},66741:(e,t,n)=>{n.d(t,{zg:()=>pe,dU:()=>ge,wj:()=>me});var s=n(59179),a=n(51671),o=n(89460),i=n(5279),l=n(69584),r=n(88037),c=n(14809),d=n(30260),u=n(9387),h=n(85181),m=n(80736),p=n(36008),g=n(93904),_=n(44536),f=n(320),x=n(73897),b=n(51009),v=n(98754),y=n(84514),C=n(92664),k=n(80006),w=n(55682),j=n(21438),S=n(18683);function E(e){const{model:t,onClose:n,language:s,snippets:a,markdownParser:o,sanitizer:i,translator:l}=e,[r,c]=(0,u.useState)(a[0]),d=(0,u.useMemo)(()=>(l??h.wK).load("jupyterlab"),[l]),m=(0,u.useCallback)(e=>{const t=e.target.value;c(a[parseInt(t,10)])},[c,a]),p=(0,u.useCallback)(()=>{const e=t.sharedModel.getSource().length;t.sharedModel.updateSource(e,e,"\n".repeat(e?2:0)+r.code),n()},[t,r,n]);return(0,S.jsx)(w.l,{title:"Pick a snippet to inject",onClose:n,footerButtons:[{buttonType:"default",content:d.__("Cancel"),onClick:n},{buttonType:"primary",content:d.__("Inject snippet"),onClick:p,autoFocus:!0}],children:(0,S.jsx)(v.A,{as:"form",children:(0,S.jsxs)(y.A,{children:[(0,S.jsx)(y.A.Label,{}),(0,S.jsx)(C.A,{block:!0,onChange:m,children:a.map((e,t)=>(0,S.jsx)(C.A.Option,{value:`${t}`,children:e.title},t))}),(0,S.jsxs)(y.A.Caption,{children:[r.description&&(0,S.jsx)(k.A,{as:"p",children:r.description}),o?(0,S.jsx)(j.o,{markdownParser:o,sanitizer:i,text:`\`\`\`${s}\n${r.code}\`\`\``}):(0,S.jsx)("code",{children:r.code})]})]})})})}var R=n(50787),A=n(31335),I=n(73425);function M(e){const{logIn:t,markdownParser:n,model:s,preference:a,sanitizer:o,multiServiceManager:i,sessionContext:l,translator:r}=e,{token:c}=(0,_.Y)(),{configuration:d}=(0,f._O)(),[v,y]=(0,u.useState)(!1),[C,k]=(0,u.useState)(!1),[w,j]=(0,u.useState)(!1),[M,N]=(0,u.useState)(!1),[T,D]=(0,u.useState)(""),[O,P]=(0,u.useState)([]),[$,F]=(0,u.useState)(!1),K=(0,u.useMemo)(()=>(r??h.wK).load("jupyterlab"),[r]);(0,u.useEffect)(()=>{const e=e=>{const t=(e.getMetadata("datalayer")??{}).kernel;y(!!t),k(!1===t?.params?.notebook);const n=new Array;if(t){const e=i.remote?.environments.get().find(e=>e.name===t.name);D(e?.language??""),e?.snippets&&n.push(...e.snippets)}P(n)};return e(s),s.metadataChanged.connect(e),()=>{s.metadataChanged.disconnect(e)}},[s]);const U=(0,u.useCallback)(e=>!!e.kernelId&&(0,x.R)(e.location)&&(!a?.language||e.language===a?.language),[a]),V=(0,u.useCallback)(e=>{const t=s.getMetadata("datalayer")??{kernel:void 0};e?s.setMetadata("datalayer",Object.assign(t,{kernel:e})):(delete t.kernel,s.setMetadata("datalayer",t))},[s]),W=(0,u.useCallback)(()=>{N(!1)},[]),G=(0,u.useCallback)(()=>{N(!0)},[]),L=(0,u.useCallback)(()=>{F(!1)},[]),H=(0,u.useCallback)(()=>{F(!0)},[]),z=(0,u.useCallback)(()=>{j(!0)},[]),B=(0,u.useCallback)(e=>{e&&(e.params={...e.params,notebook:!1},V(e)),j(!1)},[V]),J=s.getMetadata("datalayer")??{};return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(A.I,{display:"menu",filterKernel:U,preference:a,multiServiceManager:i,runtimeDesc:J.kernel?J.kernel:void 0,setRuntimeDesc:V,variant:"cell",preActions:(0,S.jsxs)(m.l.Item,{disabled:!i.remote,onSelect:z,selected:C,title:i.remote?"Assign a new temporary Runtime on each Cell execution.":"You are not connected with Datalayer.",children:[(0,S.jsx)(m.l.LeadingVisual,{children:(0,S.jsx)(p.A,{})}),K.__("Assign a Cell Runtime")]}),postActions:c||!t?(0,S.jsxs)(S.Fragment,{children:[b.J.supports(a?.language??"")&&(0,S.jsx)(m.l.Item,{onSelect:G,disabled:!v,title:K.__("Define variables to transfer between the document kernel and the cell kernel."),children:K.__("Define Cell Variables Transfer")}),!d.whiteLabel&&(0,S.jsx)(m.l.Item,{onSelect:H,disabled:0===O.length,title:K.__("Inject a code snippet at the end of the cell."),children:K.__("Inject Code Snippet")})]}):(0,S.jsx)(m.l.Item,{onSelect:e.logIn,title:"Connect to the Runtime provider.",children:(0,S.jsx)(g.v,{message:"Connect to the Runtime provider"})}),translator:r}),M&&(0,S.jsx)(I.m,{model:s,onClose:W,preference:a,sessionContext:l,translator:r}),$&&(0,S.jsx)(E,{language:T,model:s,snippets:O,onClose:L,markdownParser:n,sanitizer:o}),w&&(0,S.jsx)(R.s,{manager:i.remote,onSubmit:B,startKernel:!1,markdownParser:n,sanitizer:o})]})}var N=n(72870),T=n(63948),D=n(94064),O=n(77544),P=n(98238),$=n(72490),F=n(63279),K=n(63806),U=n(80547),V=n(97734),W=n(2335),G=n(55881),L=n(63711),H=n(38921),z=n(36848),B=n(94247),J=n(93426),Q=n(26690);function q(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Y=new WeakMap;class X{static getRemoteCell(e){return Y.get(e)}static run(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const a=Z.getState(e),o=Z.runSelected(e,t,n,s);return Z.handleRunState(e,a,!1),o}static runCells(e,t,n,s,a){if(!e.model)return Promise.resolve(!1);const o=Z.getState(e),i=Z.runCells(e,t,n,s,a);return Z.handleRunState(e,o,!1),i}static runAll(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const a=Z.getState(e),o=e.widgets.length,i=Z.runCells(e,e.widgets,t,n,s);return e.activeCellIndex=o,e.deselectAll(),Z.handleRunState(e,a,!0),i}static runAllAbove(e,t,n,s){const{activeCell:a,activeCellIndex:o,model:i}=e;if(!i||!a||o<1)return Promise.resolve(!1);const l=Z.getState(e),r=Z.runCells(e,e.widgets.slice(0,e.activeCellIndex),t,n,s);return e.deselectAll(),Z.handleRunState(e,l,!0),r}static runAllBelow(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const a=Z.getState(e),o=e.widgets.length,i=Z.runCells(e,e.widgets.slice(e.activeCellIndex),t,n,s);return e.activeCellIndex=o,e.deselectAll(),Z.handleRunState(e,a,!0),i}static async runAndAdvance(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const a=Z.getState(e),o=Z.runSelected(e,t,n,s),i=e.model;return e.activeCellIndex===e.widgets.length-1?(i.sharedModel.insertCell(e.widgets.length,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,L.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit"):e.activeCellIndex++,Z.handleRunState(e,a,!0),o}static async runAndInsert(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const a=Z.getState(e),o=Z.runSelected(e,t,n,s);return e.model.sharedModel.insertCell(e.activeCellIndex+1,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,L.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit",Z.handleRunState(e,a,!0),o}}q(X,"serviceManager",null);let Z,ee=function(e){return e[e.QUEUED=0]="QUEUED",e[e.STARTING_KERNEL=1]="STARTING_KERNEL",e[e.IMPORTING=2]="IMPORTING",e[e.EXECUTING=3]="EXECUTING",e[e.EXPORTING=4]="EXPORTING",e[e.UNKNOWN=5]="UNKNOWN",e[e.DONE=6]="DONE",e[e.ERROR=7]="ERROR",e}({});class te{constructor({cell:e,sessionContext:t,metadata:n}){q(this,"cell",void 0),q(this,"sessionContext",void 0),q(this,"metadata",void 0),this.cell=e,this.sessionContext=t,this.metadata=n}get connection(){return this.sessionContext?.session?.kernel??void 0}failedExecution(e){this.cell.setPrompt("")}cancelExecution(){this.cell.setPrompt("")}scheduleExecution(){this.cell.model.sharedModel.transact(()=>{this.cell.model.clearExecution()},!1),this.cell.model.sharedModel.getSource().trim()&&this.cell.setPrompt("*")}processCell(){return Promise.resolve(!1)}}class ne extends te{constructor(e){super(e),q(this,"_connection",void 0),q(this,"_reason",null),q(this,"_isDisposed",!1),q(this,"_runtimeDesc",void 0),q(this,"_processed",null),q(this,"_state",ee.QUEUED),q(this,"_stateChanged",new $.Signal(this)),q(this,"_variablesIn",void 0),q(this,"_variableOut",void 0);const t=this.cell.model.getMetadata("datalayer")??{};this._runtimeDesc=t.kernel,this._variablesIn=Array.isArray(t.in)?t.in:[],this._variableOut="string"==typeof t.out?t.out:""}get connection(){return this._connection}get isDisposed(){return this._isDisposed}get reason(){return this._reason}get state(){return this._state}setState(e,t){this._state===e&&this._reason===t||(this._reason=t??null,this._state=e,this._stateChanged.emit(this._state))}get stateChanged(){return this._stateChanged}failedExecution(e){super.failedExecution(),this.setState(ee.ERROR,e)}cancelExecution(){super.cancelExecution(),this.setState(ee.ERROR)}scheduleExecution(){super.scheduleExecution(),this.setState(ee.QUEUED)}dispose(){this._isDisposed||(this._isDisposed=!0,this._connection?.dispose(),$.Signal.clearData(this))}async processCell(){let e;await this.setupKernel();try{this._processed=new P.PromiseDelegate,this._processCell().then(e=>{this._processed?.resolve(e)}).catch(e=>{this._processed?.reject(e)}),e=await this._processed.promise}finally{await this.teardownKernel()}return e}async _processCell(){if(!this._connection){const e=`Failed to process a remote cell '${this.cell.model.id}'.`;throw this.setState(ee.ERROR,e),new Error(e)}if(this._variablesIn.length){if(!this.sessionContext){const e="Unable to import variables; no document kernel available.";throw this.setState(ee.ERROR,e),new Error(e)}this.setState(ee.IMPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await se(e.language,this.sessionContext.session.kernel,this._variablesIn,this._connection)){const e=`Failed to transfer ${this._variablesIn.join(", ")} to ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(ee.ERROR,e),new Error(e)}}this.setState(ee.EXECUTING);const e=await G.Yr.execute(this.cell,{session:{kernel:this._connection}},this.metadata);if(console.debug(`@datalayer/ui:runtimes: Capture cell ${this.cell.model.id} execution`,e),this.metadata.deletedCells&&(this.metadata.deletedCells.length=0),!e)return!1;if("ok"===e.content.status){if(this._variableOut){if(!this.sessionContext){const e="Unable to export variables; no document kernel available.";throw this.setState(ee.ERROR,e),new Error(e)}this.setState(ee.EXPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await se(e.language,this._connection,[this._variableOut],this.sessionContext.session.kernel)){const e=`Failed to transfer ${this._variableOut} from ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(ee.ERROR,e),new Error(e)}}return this.setState(ee.DONE),!0}throw this.setState(ee.ERROR),new a.id(e.content)}async setupKernel(){if(!X.serviceManager){const e="No service manager available";throw this.setState(ee.ERROR,e),new Error(e)}this.setState(ee.STARTING_KERNEL),this._connection&&(this._connection.id===this._runtimeDesc.kernelId&&this._connection.name===this._runtimeDesc.name&&(this._connection.location??"local")===runtimeDescription.location||this._connection.dispose(),this._connection.isDisposed&&(this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0));const e=!1!==this._runtimeDesc.params?.notebook;switch(this._connection?.status){case"idle":case"busy":case"autorestarting":case"restarting":case"starting":break;default:{this._connection?.dispose(),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0;const t=(0,x.R)(this._runtimeDesc.location)?X.serviceManager.remote?.runtimesManager:X.serviceManager[this._runtimeDesc.location]?.kernels;if(e&&this._runtimeDesc.kernelId)try{this._connection=t?.connectTo({model:{id:this._runtimeDesc.kernelId,name:this._runtimeDesc.name},handleComms:!0})}catch(e){if(!e||"Unable to find the kernel."!==e.message)throw e;console.log(`Persistent kernel ${this._runtimeDesc.kernelId} does not exist. Starting a new one...`)}if(!this._connection)try{const{credits:n}=_.J7.getState(),{configuration:s,runtimeModels:a}=Q.LH.getState(),o=(n?.available??0)/Math.max(s.maxCellRuntimes-a.filter(e=>"cell"===e.type).length,1);if(o<J.c)throw new Error("You do not have enough credits to start a Cell Remote Runtime.");this._connection=await(t?.startNew({environmentName:this._runtimeDesc.name,type:e?"notebook":"cell",creditsLimit:o,capabilities:this._runtimeDesc.params?.capabilities},{handleComms:!0}))}catch(t){if(503===t.response?.status)(0,W.f1)("Unable to create a new remote kernel",`No kernel available for environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please try again later.`);else if("MaxRuntimesExceededError"===t.name){if(!e){const e=new P.PromiseDelegate,t=window.setTimeout(()=>{e.reject("Timeout")},3e5),n=Q.LH.subscribe(t=>{t.runtimeModels.filter(e=>"cell"===e.type).length<t.configuration.maxCellRuntimes&&e.resolve()});try{return this.setState(ee.STARTING_KERNEL,"Waiting for a cell kernel to stopâ€¦"),await e.promise,clearTimeout(t),this.setupKernel()}catch(e){console.log("Waiting for free kernel slot expired.")}finally{n()}}(0,W.f1)("Unable to create a new remote kernel",`${t.message} Cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}' cannot be executed.`)}else 404===t.response?.status&&(0,W.f1)("Unable to create a new remote kernel",`Unknown environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please select an existing environment.`);throw this.setState(ee.ERROR,"string"==typeof t?t:t.message??"Unable to start a kernel"),t}this._connection&&(this._connection?.connectionStatusChanged.connect(this.onConnectionChanged,this),this._connection?.statusChanged.connect(this.onKernelStatusChanged,this),this._connection.location=this._runtimeDesc.location,e&&(this._runtimeDesc.kernelId=this._connection.id,this.cell.model.setMetadata("datalayer",Object.assign(this.cell.model.getMetadata("datalayer")??{},{kernel:this._runtimeDesc}))))}}if(!this._connection){const e=`Unable to start a kernel for cell ${this.cell.model.id} with ${JSON.stringify(this._runtimeDesc)}`;throw this.setState(ee.ERROR,e),new Error(e)}}async teardownKernel(){!1===this._runtimeDesc.params?.notebook&&(this._connection&&!this._connection.isDisposed&&((0,x.R)(this._runtimeDesc.location)?X.serviceManager.remote.runtimesManager.shutdown(this._connection.id):this._connection.shutdown(),this._connection.dispose()),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0)}onConnectionChanged(){"disconnected"===this._connection?.connectionStatus&&this._processed?.reject("Kernel has been disconnected")}onKernelStatusChanged(){["dead","terminating"].includes(this._connection?.status??"")&&this._processed?.reject(`Kernel status '${this._connection?.status}' is not appropriate`)}}async function se(e,t,n,s){const a=new b.J(e),o=a.saveVariables(n),i=await new z.D({connection:t}).execute(o),l=i.get(0)?.data["text/plain"]??"";if(!l)return!1;{const e=a.loadVariables(l),t=await new z.D({connection:s}).execute(e),o=t.get(0)?.data["text/plain"]||"[]",i=JSON.parse(o.slice(1,o.length-1));if(!n.every(e=>i.includes(e)))return!1;console.debug(`Successfully transfered ${n.join(", ")}`)}return!0}function ae(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){const t=a.Ft.executed,n=a.Ft.executionScheduled,s=a.Ft.selectionExecuted;async function o(e,o,r,c,d){const u=o[-1];e.mode="command";try{const m=await Promise.all(o.map(s=>async function(e,s,o,r,c){const d=await async function({notebook:e,cell:s,sessionContext:a}){if("code"!==s.model.type)return!1;const o={deletedCells:e.model?.deletedCells??[],recordTiming:e.notebookConfig.recordTiming},r=!!(s.model.getMetadata("datalayer")??{}).kernel,c=new(r?ne:te)({cell:s,sessionContext:a,metadata:o});if(r){Y.set(s.model,c);const e=()=>{Y.delete(s.model),c.dispose()};s.disposed.connect(e),a?.disposed.connect(e)}return async function(e,s){const a=new P.PromiseDelegate;i.has(e)||i.set(e,[]);const o=i.get(e),r=0===o.length;return n.emit({notebook:e,cell:s.cell}),s.scheduleExecution(),o.push({cell:s,done:a}),r&&l(o).catch(e=>{console.error("Fail to start processing the cell queue",e)}),a.promise.then(()=>{t.emit({notebook:e,cell:s.cell,success:!0})}).catch(n=>{t.emit({notebook:e,cell:s.cell,success:!1,error:n})}),a.promise}(e,c)}({notebook:e,cell:s,sessionContext:o});if(d)return!0;const u=(c=c||h.wK).load("jupyterlab");switch(s.model.type){case"markdown":s.rendered=!0,s.inputHidden=!1,t.emit({notebook:e,cell:s,success:!0});break;case"code":if(o){if(o.isTerminating){await(0,W.ui)({title:u.__("Kernel Terminating"),body:u.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",o.session?.path),buttons:[W.lG.okButton()]});break}if(o.pendingInput)return await(0,W.ui)({title:u.__("Cell not executed due to pending input"),body:u.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[W.lG.okButton()]}),!1;if(o.hasNoKernel&&await o.startKernel()&&r&&await r.selectKernel(o),o.hasNoKernel)return s.model.sharedModel.transact(()=>{s.model.clearExecution()}),!0;const i=e.model?.deletedCells??[];n.emit({notebook:e,cell:s});let l=!1;try{const t={deletedCells:i,recordTiming:e.notebookConfig.recordTiming};console.debug(`@datalayer/ui:runtimes: Processing normally cell ${s.model.id}`);const n=s.model.sharedModel.source;if((0,B.ZP)(s)){const e=s.model.getMetadata("datalayer").datasource,t=e.variant??"",a=e.database??"",o=e.outputBucket??"",i=e.destinationVar??"";s.model.sharedModel.setSource(`%%${t} ${a} ${o} ${i}\n\n${n}`),s.model.sharedModel.setMetadata("editable",!1)}const r=await G.Yr.execute(s,o,t).finally(()=>{(0,B.ZP)(s)&&(s.model.sharedModel.setSource(n),s.model.sharedModel.setMetadata("editable",!0))})??void 0;i.splice(0,i.length),l=(()=>{if(s.isDisposed)return!1;if(!r)return!0;if("ok"===r.content.status){const t=r.content;return t.payload&&t.payload.length&&function(e,t,n){const s=e.payload?.filter(e=>"set_next_input"===e.source)[0];if(!s)return;const a=s.text;if(s.replace)return void n.model.sharedModel.setSource(a);const o=t.model.sharedModel,i=t.model.cells,l=(0,H.findIndex)(i,e=>e===n.model);-1===l?o.insertCell(o.cells.length,{cell_type:"code",source:a,metadata:{trusted:!1}}):o.insertCell(l+1,{cell_type:"code",source:a,metadata:{trusted:!1}})}(t,e,s),!0}throw new a.id(r.content)})()}catch(n){if(!s.isDisposed&&!n.message.startsWith("Canceled"))throw t.emit({notebook:e,cell:s,success:!1,error:n}),n;l=!1}return l&&t.emit({notebook:e,cell:s,success:!0}),l}s.model.sharedModel.transact(()=>{s.model.clearExecution()},!1)}return Promise.resolve(!0)}(e,s,r,c,d)));return!e.isDisposed&&(s.emit({notebook:e,lastCell:u}),e.update(),m.every(e=>e))}catch(t){if(!t.message||!t.message.startsWith("KernelReplyNotOK"))throw t;return o.map(e=>{"code"===e.model.type&&null===e.model.executionCount&&e.setPrompt("")}),s.emit({notebook:e,lastCell:u}),e.update(),!1}}e.getState=function(e){return{wasFocused:e.node.contains(document.activeElement),activeCellId:e.activeCell?.model.id??null}},e.handleRunState=async function(e,t,n=!1){const{activeCell:s,activeCellIndex:a}=e;n&&s&&await e.scrollToItem(a,"smart",0).catch(e=>{}),(t.wasFocused||"edit"===e.mode)&&e.activate()},e.runCells=o,e.runSelected=function(e,t,n,s){e.mode="command";let a=e.activeCellIndex;const i=e.widgets.filter((t,n)=>{const s=e.isSelectedOrActive(t);return s&&(a=n),s});return e.activeCellIndex=a,e.deselectAll(),o(e,i,t,n,s)};const i=new WeakMap;async function l(e){const t=e[0];if(!t)return Promise.resolve();const{done:n,cell:s}=t;try{const t=await s.processCell();n.resolve(t),e.shift(),l(e).catch(e=>{console.error("Error processing cell queue")})}catch(t){for(s.failedExecution(t.message),n.reject(t),s===e[0]?.cell&&e.shift();e.length;){const{done:t,cell:n}=e.shift()??{};n?.cancelExecution(),t?.reject("Canceled")}}}}(Z||(Z={}));class oe{constructor(e){ae(this,"_isDisposed",!1),ae(this,"_cellFooters",new WeakMap),ae(this,"_cellResetters",new WeakMap),ae(this,"_panel",void 0),ae(this,"_settings",{dateFormat:"yyy-MM-dd HH:mm:ss",showDate:!0,showLiveExecutionTime:!0}),this._panel=e,this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this)}),this._panel.context.sessionContext.statusChanged.connect(this.onKernelStatusChanged,this)}get settings(){return this._settings}set settings(e){P.JSONExt.deepEqual(this._settings,e)||(this._settings=e,this.onCellsChanged(this._panel.context.model.cells,{type:"set",newIndex:0,newValues:Array.from(this._panel.context.model.cells),oldIndex:0,oldValues:Array.from(this._panel.context.model.cells)}))}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,$.Signal.clearData(this))}onKernelStatusChanged(e,t){["starting","restarting","autorestarting"].includes(t)&&this._panel.content.widgets.forEach(e=>{this._cellResetters.get(e.model)?.emit(void 0)})}onCellsChanged(e,t){t.oldValues.forEach(e=>{this._removeFooter(e)}),Promise.all(t.newValues.map(e=>this._addFooter(e)))}async _addFooter(e){if("code"===e.type){const t=this._panel.content.widgets.find(t=>t.model===e);if(t){await t.ready;const n=new $.Signal(this),s=r._Q.create((0,S.jsx)(d.o,{children:(0,S.jsx)(ce,{model:e,stateReset:n})}));this._cellFooters.has(e)&&this._cellFooters.get(e)?.dispose(),this._cellFooters.set(e,t),this._cellResetters.set(e,n);const a=()=>{this._cellFooters.delete(e),this._cellFooters.delete(e),s.dispose()};t.disposed.connect(a),this._panel.disposed.disconnect(a),c.x0.attach(s,t.inputArea.editorWidget.node)}}}_removeFooter(e){this._cellFooters.get(e)?.dispose()}}const ie=(e,t="yyy-MM-dd HH:mm:ss")=>(0,K.A)(e,t),le=(e,t)=>{const n=36e5,s=864e5;let a=(0,U.A)(e,t);if(a<1e3)return`${a}ms`;const o=Math.floor(a/s);a%=s;const i=Math.floor(a/n);a%=n;const l=Math.floor(a/6e4);a%=6e4;let r="";return o&&(r+=`${o}d `),(o||i)&&(r+=`${i}h `),(o||i||l)&&(r+=`${l}m `),o||(r+=`${(a/1e3).toFixed(i?0:2)}s`),r.trim()};class re{constructor(e,t){ae(this,"_tracker",void 0),ae(this,"_extensions",new WeakMap),ae(this,"_settings",{showLiveExecutionTime:!0,showDate:!0,dateFormat:"yyy-MM-dd HH:mm:ss"}),this._tracker=e,t&&t.load("@datalayer/ui:plugin").then(e=>{e&&(this._updateSettings(e),e.changed.connect(this._updateSettings.bind(this)),t.load("@jupyterlab/notebook-extension:tracker").then(e=>e.set("recordTiming",!0),e=>{console.error("@datalayer/ui: Could not force metadata recording.",e)}))}).catch(e=>{console.error("@datalayer/ui: Could not load settings",e)})}createNew(e,t){const n=new oe(e);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}_updateSettings(e){const t={showLiveExecutionTime:e.get("showLiveExecutionTime").composite,showDate:e.get("showDate").composite},n=e.get("dateFormat").composite,s=(e=>{const t=new Date;try{return(0,K.A)(t,e),{isValid:!0}}catch(e){return{isValid:!1,message:e.message}}})(n);s.isValid?t.dateFormat=n:(t.dateFormat="yyy-MM-dd HH:mm:ss",console.warn("Invalid date format in Execute Time extension setting",s.message??"")),this._settings={...this._settings,...t},this._tracker.forEach(e=>{const t=this._extensions.get(e);t&&(t.settings={...this._settings})})}}function ce(e){const{model:t,stateReset:n}=e,{enqueueToast:s}=(0,V.d)(),[o,i]=(0,u.useState)(""),[l,r]=(0,u.useState)(""),[c,d]=(0,u.useState)(null),[h,m]=(0,u.useState)(""),[p,g]=(0,u.useState)(""),[_,f]=(0,u.useState)(""),[x,b]=(0,u.useState)(X.getRemoteCell(t)??null),[v,y]=(0,u.useState)(ee.UNKNOWN),[C,k]=(0,u.useState)("");(0,u.useEffect)(()=>{const e=()=>{y(ee.UNKNOWN),k(""),b(null)};return n.connect(e),()=>{n.disconnect(e)}},[n]),(0,u.useEffect)(()=>{const e=()=>{const n=t.getMetadata("datalayer")?.kernel;let s="",a="";if(n){let e=N.A;switch(s=n.displayName??"Unknown kernel",a=`${s} running `,n.location){case"local":a+="locally.";break;case"browser":e=T.A,a+="in your browser.";break;default:!1===n.params?.notebook?(e=D.A,a+="remotely."):(e=O.A,a+="in a Notebook Remote Runtime.")}d(e?(0,u.createElement)(e,{title:n.location}):null),i(s),r(a)}else d(null),i(""),r("");const o=t.getMetadata("execution");if(!o||!P.JSONExt.isObject(o))return h&&m(""),p&&g(""),void(_&&f(""));const l=o["iopub.status.busy"],c=l?new Date(l):null,x=o["shell.execute_reply.started"]||o["iopub.execute_input"],b=x?new Date(x):null,v=o.execution_failed,y=o["shell.execute_reply"]??v,C=y?new Date(y):null,k=y&&!o["iopub.execute_input"],w=setInterval(()=>{if(h.startsWith("Execution started at")){if(t.getMetadata("execution").execution_failed)return clearInterval(w),void e();if(b){const e=le(new Date,b);g(`${e} ${_?`(${_})`:""}`)}}else clearInterval(w)},100);let j="";if(k)j="";else if(C&&b){const e=le(C,b);f(e),j=v?"Failed":"Last executed",j&&(j+=` at ${ie(C,"yyy-MM-dd HH:mm:ss")}`),j+=` in ${e}`}else b?j=`Execution started at ${ie(b,"yyy-MM-dd HH:mm:ss")}`:c&&(_&&g(`N/A (${_})`),j=`Execution queued at ${ie(c,"yyy-MM-dd HH:mm:ss")}`);h!==j&&m(j)},n=(e,{notebook:n,cell:s})=>{if(s.model===t){const e=X.getRemoteCell(t)??null;y(e?.state??ee.QUEUED),k(e?.state?"":"Queued"),b(e)}},o=(e,{notebook:n,cell:a,success:o,error:i})=>{if(a.model!==t)return;const l=o?ee.DONE:ee.ERROR;y(x?.state??l),k(x?.reason??""),x?.state===ee.ERROR&&s(x.reason??"Failed to execute cell on a remote kernel.",{variant:"error"})};return e(),t.metadataChanged.connect(e),"code"===t.type&&(a.Ft.executionScheduled.connect(n),a.Ft.executed.connect(o)),()=>{t.metadataChanged.disconnect(e),"code"===t.type&&(a.Ft.executionScheduled.disconnect(n),a.Ft.executed.disconnect(o))}},[t,x]),(0,u.useEffect)(()=>{const e=(e,t)=>{switch(y(t),t){case ee.QUEUED:k("Queued");break;case ee.ERROR:k(e.reason??"");break;case ee.EXECUTING:k("Runningâ€¦");break;case ee.EXPORTING:k("Exporting dataâ€¦");break;case ee.IMPORTING:k("Importing dataâ€¦");break;case ee.STARTING_KERNEL:k(e.reason??"Starting the kernelâ€¦");break;default:k("")}};return x?.stateChanged.connect(e),()=>{x?.stateChanged.disconnect(e)}},[x]);const w=!!c;let j=!1,E=100,R=w?"var(--jp-brand-color1)":"var(--jp-brand-color3)",A="var(--jp-brand-color1)",I="";switch(v){case ee.QUEUED:I="ðŸ’¤ï¸Ž",E=0;break;case ee.UNKNOWN:E=0;break;case ee.DONE:I="âœ”ï¸Ž",R=w?"var(--jp-success-color1)":"var(--jp-success-color3)",A="var(--jp-success-color1)";break;case ee.ERROR:I="âŒï¸Ž",R=w?"var(--jp-error-color1)":"var(--jp-error-color3)",A="var(--jp-error-color1)";break;case ee.EXECUTING:I="âš¡ï¸Ž",j=!0,E=40;break;case ee.EXPORTING:I="ðŸ“¤ï¸Ž",j=!0,E=90;break;case ee.IMPORTING:I="ðŸ“¥ï¸Ž",j=!0,E=30;break;case ee.STARTING_KERNEL:I="ðŸ”¥ï¸Ž",j=!0,E=20}const M=["dla-Cell-footer"];return w&&M.push("jp-mod-foreign"),(0,S.jsxs)("div",{className:M.join(" "),children:[(0,S.jsx)("div",{style:{minHeight:"3px"},children:v!==ee.UNKNOWN&&(0,S.jsx)(F.z,{sx:{maxHeight:"3px"},progress:E,bg:R,animated:j,barSize:"small"})}),(0,S.jsxs)("div",{children:[(0,S.jsx)("span",{style:{color:A},title:C||void 0,children:`${I} ${C}`.trimEnd()}),(0,S.jsx)("span",{children:t.getMetadata("execution")&&(0,S.jsx)(S.Fragment,{children:h})}),(0,S.jsxs)("span",{className:"dla-Cell-footer-runtime",title:l,children:[c,o]})]})]})}var de=n(50596),ue=n(71518),he=n(33574);const me=()=>{a.Ft.run=X.run,a.Ft.runAll=X.runAll,a.Ft.runAllAbove=X.runAllAbove,a.Ft.runAllBelow=X.runAllBelow,a.Ft.runAndAdvance=X.runAndAdvance,a.Ft.runAndInsert=X.runAndInsert,a.Ft.runCells=X.runCells},pe={id:"@datalayer/ui:runtimes:cell-executor",description:"Handle runtime code execution per cell.",requires:[ue.jU,o.fI],optional:[s.qe,i.co,s.zG],autoStart:!1,activate:(e,t,n,s,a,o)=>{X.serviceManager=t,me(),s?.addFactory("Cell","dla-Runtimes-picker",s=>{const i=n.find(e=>!(!e.model||!Array.from(e.model.cells).find(e=>e===s.model)));return"code"!==s.model.type?new c.x0:r._Q.create((0,S.jsx)(d.o,{baseStyles:{backgroundColor:"transparent"},children:(0,S.jsxs)(de.a,{display:"flex",children:[(0,S.jsx)(de.a,{children:(0,S.jsx)(he.zl,{model:s.model,preference:i?.sessionContext?{id:i.sessionContext.session?.kernel?.id,language:i.sessionContext.specsManager.specs?.kernelspecs[i.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:i?.sessionContext})}),(0,S.jsx)(de.a,{children:(0,S.jsx)(M,{logIn:e.commands.hasCommand("@datalayer/ui:runtimes:create-widget")?()=>e.commands.execute("@datalayer/ui:runtimes:create-widget"):void 0,markdownParser:a??void 0,sanitizer:o??void 0,model:s.model,preference:i?.sessionContext?{id:i.sessionContext.session?.kernel?.id,language:i.sessionContext.specsManager.specs?.kernelspecs[i.sessionContext.session?.kernel?.name??""]?.language,location:i.sessionContext.location}:void 0,multiServiceManager:t,sessionContext:i?.sessionContext,translator:void 0})})]})}))})}},ge={id:"@datalayer/ui:runtimes:cell-footer",description:"Cell footer with runtime information.",requires:[o.fI],optional:[l.X],autoStart:!1,activate:(e,t,n)=>{e.docRegistry.addWidgetExtension("Notebook",new re(t,n))}}},71518:(e,t,n)=>{n.d(t,{Pl:()=>l,TT:()=>i,jU:()=>o,px:()=>a});var s=n(98238);const a="@datalayer/ui:runtimes:plugin",o=new s.Token("@datalayer/ui:runtimes:multi-service-manager"),i=new s.Token("@datalayer/ui:runtimes:browser-router"),l=new s.Token(a)},73425:(e,t,n)=>{n.d(t,{m:()=>g});var s=n(9387),a=n(55682),o=n(85181),i=n(98238),l=n(36848),r=n(51009),c=n(98754),d=n(84514),u=n(15038),h=n(11523),m=n(18683);function p(e){const{getInputOptions:t,inputs:n,setInputs:a,getOutputOptions:l,output:r,setOutput:p,translator:g}=e,_=(0,s.useMemo)(()=>(g??o.wK).load("jupyterlab"),[g]),f=(0,s.useRef)(null),[x,b]=(0,s.useState)(!1),[v,y]=(0,s.useState)(!!t),[C,k]=(0,s.useState)(null),[w,j]=(0,s.useState)(n.map(e=>({id:e,text:e,selected:!0}))),[S,E]=(0,s.useState)("");(0,s.useEffect)(()=>{const e=n.filter(e=>!w.find(t=>t.text===e));e.length&&j([...w,...e.map(e=>({id:e,text:e,selected:!0}))])},[n]),(0,s.useEffect)(()=>{const e=w.filter(e=>e.selected).map(e=>e.text);i.JSONExt.deepEqual(n,e)||a(e)},[w]),(0,s.useEffect)(()=>{v&&(t?t().then(e=>{const t=w.map(e=>e.text);j([...w,...e.sort().filter(e=>!t.includes(e)).map(e=>({id:e,text:e,selected:!1}))]),y(!1)}):y(!1))},[w,t]),(0,s.useEffect)(()=>{l&&Promise.all([l(),t?.()]).then(([e,t])=>{k(e.sort().concat((t??[]).sort()).reduce((e,t)=>(e.includes(t)||e.push(t),e),[]).map(e=>({id:e,text:e,selected:!1})))}).catch(e=>{console.error("Failed to get the cell output candidates",e),k([])})},[l,t]);const R=(0,s.useCallback)(e=>{const t=w.findIndex(t=>t.id===e);t>=0&&(w.splice(t,1),j([...w]))},[w]),A=(0,s.useCallback)(e=>{Array.isArray(e)||(e=[e]);const t=e.map(e=>e.id);j([...w.map(e=>t.includes(e.id)?Object.assign(e,{selected:!0}):Object.assign(e,{selected:!1}))])},[w]),I=(0,s.useCallback)(e=>{const t=w.find(t=>t.id===e.id);t?(t.selected=!0,j([...w])):j([...w,e])},[w]),M=(0,s.useCallback)(e=>{e.currentTarget&&E(e.currentTarget.value)},[]),N=(0,s.useCallback)(e=>{e.currentTarget&&p(e.currentTarget.value)},[]),T=(0,s.useCallback)(e=>{x?f.current&&!e&&(p(f.current.value),b(!1)):e&&b(!0)},[x]);return(0,m.jsxs)(c.A,{as:"form",sx:{p:3},children:[(0,m.jsxs)(d.A,{children:[(0,m.jsx)(d.A.Label,{id:"cell-input-variables",children:_.__("Inputs")}),(0,m.jsxs)(u.A,{children:[(0,m.jsx)(u.A.Input,{as:h.A,tokens:w.filter(e=>e.selected),onTokenRemove:R,onChange:M}),(0,m.jsx)(u.A.Overlay,{children:(0,m.jsx)(u.A.Menu,{addNewItem:S&&!w.find(e=>e.text===S)?{id:S,text:_.__("Add '%1'",S),handleAddItem:e=>{I({...e,text:S,selected:!0}),E("")}}:void 0,items:w,selectedItemIds:w.filter(e=>e.selected).map(e=>e.id),onSelectedChange:A,"aria-labelledby":"cell-input-variables",selectionVariant:"multiple",emptyStateText:_.__("No available variables."),loading:v})})]})]}),(0,m.jsxs)(d.A,{children:[(0,m.jsx)(d.A.Label,{id:"cell-output-variables",children:_.__("Output")}),(0,m.jsxs)(u.A,{children:[(0,m.jsx)(u.A.Input,{ref:f,value:r,onChange:N}),(0,m.jsx)(u.A.Overlay,{children:(0,m.jsx)(u.A.Menu,{items:C??[],selectedItemIds:r?[r]:[],"aria-labelledby":"cell-output-variables",loading:l&&!C,emptyStateText:_.__("Not among the available variables."),onOpenChange:T})})]})]})]})}function g(e){const{onClose:t,model:n,preference:c,sessionContext:d,translator:u}=e,[h,g]=(0,s.useState)([]),[_,f]=(0,s.useState)(),x=(0,s.useMemo)(()=>(u??o.wK).load("jupyterlab"),[u]);(0,s.useEffect)(()=>{const e=e=>{const t=e.getMetadata("datalayer")??{};t.in&&!i.JSONExt.deepEqual(h,t.in)&&g(t.in),t.out&&t.out!==_&&f(t.out)};return e(n),n.metadataChanged.connect(e),()=>{n.metadataChanged.disconnect(e)}},[n]);const b=(0,s.useCallback)(()=>{const e=n.getMetadata("datalayer")??{};h.length?e.in=h:delete e.in,_?e.out=_:delete e.out,n.setMetadata("datalayer",{...e}),t()},[h,_]),v=(0,s.useCallback)(async()=>{if(!d)return[];const e=d.session.kernel,t=d.specsManager.specs.kernelspecs[e.model.name],n=new r.J(t.language),s=(await new l.D({connection:e}).execute(n.listVariables())).get(0).data["text/plain"];if(s){const e=JSON.parse(s.slice(1,s.length-1));return Object.keys(e??{})}return[]},[c,d]),y=(0,s.useCallback)(async()=>new r.J("python").getOutputCandidates(n.sharedModel.source),[n]);let C="Define cell variables to transfer";const k=(n.getMetadata("datalayer")??{}).kernel??{},w=(k.displayName||k.name)??"";return w&&(!1!==k.params?.notebook&&k.id?C+=` with running ${w} (${k.id.slice(0,7)})`:C+=` with ${w}`),(0,m.jsx)(a.l,{title:C,onClose:t,footerButtons:[{buttonType:"default",content:x.__("Cancel"),onClick:t},{buttonType:"primary",content:x.__("Set variables"),onClick:b,autoFocus:!0}],children:(0,m.jsx)(p,{inputs:h,getInputOptions:d?v:void 0,setInputs:g,output:_??void 0,getOutputOptions:y,setOutput:f,translator:u})})}},73897:(e,t,n)=>{n.d(t,{R:()=>a});const s=["browser","local"];function a(e){return!s.includes(e)}},86178:(e,t,n)=>{n.d(t,{K:()=>c,N:()=>r});var s=n(63711),a=n(85181);const o="Assign a new Runtime",i="Assign an existing Remote Runtime",l="Assign an existing Runtime";function r(e,t,n,r=()=>!0,c){const d=(n=n??a.wK).load("jupyterlab"),u=e.local.kernelspecs.specs,h=e.local.sessions.running(),m={},p=Array.from(h).filter(e=>e.kernel&&e.kernel.id!==t&&u.kernelspecs[e.kernel.name]).map(e=>{const t=u.kernelspecs[e.kernel.name];return{kernelId:e.kernel.id,name:t.name,language:t.language,displayName:e.name||s.PathExt.basename(e.path),location:"local"}}).concat(Array.from(e.browser?.sessions.running()??[]).filter(e=>e.kernel&&e.kernel.id!==t).map(t=>{const n=e.browser.kernelspecs.specs.kernelspecs[t.kernel.name];return{id:"",kernelId:t.kernel.id,name:n.name,language:n.language,displayName:t.name||s.PathExt.basename(t.path),location:"browser"}})).filter(r),g=p.map(e=>e.kernelId),_=Array.from(e.local.kernels.running()).filter(e=>!g.includes(e.id)).map(e=>{const t=u.kernelspecs[e.name];return{kernelId:e.id,name:t.name,language:t.language,displayName:t.display_name,location:"local"}}).concat((e.remote?.runtimesManager.get()??[]).filter(e=>e.id&&!g.includes(e.id)).map(t=>{const n=e.remote.environments.get().find(e=>e.name===t.environment_name);return{kernelId:t.id,name:n.name,language:n.language,displayName:t.given_name??n.title,location:"remote",podName:t.pod_name,gpu:n.resources?.["nvidia.com/gpu"]}})).concat(Array.from(e.browser?.kernels.running()??[]).filter(e=>!g.includes(e.id)).map(t=>{const n=e.browser.kernelspecs.specs.kernelspecs[t.name];return{kernelId:t.id,name:n.name,language:n.language,displayName:n.display_name,location:"browser"}})).filter(r);p.push(..._),p.length&&(m["cell"===c?i:l]=p);const f=Object.values(u.kernelspecs).filter(e=>!!e).map(e=>({name:e.name,language:e.language,displayName:e.display_name,gpu:e.resources?.["nvidia.com/gpu"],location:"local"})).filter(r);return f.push(...e.remote?.environments.get().map(e=>({name:e.name,language:e.language,displayName:e.title,location:"remote",gpu:e.resources?.["nvidia.com/gpu"],burningRate:e.burning_rate})).filter(r)??[]),f.push(...Object.values(e.browser?.kernelspecs.specs?.kernelspecs??{}).filter(e=>!!e).map(e=>({name:e.name,language:e.language,displayName:e.display_name,location:"browser"})).filter(r)),f.length&&(m[d.__(o)]=f),m}function c(e){const{specs:t,preference:n}=e,{name:s,language:a,canStart:o,autoStartDefault:i}=n;if(!t||!1===o)return null;const l=i?t.default:null;if(!s&&!a)return l;for(const e in t.kernelspecs)if(e===s)return s;if(!a)return l;const r=[];for(const e in t.kernelspecs){const n=t.kernelspecs[e]?.language;a===n&&r.push(e)}if(1===r.length){const e=r[0];return console.warn("No exact match found for "+e+", using runtime "+e+" that matches language="+a),e}return l}},93426:(e,t,n)=>{n.d(t,{c:()=>s});const s=3},93904:(e,t,n)=>{n.d(t,{v:()=>u});var s=n(9387),a=n(20568),o=n(24750),i=n(44536),l=n(24500),r=n(97734),c=n(18683);const d=e=>{const{message:t}=e,{loginAndNavigate:n}=(0,l.D)(),{logout:a,checkIAMToken:d,externalToken:u}=(0,i.Y)(),{enqueueToast:h}=(0,r.d)();return(0,s.useEffect)(()=>{u&&n(u,a,d).catch(e=>{console.debug("Failed to login with the provided token.",e),h("Failed to login with the provided token.",{variant:"error"})}).finally(()=>{h("Runtimes are available.",{variant:"success"})})},[u]),(0,c.jsx)(o.Y,{size:"small",message:t})},u=e=>(0,c.jsx)(a.fS,{initialEntries:["/"],children:(0,c.jsx)(a.BV,{children:(0,c.jsx)(a.qh,{path:"*",element:(0,c.jsx)(d,{...e})})})})}}]);