"use strict";(self.webpackChunk_amzn_sagemaker_gen_ai_jupyterlab_extension=self.webpackChunk_amzn_sagemaker_gen_ai_jupyterlab_extension||[]).push([[996],{996:(e,t,n)=>{n.r(t),n.d(t,{FlareWidget:()=>I,connectWebSocket:()=>S,createFlarePanel:()=>x,default:()=>W});var o=n(607),s=n(907),a=n(748),r=n(256),i=n(744);const c="flare-iframe",d={position:{line:0,character:0}},l={HELP:"/help",FIX:"/fix",EXPLAIN:"/explain",OPTIMIZE:"/optimize",REFACTOR:"/refactor"},g="code",m=e=>{const t=e.currentWidget;return t?t.content.activeCell:void 0},h=e=>{const t=m(e);if(t&&t.model.type===g){const e=t.model.outputs;if(e)for(let t=0;t<e.length;t++)if("error"===e.get(t).type)return!0}return!1},p=(e,t)=>{var n;if("Fix"===t&&h(e)){const t=e.currentWidget,o=(null===(n=null==t?void 0:t.content.activeCell)||void 0===n?void 0:n.model.type)===g?t.content.activeCell.model.sharedModel.getSource():"",s=(e=>{var t;const n=m(e);if(n&&n.model.type===g){const e=n.model.outputs;if(e)for(let n=0;n<e.length;n++){const o=e.get(n);if("error"===o.type)return`ErrorType: ${o._raw.ename}; ErrorValue: ${o._raw.evalue}; Trace: ${null===(t=o._raw.traceback)||void 0===t?void 0:t.toString()}`}}return""})(e);return`Code:\n${o}\n\nError:\n${s}`}const o=m(e);if(o&&o.model.type===g){const e=o.editor;if(e){const t=e.getSelection();if(t.start.line!==t.end.line||t.start.column!==t.end.column){const n=e.model.sharedModel.getSource().substring(e.getOffsetAt(t.start),e.getOffsetAt(t.end));if(n.trim())return n}}return o.model.sharedModel.getSource()}return""},u=e=>{const t=document.getElementById(c);if(!t||!t.contentWindow)throw new Error("Q Chat UI not mounted");t.contentWindow.postMessage(e,window.location.origin)};class w{sendErrorToWebview(e,t,n){u({command:"errorMessage",params:{title:e,message:t,tabId:n}})}constructor({url:e,docManager:t,reconnectDelay:n=5e3,timeout:o=6e5}){this.pendingRequests=new Map,this.reconnecting=!1,this.url=e,this.reconnectDelay=n,this.timeout=o,this.setupSocket(),this.docManager=t}setupSocket(){this.socket=new WebSocket(this.url),this.socket.onmessage=this.onMessage.bind(this),this.socket.onopen=()=>{console.log("WebSocket connection established"),this.reconnecting=!1},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=e=>{console.log("WebSocket connection closed:",e.code,e.reason),this.reconnecting||(this.reconnecting=!0,console.log(`Attempting to reconnect in ${this.reconnectDelay}ms...`),setTimeout((()=>this.setupSocket()),this.reconnectDelay))}}onMessage(e){if(!e.origin||e.origin.startsWith("wss://"))if(e.origin&&e.origin.replace("wss://","")!==window.location.origin.replace("https://",""))console.warn(`Rejected message from unauthorized origin: ${e.origin}`);else try{const t=JSON.parse(e.data),n=t.id;if(console.log("WebSocket message received:",t),n){const e=this.pendingRequests.get(n);e?e(t):console.warn(`No handler found for message with id: ${n}`)}else this.handleInboundEvent(t)}catch(t){console.error("Error processing message:",t);const n=JSON.parse(e.data);this.sendErrorToWebview("Message Processing Error","Failed to process message, please refresh browser and try again.",n.tabId)}else console.warn(`Rejected message from insecure websocket connection: ${e.origin}`)}handleInboundEvent(e){try{const t=e.command;switch(console.log("Handling inbound event:",{command:t}),t){case"aws/chat/sendChatPrompt":case"aws/chat/buttonClick":case"aws/chat/sendPinnedContext":case"aws/chat/openTab":case"aws/chat/sendChatUpdate":case"aws/chat/chatOptionsUpdate":u(e);break;case"aws/chat/sendContextCommands":const n=["Folders","Files","Code","Active file"],o=e.params.contextCommandGroups.map((e=>{const t=null==e?void 0:e.commands.filter((e=>n.includes(e.command)));return{...e,commands:t}}));u({...e,params:{...e.params,contextCommandGroups:o}});break;case"aws/openFileDiff":this.docManager.openOrReveal(e.params.originalFileUri.replace("home/sagemaker-user/",""));break;default:console.log(`Unhandled inbound command: ${t}`)}}catch(t){console.error("Error handling event:",t),this.sendErrorToWebview("Event Handling Error","Failed to handle inbound event, please refresh browser and try again.",e.tabId)}}sendRequest(e){if(this.socket.readyState!==WebSocket.OPEN)return this.sendErrorToWebview("Connection Error","WebSocket is not connected, please stop and start the space and try again.",e.tabId),Promise.reject(new Error("WebSocket is not connected"));const t=(0,i.v4)();return console.log(`Sending request with id: ${t}, command: ${e.command}`),new Promise(((n,o)=>{const s=setTimeout((()=>{this.pendingRequests.delete(t),console.error(`Request timed out: ${e.command} (id: ${t})`),this.sendErrorToWebview("Request Timeout",`Request timed out: ${e.command}`,e.tabId),o(new Error(`Request timed out: ${e.command}`))}),this.timeout);this.pendingRequests.set(t,(a=>{clearTimeout(s),this.pendingRequests.delete(t),a.error?(a.error.toLowerCase().includes("you are not subscribed to amazon q developer")?this.sendErrorToWebview("No active subscription",a.error,e.tabId):a.error.includes("Something went wrong")?this.sendErrorToWebview("Internal Server Error",a.error,e.tabId):this.sendErrorToWebview("Response Error",a.error,e.tabId),o(new Error(a.error))):(console.log(`Received response for id: ${t}`),n(a))}));try{const n={...e,id:t};console.log("Sending payload:",n),this.socket.send(JSON.stringify(n))}catch(n){clearTimeout(s),this.pendingRequests.delete(t),this.sendErrorToWebview("Message Sending Error","Failed to send message, please refresh browser and try again.",e.tabId),o(n)}}))}sendNotification(e){this.socket.readyState===WebSocket.OPEN?(console.log(`Sending notification: ${e.command}`),this.socket.send(JSON.stringify(e))):console.warn("Cannot send notification: WebSocket is not connected")}}const f=new(n(346).LabIcon)({name:"sagemaker_gen_ai_jupyterlab_extension:mynah-icon",svgstr:'<svg\n   version="1.1"\n   id="svg41"\n   width="86.724358"\n   height="97.987442"\n   viewBox="0 0 86.724357 97.987443"\n   sodipodi:docname="MynahIconBlack.svg"\n   inkscape:version="1.1 (c4e8f9e, 2021-05-24)"\n   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <sodipodi:namedview\n     id="namedview876"\n     pagecolor="#ffffff"\n     bordercolor="#666666"\n     borderopacity="1.0"\n     inkscape:pageshadow="2"\n     inkscape:pageopacity="0.0"\n     inkscape:pagecheckerboard="0"\n     showgrid="false"\n     fit-margin-top="0"\n     fit-margin-left="0"\n     fit-margin-right="0"\n     fit-margin-bottom="0"\n     inkscape:zoom="2.2500001"\n     inkscape:cx="54.888887"\n     inkscape:cy="83.333331"\n     inkscape:window-width="1296"\n     inkscape:window-height="1003"\n     inkscape:window-x="0"\n     inkscape:window-y="23"\n     inkscape:window-maximized="0"\n     inkscape:current-layer="svg41" />\n  <defs\n     id="defs45" />\n  <g\n     id="g47"\n     transform="translate(-110.57257,-89.344135)">\n    <path\n       id="path119"\n       style="fill:#616161;stroke-width:0.666667"\n       d="m 132.3073,175.69728 c -10.9919,-6.39196 -20.5483,-11.71526 -21.01473,-12.35314 -1,-1 -0.66666,-7.12319 -0.66666,-25.09025 0,-23.44292 0.004,-23.50619 1.5,-25.13945 2.26641,-2.47399 39.671,-23.770305 41.74986,-23.770305 2.0058,0 40.37944,21.908195 42.26881,24.132005 1.02786,1.20981 1.15578,2.71468 1.15228,9.97108 l -0.004,8.89692 c -2.45942,1.43994 -5.63304,2.69259 -7.96617,4.03864 -0.3718,-0.15327 -0.0687,-1.03863 -0.0544,-8.82654 0.0206,-11.2121 0.0206,-9.2121 -1.51868,-10.31876 -1.52114,-1.09365 -32.51933,-18.560008 -33.84416,-18.560008 -1.25235,0 -31.04529,16.968568 -33.11659,18.861548 -1.49018,1.36189 -1.5,1.49866 -1.5,20.8874 v 19.51653 l 2.16667,1.60229 c 1.19167,0.88127 8.48303,5.24654 16.20303,9.7006 10.25534,5.91684 14.63368,8.0983 16.25381,8.0983 1.61694,0 6.21093,-2.28074 16.96364,-8.4218 8.1104,-4.63198 15.18204,-9.48673 16.17005,-10.18945 2.16666,-1.54103 2.2428,-0.72249 2.2428,-6.21889 v -8.16986 c 3.39521,-1.88596 6.37178,-3.2868 8,-4 0,2 7.1e-4,5.58598 -0.12079,11.70615 -0.20898,10.52655 -0.2405,10.72729 -1.87921,11.96607 -4.03346,3.04908 -40.10794,23.32654 -41.47877,23.31521 -0.83667,-0.007 -10.5146,-5.24234 -21.5065,-11.63429 z m 6.98527,-13.24574 -13,-7.5264 -0.1817,-12.12383 c -0.12957,-8.64498 0.0335,-12.12384 0.56841,-12.12384 0.41257,0 2.21903,0.825 4.01436,1.83333 l 3.26425,1.83334 6.6e-4,7.39667 c 3.4e-4,4.33084 0.13585,7.47409 0.33402,8.60333 4,2 4.01212,1.97913 9.05385,4.90172 11.18306,6.4826 9.65841,6.483 20.92924,-0.005 l 9.66305,-5.56306 0.0103,-11.51712 0.0103,-11.51712 -1.83333,0.95743 c -1.00834,0.52659 -5.28334,2.93269 -9.5,5.34689 -4.21667,2.4142 -8.13245,4.39106 -8.70174,4.39302 -1.12699,0.004 -22.88352,-12.14422 -24.82294,-13.86028 -0.65525,-0.57978 -0.80873,-1.13648 -1,-2.00277 0.27808,-1.37868 21.19127,-12.13371 25.78925,-14.80005 1.40202,0.66634 12.06876,6.54248 12.06876,6.54248 -2.37057,1.7297 -4.66827,3.36842 -6.66674,5.12386 -4,-2 -3.48763,-1.69984 -5.46135,-2.64104 -3.17228,1.94317 -4.53865,2.64104 -9.87191,6.04784 2.33326,1.5932 7.33326,4.5932 9.95057,5.59353 2.38269,-1.00033 2.38269,-1.00033 10.78356,-5.08996 9.97292,-4.85492 8.8766,-5.52257 14.57706,-1.92402 l 2.71204,1.71203 -0.17828,16.38541 -0.51169,15.91621 -12.66659,8.03197 c -6.9858,4.42975 -13.33341,6.96803 -14.66667,7.58246 -1.66674,-0.61443 -7.34211,-3.26612 -14.66667,-7.5067 z" />\n  </g>\n</svg>'});var k=n(598),b=n(334),v=n(851),y=n.n(v);class C{constructor(e,t){this.app=e,this.chatPanel=t,this.messageListener=async e=>{this.isMessageOriginValid(e)&&("MD_TOGGLE_AI_CHAT"!==e.data||this.toggleQChat(this.app,this.chatPanel))}}async initialize(){window.addEventListener("message",this.messageListener)}isMessageOriginValid(e){return["https://**.v2.*.beta.app.*.aws.dev","https://**.ui.*.aws.dev","https://**.v2.*-gamma.*.on.aws","https://**.datazone.*.on.aws","https://**.sagemaker.*.on.aws","https://**.sagemaker-gamma.*.on.aws"].some((t=>y()(t)(e.origin)))}toggleQChat(e,t){const n=t.id;if(!n)throw new Error("Chat widget not found.");if(e.shell instanceof o.LabShell){const t=Array.from(e.shell.widgets("left")),o=Array.from(e.shell.widgets("right")),s=[...t,...o].find((e=>e.id===n));s&&(s.isHidden?e.shell.activateById(n):o.find((e=>e.id===n))?e.shell.collapseRight():e.shell.collapseLeft())}}}var E=n(912);function S(e="",t){const n=a.ServerConnection.makeSettings(),o=s.URLExt.join(n.wsUrl,"sagemaker_gen_ai_jupyterlab_extension",e);return new w({url:o,docManager:t})}class I extends r.Widget{constructor(){super(),console.log("Creating Q Widget"),this.addClass("jp-FlareWidget"),this.node.style.height="100%",this.node.style.overflow="hidden";const e=document.createElement("div");e.id="jp-FlareContainer",e.style.width="100%",e.style.height="100%",this.node.appendChild(e)}onAfterAttach(){console.log("Q Widget attached"),this.loadContent()}async loadContent(){const e=document.getElementById("jp-FlareContainer");if(e)try{const t=document.createElement("iframe");t.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups");const n=a.ServerConnection.makeSettings().baseUrl;t.src=s.URLExt.join(n,"sagemaker_gen_ai_jupyterlab_extension","static","client.html"),t.style.width="100%",t.style.height="100%",t.style.border="none",t.referrerPolicy="no-referrer",t.id=c,e.innerHTML="",e.appendChild(t)}catch(t){e.innerHTML=`<h2>Error Loading Amazon Q Chat</h2><p>${t}</p>`}}}function x(){console.log("Creating Q Panel");const e=new r.Panel;e.id="flare-panel",e.title.icon=f,e.title.caption="Amazon Q AI Assistant",e.title.closable=!0;const t=new I;return e.addWidget(t),e}const _={id:"@amzn/sagemaker_gen_ai_jupyterlab_extension:plugin",autoStart:!0,requires:[o.ILabShell,b.IDocumentManager,k.INotebookTracker,E.ISettingRegistry],optional:[],activate:async(e,t,n,o,s)=>{console.log("JupyterLab sagemaker_gen_ai_jupyterlab extension activated!",(new Date).toISOString());const a=S("ws",n);if(!a)return void console.error("Failed to initialize WebSocket connection. Extension functionality will be limited.");let i=null;const c=()=>{try{if(!i){if(i=x(),!i)return void console.error("Failed to create Q panel");t.add(i,"left",{rank:0})}t.activateById(i.id)}catch(e){console.error("Error showing Q widget:",e)}};try{(({app:e,notebookTracker:t,showFlareWidget:n})=>{const o=["Explain","Refactor","Fix","Optimize"];o.forEach((o=>{const s=`sagemaker-gen-ai:${o.toLowerCase()}`;e.commands.addCommand(s,{label:`${o}`,isEnabled:()=>"Fix"!==o||h(t),execute:()=>{const e=p(t,o);e&&(console.log(`${o}:`,e),n(),u({command:"genericCommand",params:{genericCommand:o,selection:e,triggerType:"contextMenu"}}))}})}));const s=new r.Menu({commands:e.commands});s.title.label="Amazon Q",o.forEach((e=>{s.addItem({command:`sagemaker-gen-ai:${e.toLowerCase()}`})})),[".jp-CodeCell"].forEach((t=>e.contextMenu.addItem({type:"submenu",submenu:s,selector:t,rank:0})))})({app:e,notebookTracker:o,showFlareWidget:c})}catch(e){console.error("Failed to register context menu actions:",e)}(async({socket:e,settingRegistry:t,pluginId:n})=>{null==t||t.load(n).then((t=>{null==t||t.changed.connect((()=>{e.sendNotification({command:"workspace/didChangeConfiguration",params:{}})}))}))})({socket:a,settingRegistry:s,pluginId:_.id}),setTimeout((()=>{try{i=x(),i?(t.add(i,"left",{rank:0}),new C(e,i).initialize(),function(e,t,n,o,s){t.addEventListener("message",(async t=>{var a;const r=t.data,i=r.command,c=null===(a=r.params)||void 0===a?void 0:a.tabId;switch(i){case"aws/chat/sendChatPrompt":try{const t=(({docManager:e,labShell:t})=>{const n=t.currentWidget;if(!n)return;const o=e.contextForWidget(n);return o&&o.path?{path:o.path}:void 0})({docManager:o,labShell:s}),n=await e.sendRequest({...r,tabId:c,params:{...r.params,textDocument:t?{uri:`file:///home/sagemaker-user/${null==t?void 0:t.path}`}:void 0,cursorState:[d]}});u(n)}catch(e){console.error(e)}break;case"aws/chat/buttonClick":case"aws/chat/listMcpServers":case"aws/chat/mcpServerClick":case"aws/chat/listConversations":case"aws/chat/listRules":case"aws/chat/conversationClick":try{const t=await e.sendRequest({...r,tabId:c});u(t)}catch(e){console.error(e)}break;case"aws/chat/ready":e.sendNotification(r),u({command:"chatOptions",params:{mcpServers:!0,history:!0}});break;case"aws/chat/sendChatQuickAction":try{const t=await e.sendRequest({...r,tabId:c}),o=r.params.quickAction;if(o===l.HELP)return void u({...t,command:"aws/chat/sendChatPrompt"});if("string"==typeof o&&[l.FIX,l.EXPLAIN,l.OPTIMIZE,l.REFACTOR].includes(o)){const e=o.slice(1);u({command:"genericCommand",params:{genericCommand:e,selection:r.params.prompt||p(n,"fix"===e?"Fix":void 0),triggerType:"contextMenu"}})}}catch(e){console.error(e)}break;case"aws/chat/tabAdd":case"aws/chat/tabChange":case"aws/chat/tabRemove":case"aws/chat/pinnedContextAdd":case"aws/chat/pinnedContextRemove":case"aws/chat/createPrompt":case"aws/chat/fileClick":case"stopChatResponse":case"aws/chat/openTab":case"aws/chat/promptInputOptionChange":e.sendNotification(r);break;case"chatPromptOptionAcknowledged":case"disclaimerAcknowledged":(e=>{"disclaimerAcknowledged"===e&&localStorage.setItem("disclaimerAcknowledged","true"),"chatPromptOptionAcknowledged"===e&&localStorage.setItem("chatPromptOptionAcknowledged","true")})(i);break;case"aws/chat/linkClick":case"aws/chat/infoLinkClick":const t={type:"openLink",url:r.params.link};window.parent.postMessage(t,"*");break;case"insertToCursorPosition":if(n&&r.params){const e=r.params.code;e&&((e,t)=>{const n=m(e);if(n&&n.model.type===g){const e=n.editor;if(e)try{const n=e.getCursorPosition(),o=e.model.sharedModel.source,s=o.substring(0,e.getOffsetAt(n)),a=s+t+o.substring(e.getOffsetAt(n));e.model.sharedModel.source=a;const r=e.getPositionAt(s.length+t.length);r&&e.setCursorPosition(r)}catch(e){console.error("Error inserting the code:",e)}}})(n,e)}}}))}(a,window,o,n,t),(()=>{const e=["mcpServers"].reduce(((e,t)=>(e[t]=!0,e)),{});u({command:"chatOptions",params:e})})()):console.error("Failed to create initial Q panel")}catch(e){console.error("Error during delayed initialization:",e)}}),5e3)}},W=_}}]);