# Generated by Django 4.2.23 on 2025-07-24 07:15

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("help_rating", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="FeedbackSummary",
            fields=[
                (
                    "subject",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        primary_key=True,
                        serialize=False,
                        to="help_rating.subject",
                        verbose_name="Voting content",
                    ),
                ),
                ("quantity", models.IntegerField(verbose_name="Number of votes")),
                ("avg", models.FloatField(verbose_name="Arithmetic mean")),
                ("median", models.FloatField(verbose_name="Median")),
            ],
            options={
                "verbose_name": "Feedback summary",
                "verbose_name_plural": "Feedbacks summaries",
                "db_table": "help_rating_summary",
                "managed": False,
            },
        ),
    ]
    if settings.DATABASES["default"]["ENGINE"] in (
            "django.db.backends.postgresql_psycopg2", "django.db.backends.postgresql"):
        operations.append(
            migrations.RunSQL(
                sql="""CREATE OR REPLACE VIEW help_rating_summary AS
                    SELECT
                        help_rating_feedback.subject_id,
                        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY help_rating_feedback.score) AS median,
                        COUNT(help_rating_feedback.subject_id) AS quantity,
                        AVG(help_rating_feedback.score) AS avg
                    FROM help_rating_feedback
                    GROUP BY help_rating_feedback.subject_id""",
                reverse_sql="DROP VIEW IF EXISTS help_rating_summary",
            ),
        )
    else:
        # django.db.backends.sqlite3
        operations.append(
            migrations.RunSQL(
                sql="""CREATE VIEW IF NOT EXISTS help_rating_summary AS
                    SELECT
                        help_rating_feedback.subject_id,
                        (SELECT score FROM help_rating_feedback ORDER BY score LIMIT 1 OFFSET(SELECT COUNT(*) FROM help_rating_feedback) / 2) AS median,
                        COUNT(help_rating_feedback.subject_id) AS quantity,
                        AVG(help_rating_feedback.score) AS avg
                    FROM help_rating_feedback
                    GROUP BY help_rating_feedback.subject_id""",
                reverse_sql="DROP VIEW IF EXISTS help_rating_summary",
            ),
        )
