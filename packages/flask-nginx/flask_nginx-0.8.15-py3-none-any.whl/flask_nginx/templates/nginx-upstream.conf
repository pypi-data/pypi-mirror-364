# generated by "{{cmd|default('footprint')}}" on {{now()}}
server {
    listen {{listen|default(80)}};
    listen [::]:{{listen|default(80)}};

    client_max_body_size 4G;
    keepalive_timeout 5;

    root {{root}};
    index index.html;
    access_log /var/log/nginx/{{server_name|split|first}}-access.log;

    server_name {{server_name}};

    {% if error_page is defined -%}
    error_page 404 {{error_page.url or '/'}}404.html;
    location = {{error_page.url or '/'}}404.html {
        root {{error_page.folder}};
        internal;
    }
    {%- endif %}
    {% if favicon is defined -%}
    location ~ ^/(robots\.txt|crossdomain\.xml|favicon\.ico|browserconfig\.xml|humans\.txt|\.well-known/.*)$ {
        root {{favicon}};
        expires {{expires|default('off')}};
        access_log {{access_log|default('off')}};
        try_files $uri $uri/ @app;
    }
    {% endif -%}

    {% for s in staticdirs %}
    {% if s.url -%}
        location {{s.url}}
    {%- else -%}
        location ~ {{ root_location_match|default('(^/(img|images|js|css|media|docs|tutorials|notebooks|downloads|help|\.well-known)/|^favicon\.ico$)')}}
    {%- endif %} {
        {% if s.rewrite %}rewrite {{s.url}}/(.*) /$1 break;{% endif %}
        root  {{s.folder}};
        expires {{expires|default('off')}};
        access_log {{access_log|default('off')}};
        # Warning: using add_header ignores all add_header blocks from parent scopes!!!
        location ~ \.svgz$ { add_header Content-Encoding gzip; }
        try_files $uri $uri/ @app;
    }
    {% endfor %}

    {# https://serverfault.com/questions/908086/nginx-directly-send-from-location-to-another-named-location -#}

    location {{prefix|default('/')}} {
        try_files /dev/null @app;
    }

    {% set named_app = server_name|split|first|replace('.','_') -%}
    location @app {
        proxy_pass         http://{{named_app}};
        proxy_redirect     off;

        proxy_set_header  Host              $http_host;
        proxy_set_header  X-Real-IP         $remote_addr;
        proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        {{extra|default('')}}
    }

}
{# can't go in server #}
upstream {{named_app}} {
    zone upstreams 64K;
    server {% if host is defined %}{{host}}{% else %}unix:{{application_dir}}/app.sock{% endif %} max_fails=1 fail_timeout=2s;
    keepalive 2;
}
