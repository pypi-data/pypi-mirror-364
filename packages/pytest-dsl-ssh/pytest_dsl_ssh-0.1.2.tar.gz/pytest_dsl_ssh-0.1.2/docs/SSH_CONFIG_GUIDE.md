# SSHé…ç½®è‡ªåŠ¨åŠ è½½æŒ‡å—

## æ¦‚è¿°

pytest-dsl-sshçŽ°åœ¨æ”¯æŒä»ŽYAMLé…ç½®æ–‡ä»¶ä¸­è‡ªåŠ¨åŠ è½½SSHæœåŠ¡å™¨è¿žæŽ¥ä¿¡æ¯ï¼Œè®©SSHæ“ä½œæ›´åŠ ç®€æ´å’Œæ˜“äºŽç®¡ç†ã€‚æ‚¨ä¸å†éœ€è¦åœ¨æ¯ä¸ªSSHå…³é”®å­—ä¸­é‡å¤å¡«å†™è¿žæŽ¥å‚æ•°ï¼Œåªéœ€åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ä¸€æ¬¡ï¼Œç„¶åŽé€šè¿‡æœåŠ¡å™¨åç§°å¼•ç”¨å³å¯ã€‚

## ä¸»è¦ç‰¹æ€§

- ðŸŽ¯ **è‡ªåŠ¨é…ç½®åŠ è½½** - ä»ŽYAMLé…ç½®ä¸­è‡ªåŠ¨åŠ è½½SSHè¿žæŽ¥ä¿¡æ¯
- ðŸ”§ **å‚æ•°è¦†ç›–** - æ”¯æŒåœ¨ä½¿ç”¨æ—¶è¦†ç›–é…ç½®ä¸­çš„é»˜è®¤å€¼
- ðŸ“¦ **ç»Ÿä¸€ç®¡ç†** - é›†ä¸­ç®¡ç†æ‰€æœ‰æœåŠ¡å™¨çš„è¿žæŽ¥é…ç½®
- ðŸ”„ **å¤šçŽ¯å¢ƒæ”¯æŒ** - æ”¯æŒä¸åŒçŽ¯å¢ƒçš„é…ç½®åˆ‡æ¢
- ðŸ›¡ï¸ **å®‰å…¨æ€§** - æ”¯æŒç§é’¥è®¤è¯å’Œå¯†ç è®¤è¯

## é…ç½®æ–‡ä»¶æ ¼å¼

### åŸºæœ¬é…ç½®ç»“æž„

```yaml
# config/ssh_servers.yaml
ssh_servers:
  server_name:
    hostname: "æœåŠ¡å™¨åœ°å€"
    username: "ç”¨æˆ·å"
    password: "å¯†ç "  # å¯é€‰ï¼Œå»ºè®®ä½¿ç”¨ç§é’¥
    private_key_path: "ç§é’¥è·¯å¾„"  # å¯é€‰
    port: 22  # å¯é€‰ï¼Œé»˜è®¤22
    description: "æœåŠ¡å™¨æè¿°"  # å¯é€‰
    tags: ["æ ‡ç­¾1", "æ ‡ç­¾2"]  # å¯é€‰
```

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# SSHæœåŠ¡å™¨é…ç½®
ssh_servers:
  # å¼€å‘çŽ¯å¢ƒæœåŠ¡å™¨
  dev_server:
    hostname: "192.168.1.100"
    username: "developer"
    password: "dev_password"
    port: 22
    description: "å¼€å‘çŽ¯å¢ƒä¸»æœåŠ¡å™¨"
    tags: ["development", "web"]
    
  # ç”Ÿäº§çŽ¯å¢ƒæœåŠ¡å™¨ï¼ˆä½¿ç”¨ç§é’¥è®¤è¯ï¼‰
  prod_server:
    hostname: "prod.example.com"
    username: "admin"
    private_key_path: "~/.ssh/prod_server_key"
    private_key_password: "key_password"  # å¦‚æžœç§é’¥æœ‰å¯†ç 
    port: 2222  # éžæ ‡å‡†ç«¯å£
    connect_timeout: 10
    timeout: 60
    compress: true
    keep_alive_interval: 30
    description: "ç”Ÿäº§çŽ¯å¢ƒä¸»æœåŠ¡å™¨"
    tags: ["production", "critical"]
```

### æ”¯æŒçš„é…ç½®å‚æ•°

| å‚æ•°å | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜Ž |
|--------|------|--------|------|
| `hostname` | âœ… | - | æœåŠ¡å™¨åœ°å€æˆ–IP |
| `username` | âœ… | - | ç™»å½•ç”¨æˆ·å |
| `password` | âŒ | - | ç™»å½•å¯†ç  |
| `private_key_path` | âŒ | - | SSHç§é’¥æ–‡ä»¶è·¯å¾„ |
| `private_key_password` | âŒ | - | ç§é’¥å¯†ç ï¼ˆå¦‚æžœæœ‰ï¼‰ |
| `port` | âŒ | 22 | SSHç«¯å£ |
| `connect_timeout` | âŒ | 10 | è¿žæŽ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `timeout` | âŒ | 30 | æ“ä½œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `auto_add_host_keys` | âŒ | true | æ˜¯å¦è‡ªåŠ¨æ·»åŠ ä¸»æœºå¯†é’¥ |
| `compress` | âŒ | false | æ˜¯å¦å¯ç”¨åŽ‹ç¼© |
| `keep_alive_interval` | âŒ | 0 | ä¿æ´»é—´éš”ï¼ˆç§’ï¼‰ |
| `description` | âŒ | - | æœåŠ¡å™¨æè¿° |
| `tags` | âŒ | [] | æœåŠ¡å™¨æ ‡ç­¾ |

## ä½¿ç”¨æ–¹æ³•

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®çš„`config`ç›®å½•ä¸‹åˆ›å»º`ssh_servers.yaml`æ–‡ä»¶ï¼š

```bash
mkdir -p config
cat > config/ssh_servers.yaml << 'EOF'
ssh_servers:
  my_server:
    hostname: "192.168.1.100"
    username: "admin"
    password: "admin123"
    description: "æˆ‘çš„æµ‹è¯•æœåŠ¡å™¨"
EOF
```

### 2. åœ¨DSLä¸­ä½¿ç”¨

```python
@name: "SSHé…ç½®ç¤ºä¾‹"

# åªéœ€æŒ‡å®šæœåŠ¡å™¨åç§°ï¼Œå…¶ä»–ä¿¡æ¯è‡ªåŠ¨ä»Žé…ç½®åŠ è½½
è¿žæŽ¥ç»“æžœ = [SSHæµ‹è¯•è¿žæŽ¥], æœåŠ¡å™¨: "my_server"

if ${è¿žæŽ¥ç»“æžœ.success} do
    # æ‰§è¡Œå‘½ä»¤
    ç»“æžœ = [SSHæ‰§è¡Œå‘½ä»¤], æœåŠ¡å™¨: "my_server", å‘½ä»¤: "ls -la"
    [æ‰“å°], å†…å®¹: "å‘½ä»¤è¾“å‡º: ${ç»“æžœ.stdout}"
end
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œ
pytest-dsl examples/enhanced_ssh_example.dsl --yaml-vars config/ssh_servers.yaml

# æˆ–è€…ä½¿ç”¨pytestæ–¹å¼
pytest test_runner.py --yaml-vars config/ssh_servers.yaml
```

## é«˜çº§åŠŸèƒ½

### 1. å‚æ•°è¦†ç›–

å³ä½¿é…ç½®äº†é»˜è®¤å€¼ï¼Œæ‚¨ä»ç„¶å¯ä»¥åœ¨ä½¿ç”¨æ—¶è¦†ç›–ç‰¹å®šå‚æ•°ï¼š

```python
# ä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤å€¼
ç»“æžœ1 = [SSHæ‰§è¡Œå‘½ä»¤], æœåŠ¡å™¨: "my_server", å‘½ä»¤: "whoami"

# è¦†ç›–é…ç½®ä¸­çš„ç«¯å£å’Œç”¨æˆ·å
ç»“æžœ2 = [SSHæ‰§è¡Œå‘½ä»¤], 
    æœåŠ¡å™¨: "my_server",
    å‘½ä»¤: "whoami",
    ç«¯å£: 2222,
    ç”¨æˆ·å: "root"
```

### 2. å¤šçŽ¯å¢ƒé…ç½®

æ‚¨å¯ä»¥ä¸ºä¸åŒçŽ¯å¢ƒåˆ›å»ºä¸åŒçš„é…ç½®æ–‡ä»¶ï¼š

```bash
config/
â”œâ”€â”€ dev_ssh_servers.yaml    # å¼€å‘çŽ¯å¢ƒ
â”œâ”€â”€ test_ssh_servers.yaml   # æµ‹è¯•çŽ¯å¢ƒ
â””â”€â”€ prod_ssh_servers.yaml   # ç”Ÿäº§çŽ¯å¢ƒ
```

ç„¶åŽæ ¹æ®çŽ¯å¢ƒé€‰æ‹©é…ç½®æ–‡ä»¶ï¼š

```bash
# å¼€å‘çŽ¯å¢ƒ
pytest-dsl tests/ --yaml-vars config/dev_ssh_servers.yaml

# ç”Ÿäº§çŽ¯å¢ƒ
pytest-dsl tests/ --yaml-vars config/prod_ssh_servers.yaml
```

### 3. é…ç½®ç»§æ‰¿

æ‚¨å¯ä»¥å°†é€šç”¨é…ç½®å’Œç‰¹å®šé…ç½®åˆ†å¼€ï¼š

```yaml
# config/base_ssh.yaml - åŸºç¡€é…ç½®
ssh_servers:
  base_server: &base_config
    port: 22
    connect_timeout: 10
    timeout: 30
    auto_add_host_keys: true

# config/dev_ssh.yaml - å¼€å‘çŽ¯å¢ƒé…ç½®  
ssh_servers:
  dev_server:
    <<: *base_config
    hostname: "dev.example.com"
    username: "developer"
    password: "dev_pass"
```

### 4. æ‰¹é‡æ“ä½œ

ä½¿ç”¨é…ç½®å¯ä»¥è½»æ¾è¿›è¡Œæ‰¹é‡æœåŠ¡å™¨æ“ä½œï¼š

```python
@name: "æ‰¹é‡æœåŠ¡å™¨æ£€æŸ¥"

# å®šä¹‰æœåŠ¡å™¨åˆ—è¡¨
æœåŠ¡å™¨åˆ—è¡¨ = ["web_server1", "web_server2", "db_server", "cache_server"]

for æœåŠ¡å™¨å in ${æœåŠ¡å™¨åˆ—è¡¨} do
    # åªéœ€è¦æœåŠ¡å™¨åï¼Œé…ç½®è‡ªåŠ¨åŠ è½½
    è¿žæŽ¥æµ‹è¯• = [SSHæµ‹è¯•è¿žæŽ¥], æœåŠ¡å™¨: ${æœåŠ¡å™¨å}
    
    if ${è¿žæŽ¥æµ‹è¯•.success} do
        # èŽ·å–ç³»ç»Ÿè´Ÿè½½
        è´Ÿè½½ä¿¡æ¯ = [SSHæ‰§è¡Œå‘½ä»¤], æœåŠ¡å™¨: ${æœåŠ¡å™¨å}, å‘½ä»¤: "uptime"
        [æ‰“å°], å†…å®¹: "${æœåŠ¡å™¨å} è´Ÿè½½: ${è´Ÿè½½ä¿¡æ¯.stdout}"
    else
        [æ‰“å°], å†…å®¹: "${æœåŠ¡å™¨å} è¿žæŽ¥å¤±è´¥"
    end
end
```

## å®‰å…¨æœ€ä½³å®žè·µ

### 1. ä½¿ç”¨ç§é’¥è®¤è¯

```yaml
ssh_servers:
  secure_server:
    hostname: "secure.example.com"
    username: "admin"
    private_key_path: "~/.ssh/secure_server_key"
    # ä¸è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨å¯†ç 
```

### 2. çŽ¯å¢ƒå˜é‡

å¯¹äºŽæ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼š

```yaml
ssh_servers:
  prod_server:
    hostname: "${PROD_SERVER_HOST}"
    username: "${PROD_SERVER_USER}"
    private_key_path: "${PROD_SERVER_KEY}"
```

### 3. æ–‡ä»¶æƒé™

ç¡®ä¿é…ç½®æ–‡ä»¶çš„æƒé™æ­£ç¡®ï¼š

```bash
chmod 600 config/ssh_servers.yaml
```

## æ•…éšœæŽ’é™¤

### 1. é…ç½®æœªåŠ è½½

å¦‚æžœé…ç½®æ²¡æœ‰è¢«åŠ è½½ï¼Œæ£€æŸ¥ï¼š

- é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- YAMLè¯­æ³•æ˜¯å¦æ­£ç¡®
- æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†`--yaml-vars`å‚æ•°

### 2. è¿žæŽ¥å¤±è´¥

å¦‚æžœè¿žæŽ¥å¤±è´¥ï¼Œæ£€æŸ¥ï¼š

- æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
- ç”¨æˆ·åå’Œå¯†ç /ç§é’¥æ˜¯å¦æ­£ç¡®
- ç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸
- é˜²ç«å¢™è®¾ç½®

### 3. è°ƒè¯•æ¨¡å¼

å¯ç”¨è°ƒè¯•æ—¥å¿—æ¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«
export PYTEST_DSL_LOG_LEVEL=DEBUG
pytest-dsl tests/ --yaml-vars config/ssh_servers.yaml
```

## ä¸Žæ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§

æ–°çš„é…ç½®ç³»ç»Ÿå®Œå…¨å‘åŽå…¼å®¹ã€‚æ‚¨å¯ä»¥ï¼š

1. ç»§ç»­ä½¿ç”¨æ—§çš„æ–¹å¼ï¼ˆæ‰‹åŠ¨æŒ‡å®šæ‰€æœ‰å‚æ•°ï¼‰
2. æ¸è¿›å¼è¿ç§»åˆ°æ–°çš„é…ç½®æ–¹å¼
3. æ··åˆä½¿ç”¨ä¸¤ç§æ–¹å¼

```python
# æ—§æ–¹å¼ä»ç„¶æœ‰æ•ˆ
ç»“æžœ1 = [SSHæ‰§è¡Œå‘½ä»¤], 
    æœåŠ¡å™¨: "192.168.1.100",
    ç”¨æˆ·å: "admin",
    å¯†ç : "password",
    å‘½ä»¤: "ls"

# æ–°æ–¹å¼æ›´ç®€æ´
ç»“æžœ2 = [SSHæ‰§è¡Œå‘½ä»¤], æœåŠ¡å™¨: "my_server", å‘½ä»¤: "ls"
```

## æ€»ç»“

é€šè¿‡SSHé…ç½®è‡ªåŠ¨åŠ è½½åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥ï¼š

- âœ… å‡å°‘é‡å¤é…ç½®
- âœ… æé«˜ä»£ç å¯ç»´æŠ¤æ€§
- âœ… ç®€åŒ–æµ‹è¯•è„šæœ¬
- âœ… æ”¯æŒå¤šçŽ¯å¢ƒéƒ¨ç½²
- âœ… å¢žå¼ºå®‰å…¨æ€§

ç«‹å³å¼€å§‹ä½¿ç”¨æ–°çš„SSHé…ç½®ç³»ç»Ÿï¼Œè®©æ‚¨çš„SSHæ“ä½œæ›´åŠ é«˜æ•ˆï¼ 