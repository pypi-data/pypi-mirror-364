# 答案之书功能设计文档

## 概述

本设计文档描述了如何在现有的MCP服务器中实现"答案之书"功能。该功能将通过添加一个新的MCP工具来实现，该工具能够检测用户输入中的特定关键词并生成神秘的回答。

## 架构

### 整体架构
```
用户输入 -> MCP客户端 -> MCP服务器 -> 答案之书工具 -> LLM采样 -> 神秘回答
```

### 组件说明
1. **MCP服务器**: 现有的FastMCP服务器，负责处理工具调用
2. **答案之书工具**: 新增的工具，负责检测关键词和生成回答
3. **关键词检测器**: 检测用户输入中是否包含触发词
4. **回答生成器**: 使用特定提示词生成神秘回答

## 组件和接口

### 答案之书工具 (AnswerBookTool)

**接口定义:**
```python
@mcp.tool()
def answer_book(user_input: str) -> str:
    """答案之书 - 为你的问题提供神秘的回答
    
    Args:
        user_input: 用户的输入文本
        
    Returns:
        神秘的回答或提示信息
    """
```

**功能职责:**
- 检测用户输入中是否包含触发关键词
- 如果包含关键词，生成神秘回答
- 如果不包含关键词，返回友好提示

### 关键词检测模块

**检测逻辑:**
- 检测"/答案之书"精确匹配
- 检测"答案之书"关键词（不区分大小写）
- 支持中文和可能的变体

**实现方式:**
```python
def detect_answer_book_trigger(text: str) -> bool:
    """检测是否包含答案之书触发词"""
    triggers = ["/答案之书", "答案之书"]
    text_lower = text.lower()
    return any(trigger.lower() in text_lower for trigger in triggers)
```

### 回答生成模块

**生成策略:**
- 使用预定义的神秘回答列表
- 随机选择回答以增加神秘感
- 确保回答简短且模棱两可

**回答示例:**
- "时机未到"
- "答案就在你心中"
- "或许是，或许不是"
- "静待花开"
- "一切皆有可能"

## 数据模型

### 输入数据模型
```python
class AnswerBookInput:
    user_input: str  # 用户输入的文本
```

### 输出数据模型
```python
class AnswerBookOutput:
    response: str    # 生成的回答或提示信息
    triggered: bool  # 是否触发了答案之书功能
```

## 错误处理

### 错误类型
1. **输入验证错误**: 用户输入为空或无效
2. **生成错误**: 回答生成过程中的异常

### 错误处理策略
- 对于输入验证错误，返回友好的提示信息
- 对于生成错误，返回默认的神秘回答
- 记录错误日志以便调试

## 测试策略

### 单元测试
- 测试关键词检测功能
- 测试回答生成功能
- 测试错误处理逻辑

### 集成测试
- 测试MCP工具调用
- 测试与现有服务器的集成
- 测试不同输入场景

### 用户验收测试
- 验证"/答案之书"指令触发
- 验证"答案之书"关键词触发
- 验证回答的神秘性和简短性