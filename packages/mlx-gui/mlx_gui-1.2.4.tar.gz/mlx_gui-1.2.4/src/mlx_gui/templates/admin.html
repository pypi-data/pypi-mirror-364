<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLX-GUI Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-loaded { background-color: #10b981; }
        .status-unloaded { background-color: #6b7280; }
        .status-loading {
            background-color: #f59e0b;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .status-failed { background-color: #ef4444; }
        .status-downloading {
            background-color: #3b82f6;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .progress-glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <nav class="glass shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-brain text-white text-2xl mr-3"></i>
                    <div>
                        <h1 class="text-white text-xl font-bold">MLX-GUI Admin</h1>
                        <div class="text-gray-300 text-xs">Version <span id="app-version">{{ version }}</span></div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm">
                        <span id="system-status" class="status-indicator status-loaded"></span>
                        <span>System Online</span>
                    </div>
                    <div class="text-white text-sm">
                        <i class="fas fa-memory mr-1"></i>
                        <span id="memory-usage">0GB / 0GB</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- System Status Card -->
            <div class="glass rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-server text-green-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-300 truncate">System Status</dt>
                            <dd class="text-lg font-medium text-white" id="system-health">Healthy</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Loaded Models Card -->
            <div class="glass rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-cubes text-blue-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-300 truncate">Loaded Models</dt>
                            <dd class="text-lg font-medium text-white" id="loaded-count">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Memory Usage Card -->
            <div class="glass rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-memory text-purple-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-300 truncate">Memory Usage</dt>
                            <dd class="text-lg font-medium text-white" id="memory-percent">0%</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Queue Size Card -->
            <div class="glass rounded-lg p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-list text-yellow-400 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-300 truncate">Queue Size</dt>
                            <dd class="text-lg font-medium text-white" id="queue-size">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="glass rounded-lg">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-600">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button class="tab-button active border-b-2 border-blue-400 py-4 px-1 text-blue-400 font-medium text-sm" data-tab="models">
                        <i class="fas fa-cubes mr-2"></i>Models
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-300 font-medium text-sm hover:text-white" data-tab="discover">
                        <i class="fas fa-search mr-2"></i>Discover
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-300 font-medium text-sm hover:text-white" data-tab="monitor">
                        <i class="fas fa-chart-line mr-2"></i>Monitor
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-300 font-medium text-sm hover:text-white" data-tab="api-test">
                        <i class="fas fa-code mr-2"></i>API Test
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-300 font-medium text-sm hover:text-white" data-tab="transcribe">
                        <i class="fas fa-microphone mr-2"></i>Transcribe
                    </button>
                    <button class="tab-button border-b-2 border-transparent py-4 px-1 text-gray-300 font-medium text-sm hover:text-white" data-tab="settings">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Models Tab -->
                <div id="models-tab" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white">Installed Models</h2>
                        <button onclick="refreshModels()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                    <div id="models-list" class="space-y-4">
                        <!-- Models will be loaded here -->
                    </div>
                </div>

                <!-- Discover Tab -->
                <div id="discover-tab" class="tab-content hidden">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-white mb-4">Discover MLX Models</h2>
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <input type="text" id="search-input" placeholder="Search models..."
                                       class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-blue-400 focus:outline-none">
                            </div>
                            <button onclick="searchModels()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                    </div>

                    <!-- Category buttons -->
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="loadTrendingModels()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm" style="background-color: #dc2626 !important;">
                                <i class="fas fa-fire mr-1"></i>Trending
                            </button>
                            <button onclick="loadPopularChat()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-comments mr-1"></i>Text
                            </button>
                            <button onclick="loadPopularSTT()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm" style="background-color: #ea580c !important;">
                                <i class="fas fa-microphone mr-1"></i>STT
                            </button>
                            <button onclick="loadVisionModels()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm" style="background-color: #9333ea !important;">
                                <i class="fas fa-eye mr-1"></i>Multimodal
                            </button>
                            <button onclick="loadCompatibleModels()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm" style="background-color: #0d9488 !important;">
                                <i class="fas fa-check mr-1"></i>Compatible
                            </button>
                            <button onclick="loadSmallModels()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-feather mr-1"></i>Small (&lt;10GB)
                            </button>
                            <button onclick="loadEmbeddingModels()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm" style="background-color: #059669 !important;">
                                <i class="fas fa-vector-square mr-1"></i>Embeddings
                            </button>
                        </div>
                    </div>

                    <div id="discover-results" class="space-y-4">
                        <!-- Search results will be loaded here -->
                    </div>
                </div>

                <!-- Monitor Tab -->
                <div id="monitor-tab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- System Info -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">System Information</h3>
                            <div id="system-info" class="space-y-3 text-sm text-gray-300">
                                <!-- System info will be loaded here -->
                            </div>
                        </div>

                        <!-- Model Statistics -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">Model Statistics</h3>
                            <div id="model-stats" class="space-y-3 text-sm text-gray-300">
                                <!-- Model stats will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Test Tab -->
                <div id="api-test-tab" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-white mb-6">API Test Console</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Panel -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">Test Configuration</h3>
                            
                            <!-- Model Selection -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Select Model</label>
                                <select id="test-model-select" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none">
                                    <option value="">Loading models...</option>
                                </select>
                            </div>

                            <!-- Message Input -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Message</label>
                                <textarea id="test-message" rows="4" 
                                    placeholder="Enter your test message here..."
                                    class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none resize-none"></textarea>
                            </div>

                            <!-- Advanced Options -->
                            <div class="mb-4">
                                <button onclick="toggleAdvancedOptions()" class="text-blue-400 hover:text-blue-300 text-sm">
                                    <i class="fas fa-chevron-right mr-1" id="advanced-chevron"></i>Advanced Options
                                </button>
                                <div id="advanced-options" class="hidden mt-3 space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Max Tokens</label>
                                            <input type="number" id="test-max-tokens" value="512" min="1" max="4096"
                                                class="w-full px-2 py-1 bg-gray-700 text-white rounded border border-gray-600 text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">Temperature</label>
                                            <input type="number" id="test-temperature" value="0.7" min="0" max="2" step="0.1"
                                                class="w-full px-2 py-1 bg-gray-700 text-white rounded border border-gray-600 text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">System Message (optional)</label>
                                        <textarea id="test-system-message" rows="2" 
                                            placeholder="You are a helpful assistant..."
                                            class="w-full px-2 py-1 bg-gray-700 text-white rounded border border-gray-600 text-sm resize-none"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Button -->
                            <button onclick="testApiCall()" id="test-api-button" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                                <i class="fas fa-play mr-2"></i>Send Test Request
                            </button>
                        </div>

                        <!-- Response Panel -->
                        <div class="bg-gray-800 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white">Response</h3>
                                <button onclick="clearTestResults()" class="text-gray-400 hover:text-white text-sm">
                                    <i class="fas fa-trash mr-1"></i>Clear
                                </button>
                            </div>
                            
                            <!-- Response Display -->
                            <div id="test-response" class="bg-gray-900 rounded p-4 min-h-[300px] max-h-[500px] overflow-y-auto">
                                <div class="text-gray-500 text-center py-8">
                                    <i class="fas fa-comment-dots text-3xl mb-2"></i>
                                    <p>Response will appear here</p>
                                </div>
                            </div>

                            <!-- Response Stats -->
                            <div id="test-stats" class="hidden mt-4 text-xs text-gray-400 space-y-1">
                                <div>Response Time: <span id="response-time">-</span>ms</div>
                                <div>Tokens Generated: <span id="tokens-generated">-</span></div>
                                <div>Model: <span id="response-model">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Request History -->
                    <div class="mt-6 bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-white">Request History</h3>
                            <button onclick="clearTestHistory()" class="text-gray-400 hover:text-white text-sm">
                                <i class="fas fa-history mr-1"></i>Clear History
                            </button>
                        </div>
                        <div id="test-history" class="space-y-2 max-h-[200px] overflow-y-auto">
                            <div class="text-gray-500 text-center py-4">
                                <p class="text-sm">No tests run yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transcribe Tab -->
                <div id="transcribe-tab" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-white mb-6">Audio Transcription</h2>
                    
                    <div class="bg-gray-800 rounded-lg p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Audio File</label>
                            <input type="file" id="audio-file" accept="audio/*" 
                                class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">
                                Supported formats: WAV, MP3, MP4, M4A, FLAC, OGG, WebM
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Audio Model</label>
                            <select id="whisper-model" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none">
                                <option value="">Loading available models...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                Only shows locally installed audio transcription models (Whisper, Parakeet, etc.)
                            </p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Language (optional)</label>
                            <select id="transcribe-language" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none">
                                <option value="">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="it">Italian</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="zh">Chinese</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Response Format</label>
                            <select id="response-format" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-400 focus:outline-none">
                                <option value="json">JSON (text only)</option>
                                <option value="verbose_json">Verbose JSON (with segments)</option>
                                <option value="text">Plain text</option>
                            </select>
                        </div>
                        
                        <button onclick="transcribeAudio()" id="transcribe-button" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                            <i class="fas fa-microphone mr-2"></i>Transcribe Audio
                        </button>
                        
                        <div id="transcribe-result" class="mt-6 hidden">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-bold text-white">Transcription Result</h3>
                                <button onclick="clearTranscribeResult()" class="text-gray-400 hover:text-white text-sm">
                                    <i class="fas fa-trash mr-1"></i>Clear
                                </button>
                            </div>
                            <div id="transcribe-text" class="bg-gray-900 rounded p-4 text-white whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
                            <div id="transcribe-info" class="mt-2 text-xs text-gray-400"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content hidden">
                    <h2 class="text-xl font-bold text-white mb-6">Settings</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">Model Management</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Auto-unload Inactive Models</label>
                                    <input type="checkbox" id="auto-unload" class="rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Inactivity Timeout (minutes)</label>
                                    <input type="number" id="timeout-minutes" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">System Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Max Concurrent Models</label>
                                    <input type="number" id="max-models" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Log Level</label>
                                    <select id="log-level" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
                                        <option value="DEBUG">Debug</option>
                                        <option value="INFO">Info</option>
                                        <option value="WARNING">Warning</option>
                                        <option value="ERROR">Error</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800 rounded-lg p-6">
                            <h3 class="text-lg font-bold text-white mb-4">Network Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Server Port</label>
                                    <input type="number" id="server-port" min="1" max="65535" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
                                    <p class="text-xs text-gray-500 mt-1">
                                        Port number for the server (1-65535). Default is 8000.
                                    </p>
                                </div>
                                <div>
                                    <label class="flex items-center text-sm font-medium text-gray-300">
                                        <input type="checkbox" id="bind-all-interfaces" class="rounded mr-2">
                                        Bind to All Interfaces
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Allow access from other devices on your network (0.0.0.0).
                                        <span class="text-yellow-400">⚠️ Security Risk:</span> Only enable on trusted networks.
                                    </p>
                                </div>
                                <div>
                                    <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                        <i class="fas fa-save mr-2"></i>Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-gray-400 text-sm">
        <p>MLX-GUI - Apple Silicon AI Model Server v{{ version }}</p>
        <p>
            By <strong>Matthew Rogers</strong>
            (<a href="https://github.com/RamboRogers" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300">@RamboRogers</a>)
        </p>
        <p>
            <a href="https://github.com/RamboRogers/mlx-gui" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300">
                <i class="fab fa-github mr-1"></i>View on GitHub
            </a>
            |
            <a href="https://www.gnu.org/licenses/gpl-3.0" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300">
                GPL v3 License
            </a>
        </p>
    </footer>

    <!-- Enhanced Loading Modal with Progress -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="glass rounded-lg p-8 text-center max-w-md w-full mx-4">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4" id="loading-icon"></i>
            <p class="text-white text-lg mb-2" id="loading-text">Loading...</p>
            <div id="loading-details" class="text-gray-300 text-sm mb-4 hidden">
                <div class="flex justify-between mb-1">
                    <span id="loading-stage">Initializing...</span>
                    <span id="loading-time">0s</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                    <div id="loading-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300 progress-glow" style="width: 0%"></div>
                </div>
                <div id="loading-status" class="text-xs text-gray-400"></div>
            </div>
            <button id="cancel-loading" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm hidden">
                <i class="fas fa-times mr-1"></i>Cancel
            </button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 glass rounded-lg p-4 hidden z-50">
        <div class="flex items-center">
            <i id="toast-icon" class="fas fa-check-circle text-green-400 mr-3"></i>
            <span id="toast-message" class="text-white"></span>
        </div>
    </div>

    <!-- Restart Confirmation Dialog -->
    <div id="restart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="glass rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-sync-alt text-4xl text-yellow-400 mb-4"></i>
                <h3 class="text-xl font-bold text-white mb-4">Server Restart Required</h3>
                <p class="text-gray-300 mb-6">
                    Network settings have changed (port or bind settings). The server needs to restart for changes to take effect.
                </p>
                <div class="flex space-x-4">
                    <button onclick="restartServerNow()" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-sync-alt mr-2"></i>Restart Now
                    </button>
                    <button onclick="closeRestartDialog()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-clock mr-2"></i>Later
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentModels = [];
        let systemStatus = {};
        let progressPollingInterval = null;
        let loadingStartTime = null;

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-400', 'text-blue-400');
                btn.classList.add('border-transparent', 'text-gray-300');
            });

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'border-blue-400', 'text-blue-400');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-300');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Load tab-specific data
            if (tabName === 'models') {
                refreshModels();
            } else if (tabName === 'monitor') {
                loadSystemInfo();
            } else if (tabName === 'api-test') {
                loadTestModels();
            } else if (tabName === 'transcribe') {
                loadTranscriptionModels();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Enhanced progress tracking functions
        function showProgressModal(text = 'Loading...', showProgress = false) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-modal').classList.remove('hidden');

            if (showProgress) {
                document.getElementById('loading-details').classList.remove('hidden');
                document.getElementById('loading-stage').textContent = 'Preparing...';
                document.getElementById('loading-time').textContent = '0s';
                document.getElementById('loading-progress').style.width = '0%';
                document.getElementById('loading-status').textContent = '';
                loadingStartTime = Date.now();
            } else {
                document.getElementById('loading-details').classList.add('hidden');
            }
        }

        function hideProgressModal() {
            document.getElementById('loading-modal').classList.add('hidden');
            document.getElementById('loading-details').classList.add('hidden');
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
            loadingStartTime = null;
        }

        function updateProgress(stage, progress, status, elapsed) {
            document.getElementById('loading-stage').textContent = stage;
            document.getElementById('loading-progress').style.width = `${progress}%`;
            document.getElementById('loading-status').textContent = status;

            if (elapsed !== undefined) {
                document.getElementById('loading-time').textContent = `${elapsed}s`;
            } else if (loadingStartTime) {
                const elapsedSeconds = Math.floor((Date.now() - loadingStartTime) / 1000);
                document.getElementById('loading-time').textContent = `${elapsedSeconds}s`;
            }
        }

        // Legacy functions for compatibility
        function showLoading(text = 'Loading...') {
            showProgressModal(text, false);
        }

        function hideLoading() {
            hideProgressModal();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const messageEl = document.getElementById('toast-message');

            let iconClass = 'fas fa-check-circle text-green-400 mr-3';
            if (type === 'error') {
                iconClass = 'fas fa-exclamation-circle text-red-400 mr-3';
            } else if (type === 'warning') {
                iconClass = 'fas fa-exclamation-triangle text-yellow-400 mr-3';
            }

            icon.className = iconClass;
            messageEl.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 GB';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb.toFixed(1) + ' GB';
        }

        function getStatusClass(status) {
            switch (status) {
                case 'loaded': return 'status-loaded';
                case 'loading': return 'status-loading';
                case 'downloading': return 'status-downloading';
                case 'failed': return 'status-failed';
                default: return 'status-unloaded';
            }
        }

        function getModelTypeClass(modelType) {
            switch (modelType) {
                case 'text': return 'bg-blue-700 text-blue-300';
                case 'multimodal': return 'bg-purple-700 text-purple-300';
                case 'vision': return 'bg-pink-700 text-pink-300';
                case 'audio': return 'bg-orange-700 text-orange-300';
                case 'embedding': return 'bg-emerald-700 text-emerald-300';
                default: return 'bg-gray-700 text-gray-300';
            }
        }

        function getModelTypeLabel(modelType) {
            switch (modelType) {
                case 'text': return 'Text';
                case 'multimodal': return 'Multimodal';
                case 'vision': return 'Vision';
                case 'audio': return 'Audio';
                case 'embedding': return 'Embedding';
                default: return modelType || 'Unknown';
            }
        }

                        function formatLocalTime(utcTimeString) {
            if (!utcTimeString) return '';
            try {
                // Debug: Log the original timestamp
                console.debug('Formatting timestamp:', utcTimeString);

                // Ensure the UTC time string is properly formatted for parsing
                let dateString = utcTimeString;

                // If it doesn't end with 'Z' or have timezone info, assume it's UTC
                if (!dateString.includes('Z') && !dateString.includes('+') && !dateString.includes('-', 10)) {
                    dateString = dateString + 'Z';
                    console.debug('Added Z suffix:', dateString);
                }

                // Parse the UTC time string and convert to local time
                const utcDate = new Date(dateString);

                // Check if the date is valid
                if (isNaN(utcDate.getTime())) {
                    console.error('Invalid date:', utcTimeString);
                    return utcTimeString;
                }

                // Debug: Log the parsed date
                console.debug('Parsed date (local):', utcDate.toString());
                console.debug('Current time:', new Date().toString());

                // Format as local date/time with a more readable format
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                };

                const formatted = utcDate.toLocaleString(undefined, options);
                console.debug('Formatted result:', formatted);

                return formatted;
            } catch (error) {
                console.error('Error formatting time:', error, 'Input:', utcTimeString);
                return utcTimeString; // Fallback to original string
            }
        }

        // API functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showToast(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Dashboard functions
        async function updateDashboard() {
            try {
                const status = await apiCall('/v1/system/status');
                systemStatus = status;

                // Update dashboard cards
                document.getElementById('system-health').textContent = status.status === 'running' ? 'Healthy' : 'Unhealthy';
                document.getElementById('loaded-count').textContent = status.model_manager.loaded_models_count;
                document.getElementById('memory-percent').textContent = status.model_manager.memory_usage_percent.toFixed(1) + '%';
                document.getElementById('queue-size').textContent = status.model_manager.queue_size;

                // Update header
                document.getElementById('memory-usage').textContent =
                    `${status.model_manager.total_model_memory_gb.toFixed(1)}GB / ${status.system.memory.total_gb.toFixed(1)}GB`;
            } catch (error) {
                console.error('Failed to update dashboard:', error);
            }
        }

        // Model management functions
        async function refreshModels(silent = false) {
            try {
                if (!silent) {
                    showLoading('Loading models...');
                }
                const response = await apiCall('/v1/manager/models');
                currentModels = response.models || [];
                renderModels();

                // Auto-refresh if any models are in loading state
                const hasLoadingModels = currentModels.some(m => m.status === 'loading' || m.status === 'downloading');
                if (hasLoadingModels && !progressPollingInterval) {
                    setTimeout(() => refreshModels(true), 3000); // Refresh again in 3 seconds
                }
            } catch (error) {
                if (!silent) {
                    showToast('Failed to load models', 'error');
                }
            } finally {
                if (!silent) {
                    hideLoading();
                }
            }
        }

        function renderModels() {
            const container = document.getElementById('models-list');

            if (currentModels.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-cube text-gray-500 text-4xl mb-4"></i>
                        <p class="text-gray-400">No models installed</p>
                        <p class="text-gray-500 text-sm">Use the Discover tab to find and install models</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentModels.map(model => `
                <div class="bg-gray-800 rounded-lg p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="status-indicator ${getStatusClass(model.status)}"
                                      ${model.status === 'loading' ? 'title="Model is currently loading..."' : ''}
                                      ${model.status === 'downloading' ? 'title="Model is downloading from HuggingFace..."' : ''}></span>
                                <h3 class="text-lg font-medium text-white">
                                    ${model.huggingface_id ?
                                        `<a href="https://huggingface.co/${model.huggingface_id}" target="_blank" rel="noopener noreferrer"
                                           class="hover:text-blue-300 transition-colors cursor-pointer">
                                            ${model.name}
                                        </a>` :
                                        model.name
                                    }
                                </h3>
                                <span class="ml-2 px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded">${model.type}</span>
                                ${model.author && model.author !== 'unknown' ?
                                    `<span class="ml-2 px-2 py-1 text-xs bg-purple-700 text-purple-300 rounded">
                                        <i class="fas fa-user mr-1"></i>${model.author}
                                    </span>` : ''
                                }
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-400">
                                <span><i class="fas fa-memory mr-1"></i>${model.memory_required_gb} GB</span>
                                <span><i class="fas fa-clock mr-1"></i>Used ${model.use_count} times</span>
                                ${model.last_used_at ? `<span><i class="fas fa-history mr-1"></i>${formatLocalTime(model.last_used_at)}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${model.status === 'loaded' ?
                                `<button onclick="unloadModel('${model.name}')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-stop mr-1"></i>Unload
                                </button>` :
                                `<button onclick="loadModel('${model.name}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-play mr-1"></i>Load
                                </button>`
                            }
                            <button onclick="removeModel('${model.name}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadModel(modelName) {
            try {
                // Show enhanced progress modal
                showProgressModal(`Loading ${modelName}...`, true);
                updateProgress('Initializing...', 5, 'Starting model loading process');

                // Start the loading request (non-blocking)
                const loadPromise = apiCall(`/v1/models/${modelName}/load`, { method: 'POST' });

                // Start progress polling
                await pollModelLoadingProgress(modelName, loadPromise);

                showToast(`Model ${modelName} loaded successfully`);
                refreshModels();
                updateDashboard();
            } catch (error) {
                showToast(`Failed to load ${modelName}`, 'error');
            } finally {
                hideProgressModal();
            }
        }

        async function pollModelLoadingProgress(modelName, loadPromise) {
            return new Promise((resolve, reject) => {
                let pollCount = 0;
                let lastStatus = null;
                let lastProgress = 0;

                progressPollingInterval = setInterval(async () => {
                    try {
                        pollCount++;
                        const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);

                        // Check model status with real progress data
                        const statusResponse = await apiCall(`/v1/manager/models/${modelName}/status`);
                        const status = statusResponse.status;

                        if (status !== lastStatus) {
                            lastStatus = status;
                            console.log(`Model ${modelName} status changed to: ${status}`);
                        }

                        // Update progress based on REAL server data
                        if (status === 'loading') {
                            // Use real download progress if available
                            const realProgress = statusResponse.download_progress || 0;
                            const downloadStage = statusResponse.download_stage || 'Loading...';
                            const downloadStatus = statusResponse.download_status || 'unknown';
                            const downloadedMB = statusResponse.downloaded_mb || 0;
                            const totalMB = statusResponse.total_mb || 0;
                            const speedMbps = statusResponse.download_speed_mbps || 0;
                            const etaSeconds = statusResponse.download_eta_seconds || 0;

                            // Build detailed status message
                            let statusMessage = downloadStage;
                            if (downloadedMB > 0 && totalMB > 0) {
                                statusMessage = `Downloaded ${downloadedMB}MB/${totalMB}MB`;
                                if (speedMbps > 0) {
                                    statusMessage += ` (${speedMbps.toFixed(1)}MB/s)`;
                                }
                                if (etaSeconds > 0) {
                                    const minutes = Math.floor(etaSeconds / 60);
                                    const seconds = Math.floor(etaSeconds % 60);
                                    statusMessage += ` - ETA: ${minutes}m ${seconds}s`;
                                }
                            } else if (elapsed > 0) {
                                statusMessage += ` (${elapsed}s elapsed)`;
                            }

                            // Use real progress or fallback to minimal simulation
                            const progress = realProgress > 0 ? realProgress : Math.min(pollCount * 0.5, 5);

                            // Only update if progress actually changed (avoid fake updates)
                            if (Math.abs(progress - lastProgress) > 0.1 || downloadStage !== lastStatus) {
                                updateProgress(downloadStage, progress, statusMessage, elapsed);
                                lastProgress = progress;
                            }

                        } else if (status === 'loaded') {
                            updateProgress('Completed!', 100, 'Model loaded successfully', elapsed);
                            clearInterval(progressPollingInterval);
                            progressPollingInterval = null;
                            resolve();
                            return;
                        } else if (status === 'failed') {
                            clearInterval(progressPollingInterval);
                            progressPollingInterval = null;
                            reject(new Error('Model loading failed'));
                            return;
                        }

                        // Check if the main loading promise completed
                        if (loadPromise && loadPromise.then) {
                            loadPromise.then(() => {
                                updateProgress('Completed!', 100, 'Model loaded successfully');
                                clearInterval(progressPollingInterval);
                                progressPollingInterval = null;
                                resolve();
                            }).catch((error) => {
                                clearInterval(progressPollingInterval);
                                progressPollingInterval = null;
                                reject(error);
                            });
                            loadPromise = null; // Prevent multiple handlers
                        }

                    } catch (error) {
                        console.warn('Progress polling error:', error);
                        // Continue polling unless it's a critical error
                        if (pollCount > 300) { // 5 minutes timeout (more realistic for large downloads)
                            clearInterval(progressPollingInterval);
                            progressPollingInterval = null;
                            reject(new Error('Loading timeout - please check server logs for details'));
                        }
                    }
                }, 1000); // Poll every second
            });
        }

        async function unloadModel(modelName) {
            try {
                showLoading(`Unloading ${modelName}...`);
                await apiCall(`/v1/models/${modelName}/unload`, { method: 'POST' });
                showToast(`Model ${modelName} unloaded successfully`);
                refreshModels();
                updateDashboard();
            } catch (error) {
                showToast(`Failed to unload ${modelName}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function removeModel(modelName) {
            if (!confirm(`Are you sure you want to remove ${modelName}?\n\nThis will:\n• Unload the model from memory\n• Remove it from the database\n• Delete downloaded files (use Shift+Click to keep files)`)) return;

            try {
                showLoading(`Removing ${modelName}...`);

                // Check if Shift key was held to keep files
                const keepFiles = event.shiftKey;
                const url = keepFiles ?
                    `/v1/models/${modelName}?remove_files=false` :
                    `/v1/models/${modelName}`;

                await apiCall(url, { method: 'DELETE' });

                const message = keepFiles ?
                    `Model ${modelName} removed successfully (files kept)` :
                    `Model ${modelName} and files removed successfully`;

                showToast(message);
                refreshModels();
                updateDashboard();
            } catch (error) {
                showToast(`Failed to remove ${modelName}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Model discovery functions
        async function searchModels() {
            const query = document.getElementById('search-input').value;
            try {
                showLoading('Searching models...');
                const response = await apiCall(`/v1/discover/models?query=${encodeURIComponent(query)}&limit=20`);
                renderDiscoveryResults(response.models || []);
            } catch (error) {
                showToast('Failed to search models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadPopularChat() {
            try {
                showLoading('Loading popular chat models...');
                const response = await apiCall('/v1/discover/categories');
                const chatModels = response.categories['Popular Chat'] || [];
                const modelDetails = await Promise.all(
                    chatModels.slice(0, 10).map(async (modelId) => {
                        try {
                            const detail = await apiCall(`/v1/discover/models/${encodeURIComponent(modelId)}`);
                            return detail;
                        } catch (e) {
                            return null;
                        }
                    })
                );
                renderDiscoveryResults(modelDetails.filter(m => m !== null));
            } catch (error) {
                showToast('Failed to load popular chat models', 'error');
            } finally {
                hideLoading();
            }
        }


        async function loadPopularSTT() {
            try {
                showLoading('Loading STT models...');
                // Use the dedicated STT models endpoint
                const response = await apiCall('/v1/discover/stt?limit=10');
                const sttModels = response.models || [];
                renderDiscoveryResults(sttModels);
            } catch (error) {
                showToast('Failed to load STT models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadVisionModels() {
            try {
                showLoading('Loading vision models...');
                // Use the dedicated vision models endpoint
                const response = await apiCall('/v1/discover/vision?limit=10');
                const visionModels = response.models || [];
                renderDiscoveryResults(visionModels);
            } catch (error) {
                showToast('Failed to load vision models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadCompatibleModels() {
            try {
                showLoading('Loading compatible models...');
                const response = await apiCall('/v1/discover/compatible?limit=20');
                renderDiscoveryResults(response.models || []);
            } catch (error) {
                showToast('Failed to load compatible models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadSmallModels() {
            try {
                showLoading('Loading small models...');
                const response = await apiCall('/v1/discover/models?query=4bit&limit=20');
                const smallModels = (response.models || []).filter(m => m.size_gb && m.size_gb < 10);
                renderDiscoveryResults(smallModels);
            } catch (error) {
                showToast('Failed to load small models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadTrendingModels() {
            try {
                showLoading('Loading trending models...');
                const response = await apiCall('/v1/discover/trending?limit=20');
                renderDiscoveryResults(response.models || []);
            } catch (error) {
                showToast('Failed to load trending models', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadEmbeddingModels() {
            try {
                showLoading('Loading embedding models...');
                const response = await apiCall('/v1/discover/embeddings?limit=20');
                renderDiscoveryResults(response.models || []);
            } catch (error) {
                showToast('Failed to load embedding models', 'error');
            } finally {
                hideLoading();
            }
        }

        function renderDiscoveryResults(models) {
            const container = document.getElementById('discover-results');

            if (models.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-gray-500 text-4xl mb-4"></i>
                        <p class="text-gray-400">No models found</p>
                        <p class="text-gray-500 text-sm">Try a different search term</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = models.map(model => `
                <div class="bg-gray-800 rounded-lg p-4 card-hover">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h3 class="text-lg font-medium text-white">
                                    <a href="https://huggingface.co/${model.id}" target="_blank" rel="noopener noreferrer"
                                       class="hover:text-blue-300 transition-colors cursor-pointer">
                                        ${model.name}
                                    </a>
                                </h3>
                                <span class="ml-2 px-2 py-1 text-xs ${getModelTypeClass(model.model_type)} rounded">${getModelTypeLabel(model.model_type)}</span>
                                ${model.mlx_compatible ? '<span class="ml-2 px-2 py-1 text-xs bg-green-700 text-green-300 rounded">MLX</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-400 mb-2">${model.description || 'No description available'}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-400">
                                <span><i class="fas fa-download mr-1"></i>${model.downloads?.toLocaleString() || '0'}</span>
                                <span><i class="fas fa-heart mr-1"></i>${model.likes || '0'}</span>
                                ${model.size_gb && model.size_gb > 0 ? `<span><i class="fas fa-memory mr-1"></i>${model.size_gb.toFixed(1)} GB</span>` : ''}
                                <span><i class="fas fa-user mr-1"></i>${model.author}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="installModel('${model.id}', '${model.name.replace(/'/g, "\\'")}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                <i class="fas fa-download mr-1"></i>Install
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function installModel(modelId, modelName) {
            try {
                // Show enhanced progress modal for installation
                showProgressModal(`Installing ${modelName}...`, true);
                updateProgress('Preparing installation...', 5, 'Validating model information');

                const sanitizedName = modelName.toLowerCase().replace(/[^a-z0-9-]/g, '-');

                // Start installation
                updateProgress('Downloading model files...', 15, 'Contacting HuggingFace repository');

                const installPromise = apiCall('/v1/models/install', {
                    method: 'POST',
                    body: JSON.stringify({
                        model_id: modelId,
                        name: sanitizedName
                    })
                });

                // Simulate installation progress
                const progressSteps = [
                    { progress: 25, stage: 'Downloading model files...', status: 'Fetching model configuration' },
                    { progress: 45, stage: 'Downloading model files...', status: 'Downloading model weights' },
                    { progress: 70, stage: 'Processing files...', status: 'Validating downloaded files' },
                    { progress: 85, stage: 'Installing model...', status: 'Setting up model in database' },
                    { progress: 95, stage: 'Finalizing...', status: 'Completing installation' }
                ];

                let stepIndex = 0;
                const progressInterval = setInterval(() => {
                    if (stepIndex < progressSteps.length) {
                        const step = progressSteps[stepIndex];
                        updateProgress(step.stage, step.progress, step.status);
                        stepIndex++;
                    }
                }, 2000); // Update every 2 seconds

                // Wait for installation to complete
                await installPromise;

                clearInterval(progressInterval);
                updateProgress('Installation complete!', 100, 'Model installed successfully');

                showToast(`Model ${modelName} installed successfully`);
                // Switch to models tab and refresh
                setTimeout(() => {
                    switchTab('models');
                }, 1000);

            } catch (error) {
                showToast(`Failed to install ${modelName}`, 'error');
            } finally {
                setTimeout(() => {
                    hideProgressModal();
                }, 1500); // Brief delay to show completion
            }
        }

        // Monitor functions
        async function loadSystemInfo() {
            try {
                const status = await apiCall('/v1/system/status');
                const systemInfo = document.getElementById('system-info');
                const modelStats = document.getElementById('model-stats');

                systemInfo.innerHTML = `
                    <div><strong>Platform:</strong> ${status.system.platform} ${status.system.architecture}</div>
                    <div><strong>Processor:</strong> ${status.system.processor}</div>
                    <div><strong>Apple Silicon:</strong> ${status.system.is_apple_silicon ? 'Yes' : 'No'}</div>
                    <div><strong>MLX Compatible:</strong> ${status.system.mlx_compatible ? 'Yes' : 'No'}</div>
                    <div><strong>Total Memory:</strong> ${status.system.memory.total_gb.toFixed(1)} GB</div>
                    <div><strong>Available Memory:</strong> ${status.system.memory.available_gb.toFixed(1)} GB</div>
                    <div><strong>Memory Usage:</strong> ${status.system.memory.percent_used.toFixed(1)}%</div>
                `;

                modelStats.innerHTML = `
                    <div><strong>Loaded Models:</strong> ${status.model_manager.loaded_models_count}</div>
                    <div><strong>Max Concurrent:</strong> ${status.model_manager.max_concurrent_models}</div>
                    <div><strong>Queue Size:</strong> ${status.model_manager.queue_size}</div>
                    <div><strong>Model Memory:</strong> ${status.model_manager.total_model_memory_gb.toFixed(1)} GB</div>
                    <div><strong>Memory Usage:</strong> ${status.model_manager.memory_usage_percent.toFixed(1)}%</div>
                    <div><strong>Auto-unload:</strong> ${status.model_manager.auto_unload_enabled ? 'Enabled' : 'Disabled'}</div>
                    <div><strong>Timeout:</strong> ${status.model_manager.inactivity_timeout_minutes} min</div>
                `;
            } catch (error) {
                showToast('Failed to load system info', 'error');
            }
        }

        // Settings functions
        async function loadSettings() {
            try {
                const settings = await apiCall('/v1/settings');
                document.getElementById('auto-unload').checked = settings.auto_unload_inactive_models;
                document.getElementById('timeout-minutes').value = settings.model_inactivity_timeout_minutes;
                document.getElementById('max-models').value = settings.max_concurrent_models;
                document.getElementById('log-level').value = settings.log_level;
                document.getElementById('server-port').value = settings.server_port;
                document.getElementById('bind-all-interfaces').checked = settings.bind_to_all_interfaces;
            } catch (error) {
                showToast('Failed to load settings', 'error');
            }
        }

        async function saveSettings() {
            try {
                showLoading('Saving settings...');

                // Get current settings to check for changes
                const currentSettings = await apiCall('/v1/settings');

                const newSettings = {
                    auto_unload_inactive_models: document.getElementById('auto-unload').checked,
                    model_inactivity_timeout_minutes: parseInt(document.getElementById('timeout-minutes').value),
                    max_concurrent_models: parseInt(document.getElementById('max-models').value),
                    log_level: document.getElementById('log-level').value,
                    server_port: parseInt(document.getElementById('server-port').value),
                    bind_to_all_interfaces: document.getElementById('bind-all-interfaces').checked
                };

                // Check if network settings changed
                const networkSettingsChanged =
                    currentSettings.server_port !== newSettings.server_port ||
                    currentSettings.bind_to_all_interfaces !== newSettings.bind_to_all_interfaces;

                // Save each setting
                for (const [key, value] of Object.entries(newSettings)) {
                    await apiCall(`/v1/settings/${key}`, {
                        method: 'PUT',
                        body: JSON.stringify({ value })
                    });
                }

                showToast('Settings saved successfully');

                // If network settings changed, offer immediate restart
                if (networkSettingsChanged) {
                    setTimeout(() => {
                        showRestartDialog();
                    }, 500);
                }

            } catch (error) {
                showToast('Failed to save settings', 'error');
            } finally {
                hideLoading();
            }
        }

        // Restart dialog functions
        function showRestartDialog() {
            document.getElementById('restart-modal').classList.remove('hidden');
        }

        function closeRestartDialog() {
            document.getElementById('restart-modal').classList.add('hidden');
        }

        async function restartServerNow() {
            try {
                showLoading('Restarting server...');
                closeRestartDialog();

                // Call restart endpoint
                await apiCall('/v1/system/restart', {
                    method: 'POST'
                });

                // Show success message
                showToast('Server restarting... Please wait a moment then refresh the page.', 'success');

                // Auto-refresh page after delay
                setTimeout(() => {
                    window.location.reload();
                }, 5000);

            } catch (error) {
                showToast('Failed to restart server. Please restart manually.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Audio Transcription functions
        async function transcribeAudio() {
            const fileInput = document.getElementById('audio-file');
            const modelSelect = document.getElementById('whisper-model');
            const languageSelect = document.getElementById('transcribe-language');
            const formatSelect = document.getElementById('response-format');
            const button = document.getElementById('transcribe-button');
            
            if (!fileInput.files[0]) {
                showToast('Please select an audio file', 'error');
                return;
            }
            
            const originalButtonText = button.innerHTML;
            
            try {
                // Update button state
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Transcribing...';
                button.disabled = true;
                
                // Show loading
                showLoading('Transcribing audio...');
                
                // Prepare form data
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('model', modelSelect.value);
                formData.append('response_format', formatSelect.value);
                
                if (languageSelect.value) {
                    formData.append('language', languageSelect.value);
                }
                
                // Record start time
                const startTime = Date.now();
                
                // Make API call
                const response = await fetch('/v1/audio/transcriptions', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                // Calculate response time
                const responseTime = Date.now() - startTime;
                
                // Handle different response formats
                let result;
                let displayText;
                
                if (formatSelect.value === 'text') {
                    displayText = await response.text();
                    result = { text: displayText };
                } else {
                    result = await response.json();
                    displayText = result.text || JSON.stringify(result, null, 2);
                }
                
                // Display result
                document.getElementById('transcribe-text').textContent = displayText;
                document.getElementById('transcribe-info').textContent = 
                    `Model: ${modelSelect.value} | Language: ${languageSelect.value || 'auto-detect'} | Time: ${responseTime}ms | Format: ${formatSelect.value}`;
                document.getElementById('transcribe-result').classList.remove('hidden');
                
                showToast('Transcription completed successfully!');
                
            } catch (error) {
                console.error('Transcription error:', error);
                showToast(`Transcription failed: ${error.message}`, 'error');
            } finally {
                // Restore button
                button.innerHTML = originalButtonText;
                button.disabled = false;
                hideLoading();
            }
        }
        
        function clearTranscribeResult() {
            document.getElementById('transcribe-result').classList.add('hidden');
            document.getElementById('transcribe-text').textContent = '';
            document.getElementById('transcribe-info').textContent = '';
        }

        // API Testing functions
        let testHistory = [];

        async function loadTestModels() {
            try {
                const response = await apiCall('/v1/manager/models');
                const models = response.models || [];
                const loadedModels = models.filter(m => m.status === 'loaded');
                
                const select = document.getElementById('test-model-select');
                
                if (loadedModels.length === 0) {
                    select.innerHTML = '<option value="">No loaded models available</option>';
                    return;
                }
                
                select.innerHTML = loadedModels.map(model => 
                    `<option value="${model.name}">${model.name} (${model.type})</option>`
                ).join('');
                
                // Select first model by default
                if (loadedModels.length > 0) {
                    select.value = loadedModels[0].name;
                }
            } catch (error) {
                console.error('Failed to load test models:', error);
                document.getElementById('test-model-select').innerHTML = '<option value="">Error loading models</option>';
            }
        }

        async function loadTranscriptionModels() {
            try {
                const response = await apiCall('/v1/manager/models');
                const models = response.models || [];
                
                // Filter for installed audio models (any status - we'll auto-load if needed)
                const audioModels = models.filter(m => 
                    (m.type === 'audio' || 
                     m.type === 'whisper' ||
                     m.name.toLowerCase().includes('whisper') ||
                     m.name.toLowerCase().includes('parakeet') ||
                     m.name.toLowerCase().includes('speech') ||
                     m.name.toLowerCase().includes('asr'))
                );
                
                const select = document.getElementById('whisper-model');
                
                if (audioModels.length === 0) {
                    select.innerHTML = '<option value="">Install a STT Model</option>';
                    return;
                }
                
                // Create options for all installed audio models
                const audioOptions = audioModels.map(model => {
                    let displayName = model.name;
                    let statusInfo = '';
                    
                    // Add status indicator
                    if (model.status === 'loaded') {
                        statusInfo = ' ✓';
                    } else if (model.status === 'loading') {
                        statusInfo = ' ⏳';
                    } else {
                        statusInfo = ' (will auto-load)';
                    }
                    
                    // Add helpful size/type info for known models
                    let sizeInfo = '';
                    if (model.name.includes('whisper-tiny') || model.name.includes('tiny')) {
                        sizeInfo = ' ~39MB';
                    } else if (model.name.includes('whisper-base') || model.name.includes('base')) {
                        sizeInfo = ' ~74MB';
                    } else if (model.name.includes('whisper-small') || model.name.includes('small')) {
                        sizeInfo = ' ~244MB';
                    } else if (model.name.includes('whisper-medium') || model.name.includes('medium')) {
                        sizeInfo = ' ~769MB';
                    } else if (model.name.includes('whisper-large') || model.name.includes('large')) {
                        sizeInfo = ' ~1.5GB';
                    } else if (model.name.includes('parakeet')) {
                        sizeInfo = ' Parakeet';
                    }
                    
                    return `<option value="${model.name}">${displayName}${statusInfo}${sizeInfo}</option>`;
                }).join('');
                
                select.innerHTML = audioOptions;
                
                // Auto-select first available model
                if (audioModels.length > 0) {
                    select.value = audioModels[0].name;
                }
                
            } catch (error) {
                console.error('Failed to load transcription models:', error);
                const select = document.getElementById('whisper-model');
                select.innerHTML = '<option value="">Failed to load models</option>';
            }
        }

        function toggleAdvancedOptions() {
            const options = document.getElementById('advanced-options');
            const chevron = document.getElementById('advanced-chevron');
            
            if (options.classList.contains('hidden')) {
                options.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            } else {
                options.classList.add('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
        }

        async function testApiCall() {
            const modelName = document.getElementById('test-model-select').value;
            const message = document.getElementById('test-message').value;
            const maxTokens = parseInt(document.getElementById('test-max-tokens').value);
            const temperature = parseFloat(document.getElementById('test-temperature').value);
            const systemMessage = document.getElementById('test-system-message').value;

            if (!modelName) {
                showToast('Please select a model', 'error');
                return;
            }

            if (!message.trim()) {
                showToast('Please enter a message', 'error');
                return;
            }

            const button = document.getElementById('test-api-button');
            const originalText = button.innerHTML;
            
            try {
                // Update button state
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
                button.disabled = true;

                // Clear previous response
                const responseDiv = document.getElementById('test-response');
                responseDiv.innerHTML = `
                    <div class="text-blue-400 text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Generating response...</p>
                    </div>
                `;

                // Prepare request payload using OpenAI-compatible chat completions format
                const messages = [];
                if (systemMessage.trim()) {
                    messages.push({
                        role: 'system',
                        content: systemMessage.trim()
                    });
                }
                messages.push({
                    role: 'user',
                    content: message.trim()
                });

                const payload = {
                    model: modelName,
                    messages: messages,
                    max_tokens: maxTokens,
                    temperature: temperature,
                    stream: false
                };

                // Record start time
                const startTime = Date.now();

                // Make API call using OpenAI-compatible endpoint
                const response = await apiCall('/v1/chat/completions', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                // Calculate response time
                const responseTime = Date.now() - startTime;

                // Display response
                displayTestResponse(response, responseTime, modelName);

                // Add to history
                addToTestHistory(modelName, message, response, responseTime);

                showToast('API test completed successfully');

            } catch (error) {
                // Display error
                const responseDiv = document.getElementById('test-response');
                responseDiv.innerHTML = `
                    <div class="text-red-400 p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            <strong>Error</strong>
                        </div>
                        <div class="text-sm text-gray-300">${error.message}</div>
                    </div>
                `;
                showToast('API test failed', 'error');
            } finally {
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function displayTestResponse(response, responseTime, modelName) {
            const responseDiv = document.getElementById('test-response');
            const statsDiv = document.getElementById('test-stats');

            // Display the response text
            const content = response.choices?.[0]?.message?.content || response.response || 'No response content';
            
            responseDiv.innerHTML = `
                <div class="text-white whitespace-pre-wrap">${escapeHtml(content)}</div>
            `;

            // Update stats
            document.getElementById('response-time').textContent = responseTime;
            document.getElementById('tokens-generated').textContent = response.usage?.completion_tokens || '-';
            document.getElementById('response-model').textContent = modelName;
            statsDiv.classList.remove('hidden');
        }

        function addToTestHistory(modelName, message, response, responseTime) {
            const historyItem = {
                timestamp: new Date(),
                modelName,
                message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                response: (response.choices?.[0]?.message?.content || response.response || '').substring(0, 100) + '...',
                responseTime,
                tokens: response.usage?.completion_tokens || 0
            };

            testHistory.unshift(historyItem);
            if (testHistory.length > 10) {
                testHistory = testHistory.slice(0, 10); // Keep only last 10
            }

            renderTestHistory();
        }

        function renderTestHistory() {
            const historyDiv = document.getElementById('test-history');
            
            if (testHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div class="text-gray-500 text-center py-4">
                        <p class="text-sm">No tests run yet</p>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = testHistory.map(item => `
                <div class="bg-gray-700 rounded p-3 text-sm">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-blue-400 font-medium">${item.modelName}</span>
                        <span class="text-gray-400 text-xs">${item.timestamp.toLocaleTimeString()}</span>
                    </div>
                    <div class="text-gray-300 mb-1">Q: ${escapeHtml(item.message)}</div>
                    <div class="text-gray-400 text-xs mb-1">A: ${escapeHtml(item.response)}</div>
                    <div class="text-gray-500 text-xs">
                        ${item.responseTime}ms • ${item.tokens} tokens
                    </div>
                </div>
            `).join('');
        }

        function clearTestResults() {
            const responseDiv = document.getElementById('test-response');
            const statsDiv = document.getElementById('test-stats');
            
            responseDiv.innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-comment-dots text-3xl mb-2"></i>
                    <p>Response will appear here</p>
                </div>
            `;
            statsDiv.classList.add('hidden');
        }

        function clearTestHistory() {
            testHistory = [];
            renderTestHistory();
            showToast('Test history cleared');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search on Enter
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchModels();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            refreshModels();

            // Auto-refresh dashboard every 30 seconds
            setInterval(updateDashboard, 30000);
        });
    </script>
</body>
</html>
